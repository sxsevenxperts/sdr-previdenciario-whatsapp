<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SDR Previdenci√°rio ‚Äî Painel</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; color: #1a1a2e; }

    /* LOGIN */
    #login-page { display: flex; align-items: center; justify-content: center; min-height: 100vh; }
    .login-box { background: #fff; padding: 48px 40px; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); width: 100%; max-width: 420px; }
    .login-box h1 { font-size: 24px; font-weight: 700; margin-bottom: 8px; color: #1a1a2e; }
    .login-box p { color: #666; margin-bottom: 32px; font-size: 14px; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: #444; }
    .form-group input { width: 100%; padding: 12px 14px; border: 1.5px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border 0.2s; }
    .form-group input:focus { outline: none; border-color: #4f46e5; }
    .btn-primary { width: 100%; padding: 13px; background: #4f46e5; color: #fff; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
    .btn-primary:hover { background: #4338ca; }
    .btn-primary:disabled { background: #a5b4fc; cursor: not-allowed; }
    .error-msg { color: #ef4444; font-size: 13px; margin-top: 12px; text-align: center; }

    /* DASHBOARD */
    #dashboard-page { display: none; min-height: 100vh; }
    .sidebar { position: fixed; top: 0; left: 0; width: 240px; height: 100vh; background: #1a1a2e; padding: 24px 0; display: flex; flex-direction: column; overflow-y: auto; }
    .sidebar .logo { padding: 0 24px 24px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .sidebar .logo h2 { color: #fff; font-size: 16px; font-weight: 700; }
    .sidebar .logo p { color: #a5b4fc; font-size: 12px; margin-top: 2px; }
    .nav-section { padding: 12px 24px 4px; font-size: 10px; font-weight: 700; color: rgba(255,255,255,0.3); text-transform: uppercase; letter-spacing: 1px; }
    .nav-item { display: flex; align-items: center; gap: 10px; padding: 12px 24px; color: rgba(255,255,255,0.6); cursor: pointer; transition: all 0.2s; font-size: 14px; border-left: 3px solid transparent; }
    .nav-item:hover { color: #fff; background: rgba(255,255,255,0.05); }
    .nav-item.active { color: #a5b4fc; border-left-color: #a5b4fc; background: rgba(165,180,252,0.1); }
    .nav-item .icon { font-size: 18px; width: 20px; text-align: center; }
    .nav-item .badge-dot { width: 8px; height: 8px; border-radius: 50%; margin-left: auto; }
    .badge-dot.online { background: #22c55e; }
    .badge-dot.offline { background: #ef4444; }
    .sidebar-bottom { margin-top: auto; padding: 16px 24px; border-top: 1px solid rgba(255,255,255,0.1); }
    .btn-logout { width: 100%; padding: 10px; background: rgba(239,68,68,0.15); color: #fca5a5; border: 1px solid rgba(239,68,68,0.3); border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; }
    .btn-logout:hover { background: rgba(239,68,68,0.25); }
    .main-content { margin-left: 240px; padding: 32px; }
    .page { display: none; }
    .page.active { display: block; }
    .page-header { margin-bottom: 28px; }
    .page-header h1 { font-size: 22px; font-weight: 700; }
    .page-header p { color: #666; font-size: 14px; margin-top: 4px; }
    .card { background: #fff; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); margin-bottom: 20px; }
    .card h3 { font-size: 15px; font-weight: 700; margin-bottom: 16px; color: #1a1a2e; display: flex; align-items: center; gap: 8px; }
    .field-group { margin-bottom: 18px; }
    .field-group label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: #444; }
    .field-group input, .field-group textarea, .field-group select { width: 100%; padding: 10px 12px; border: 1.5px solid #e0e0e0; border-radius: 8px; font-size: 14px; font-family: inherit; transition: border 0.2s; resize: vertical; }
    .field-group input:focus, .field-group textarea:focus { outline: none; border-color: #4f46e5; }
    .field-group textarea { min-height: 100px; line-height: 1.6; }
    .btn-save { padding: 11px 28px; background: #4f46e5; color: #fff; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; }
    .btn-save:hover { background: #4338ca; }
    .btn-save:disabled { background: #a5b4fc; }
    .btn-secondary { padding: 11px 20px; background: #fff; color: #4f46e5; border: 1.5px solid #4f46e5; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .btn-secondary:hover { background: #eef2ff; }
    .save-status { display: inline-block; margin-left: 12px; font-size: 13px; color: #16a34a; }
    .badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; }
    .badge-green { background: #dcfce7; color: #16a34a; }
    .badge-red { background: #fee2e2; color: #dc2626; }
    .badge-yellow { background: #fef9c3; color: #ca8a04; }
    .badge-blue { background: #dbeafe; color: #2563eb; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    table th { text-align: left; padding: 10px 12px; background: #f8fafc; font-weight: 600; color: #555; border-bottom: 1px solid #e5e7eb; }
    table td { padding: 12px 12px; border-bottom: 1px solid #f1f5f9; vertical-align: top; }
    table tr:hover td { background: #f8fafc; }
    .empty-state { text-align: center; padding: 48px; color: #aaa; }
    .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px; }
    .stat-card { background: #fff; border-radius: 12px; padding: 20px 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    .stat-card .label { font-size: 12px; font-weight: 600; color: #888; text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-card .value { font-size: 28px; font-weight: 700; margin-top: 4px; color: #1a1a2e; }
    .stat-card .sub { font-size: 12px; color: #666; margin-top: 2px; }
    .loading { color: #888; font-size: 13px; }
    .pdf-list { margin-top: 12px; }
    .pdf-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 14px; background: #f8fafc; border-radius: 8px; margin-bottom: 8px; font-size: 13px; }
    .pdf-item span { color: #444; }
    .pdf-badge { background: #e0e7ff; color: #4f46e5; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
    .upload-btn { padding: 10px 20px; background: #4f46e5; color: #fff; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; margin-top: 12px; }
    .upload-btn:disabled { background: #a5b4fc; }
    .progress-bar { height: 4px; background: #e5e7eb; border-radius: 4px; margin-top: 12px; overflow: hidden; display: none; }
    .progress-fill { height: 100%; background: #4f46e5; border-radius: 4px; transition: width 0.3s; }
    .upload-area { border: 2px dashed #d1d5db; border-radius: 10px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.2s; }
    .upload-area:hover { border-color: #4f46e5; background: #f5f3ff; }
    .upload-area input[type=file] { display: none; }
    .upload-area p { color: #666; font-size: 14px; margin-top: 8px; }

    /* WHATSAPP PAGE */
    .wa-status-bar { display: flex; align-items: center; gap: 12px; padding: 16px 20px; border-radius: 10px; margin-bottom: 20px; font-weight: 600; font-size: 15px; }
    .wa-status-bar.connected { background: #dcfce7; color: #16a34a; border: 1.5px solid #bbf7d0; }
    .wa-status-bar.disconnected { background: #fee2e2; color: #dc2626; border: 1.5px solid #fecaca; }
    .wa-status-bar.connecting { background: #fef9c3; color: #ca8a04; border: 1.5px solid #fef08a; }
    .wa-status-dot { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }
    .wa-status-bar.connected .wa-status-dot { background: #16a34a; box-shadow: 0 0 0 3px rgba(22,163,74,0.2); }
    .wa-status-bar.disconnected .wa-status-dot { background: #dc2626; box-shadow: 0 0 0 3px rgba(220,38,38,0.2); }
    .wa-status-bar.connecting .wa-status-dot { background: #ca8a04; animation: pulse 1s infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
    .qr-container { display: flex; flex-direction: column; align-items: center; padding: 32px; }
    .qr-container img { width: 240px; height: 240px; border: 8px solid #fff; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.12); }
    .qr-placeholder { width: 240px; height: 240px; background: #f8fafc; border: 2px dashed #d1d5db; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; color: #aaa; }
    .qr-placeholder .qr-icon { font-size: 48px; }
    .qr-steps { display: flex; flex-direction: column; gap: 12px; margin-top: 20px; }
    .qr-step { display: flex; align-items: flex-start; gap: 12px; font-size: 14px; color: #444; }
    .qr-step-num { width: 24px; height: 24px; background: #4f46e5; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; flex-shrink: 0; margin-top: 1px; }
    .btn-secondary { padding: 10px 22px; background: #f0f2f5; color: #444; border: 1.5px solid #e0e0e0; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .btn-secondary:hover { background: #e5e7eb; }
    .btn-wa-connect { padding: 12px 28px; background: #25d366; color: #fff; border: none; border-radius: 8px; font-size: 15px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 8px; margin-top: 16px; }
    .btn-wa-connect:hover { background: #1ebe5b; }
    .btn-wa-connect:disabled { background: #a5b4fc; cursor: not-allowed; }
    .btn-wa-disconnect { padding: 10px 22px; background: rgba(239,68,68,0.1); color: #dc2626; border: 1.5px solid rgba(239,68,68,0.3); border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; }
    .btn-wa-disconnect:hover { background: rgba(239,68,68,0.2); }
    .qr-timer { font-size: 13px; color: #888; margin-top: 8px; }
    .qr-timer span { color: #ef4444; font-weight: 700; }

    /* BATE-PAPO */
    .chat-layout { display: grid; grid-template-columns: 300px 1fr; gap: 0; height: calc(100vh - 160px); min-height: 500px; background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); overflow: hidden; }
    .chat-sidebar { border-right: 1px solid #f1f5f9; display: flex; flex-direction: column; overflow: hidden; }
    .chat-sidebar-header { padding: 16px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; justify-content: space-between; }
    .chat-sidebar-header h3 { font-size: 14px; font-weight: 700; color: #1a1a2e; }
    .chat-search { padding: 10px 14px; border: 1.5px solid #e5e7eb; border-radius: 8px; font-size: 13px; width: 100%; margin: 10px 14px; width: calc(100% - 28px); }
    .chat-search:focus { outline: none; border-color: #4f46e5; }
    .conv-list { flex: 1; overflow-y: auto; }
    .conv-item { padding: 14px 16px; border-bottom: 1px solid #f8fafc; cursor: pointer; transition: background 0.15s; }
    .conv-item:hover { background: #f8fafc; }
    .conv-item.active { background: #eef2ff; border-left: 3px solid #4f46e5; }
    .conv-name { font-size: 13px; font-weight: 700; color: #1a1a2e; display: flex; justify-content: space-between; align-items: center; }
    .conv-time { font-size: 11px; color: #aaa; font-weight: 400; }
    .conv-preview { font-size: 12px; color: #888; margin-top: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .conv-unread { background: #4f46e5; color: #fff; border-radius: 10px; font-size: 10px; font-weight: 700; padding: 1px 6px; min-width: 18px; text-align: center; }
    .chat-main { display: flex; flex-direction: column; overflow: hidden; }
    .chat-header { padding: 14px 20px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; gap: 12px; }
    .chat-header-avatar { width: 38px; height: 38px; background: #4f46e5; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 15px; font-weight: 700; flex-shrink: 0; }
    .chat-header-info h4 { font-size: 14px; font-weight: 700; }
    .chat-header-info p { font-size: 12px; color: #888; }
    .chat-header-actions { margin-left: auto; display: flex; gap: 8px; }
    .messages-area { flex: 1; overflow-y: auto; padding: 20px; background: #f8fafc; display: flex; flex-direction: column; gap: 10px; }
    .msg-row { display: flex; align-items: flex-end; gap: 8px; }
    .msg-row.user { flex-direction: row-reverse; }
    .msg-bubble { max-width: 68%; padding: 10px 14px; border-radius: 16px; font-size: 13px; line-height: 1.55; word-break: break-word; }
    .msg-row.assistant .msg-bubble { background: #fff; color: #1a1a2e; border-bottom-left-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.07); }
    .msg-row.user .msg-bubble { background: #4f46e5; color: #fff; border-bottom-right-radius: 4px; }
    .msg-time { font-size: 10px; color: #bbb; margin-bottom: 2px; flex-shrink: 0; }
    .msg-row.user .msg-time { text-align: right; }
    .chat-input-area { padding: 16px; border-top: 1px solid #f1f5f9; display: flex; gap: 10px; align-items: flex-end; background: #fff; }
    .chat-input { flex: 1; padding: 12px 14px; border: 1.5px solid #e0e0e0; border-radius: 20px; font-size: 14px; font-family: inherit; resize: none; max-height: 100px; line-height: 1.5; }
    .chat-input:focus { outline: none; border-color: #4f46e5; }
    .btn-send { width: 42px; height: 42px; background: #4f46e5; color: #fff; border: none; border-radius: 50%; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: background 0.2s; }
    .btn-send:hover { background: #4338ca; }
    .btn-send:disabled { background: #a5b4fc; }
    .chat-empty { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #aaa; gap: 8px; }
    .chat-empty .icon { font-size: 48px; }
    .auto-refresh-badge { display: inline-flex; align-items: center; gap: 5px; background: #dcfce7; color: #16a34a; padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; }
    .auto-refresh-dot { width: 6px; height: 6px; background: #16a34a; border-radius: 50%; animation: pulse 1.5s infinite; }
    .tabs { display: flex; gap: 4px; margin-bottom: 24px; background: #f0f2f5; padding: 4px; border-radius: 10px; width: fit-content; }
    .tab-btn { padding: 8px 18px; border: none; background: transparent; border-radius: 7px; cursor: pointer; font-size: 13px; font-weight: 600; color: #666; transition: all 0.2s; }
    .tab-btn.active { background: #fff; color: #4f46e5; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* MODAL */
    .modal-backdrop { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:1000; align-items:center; justify-content:center; }
    .modal-backdrop.open { display:flex; }
    .modal-box { background:#fff; padding:32px; border-radius:16px; width:460px; max-width:92vw; box-shadow:0 16px 48px rgba(0,0,0,0.2); }
    .modal-box h2 { font-size:18px; font-weight:700; margin-bottom:24px; color:#1a1a2e; }
    .modal-actions { display:flex; gap:10px; margin-top:20px; }

    /* ADMIN */
    .badge-purple { background:#ede9fe; color:#7c3aed; }
    .admin-only { display:none !important; }
    .admin-only.visible { display:flex !important; }
    .nav-section.admin-only.visible { display:block !important; }
    .client-tag { font-size:10px; background:#f0fdf4; color:#16a34a; padding:2px 7px; border-radius:10px; font-weight:700; }
    .client-tag.inactive { background:#fee2e2; color:#dc2626; }
  </style>
</head>
<body>

<!-- LOGIN -->
<div id="login-page">
  <div class="login-box">
    <h1>‚öñÔ∏è SDR Previdenci√°rio</h1>
    <p>Painel de administra√ß√£o do agente IA</p>
    <div class="form-group">
      <label>E-mail</label>
      <input type="email" id="login-email" placeholder="seu@email.com" />
    </div>
    <div class="form-group">
      <label>Senha</label>
      <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
    </div>
    <button class="btn-primary" id="btn-login" onclick="login()">Entrar</button>
    <div class="error-msg" id="login-error"></div>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard-page">
  <div class="sidebar">
    <div class="logo">
      <h2>‚öñÔ∏è SDR Previdenci√°rio</h2>
      <p>Painel de Administra√ß√£o</p>
    </div>
    <div style="padding: 8px 0; flex: 1;">
      <div class="nav-section">Principal</div>
      <div class="nav-item active" onclick="showPage('overview', this)">
        <span class="icon">üìä</span> Vis√£o Geral
      </div>
      <div class="nav-section">WhatsApp</div>
      <div class="nav-item" onclick="showPage('whatsapp', this)" id="nav-whatsapp">
        <span class="icon">üì±</span> Conex√£o QR Code
        <span class="badge-dot offline" id="nav-wa-dot"></span>
      </div>
      <div class="nav-item" onclick="showPage('batepapo', this)">
        <span class="icon">üí¨</span> Bate-Papo ao Vivo
      </div>
      <div class="nav-section">Configura√ß√£o</div>
      <div class="nav-item" onclick="showPage('agente', this)">
        <span class="icon">ü§ñ</span> Agente & Prompt
      </div>
      <div class="nav-item" onclick="showPage('comunicacao', this)">
        <span class="icon">üó£Ô∏è</span> Comunica√ß√£o
      </div>
      <div class="nav-item" onclick="showPage('qualificacao', this)">
        <span class="icon">‚úÖ</span> Qualifica√ß√£o
      </div>
      <div class="nav-item" onclick="showPage('pdfs', this)">
        <span class="icon">üìÑ</span> Base de PDFs
      </div>
      <div class="nav-section">Resultados</div>
      <div class="nav-item" onclick="showPage('leads', this)">
        <span class="icon">üë•</span> Leads
      </div>
      <div class="nav-section admin-only" id="admin-nav-section">Super Admin</div>
      <div class="nav-item admin-only" id="admin-nav-clientes" onclick="showPage('clientes', this)">
        <span class="icon">üè¢</span> Clientes
      </div>
    </div>
    <div class="sidebar-bottom">
      <div style="margin-bottom:12px;font-size:12px;color:rgba(255,255,255,0.5);">
        <div id="sidebar-user-name" style="color:#fff;font-weight:600;font-size:13px;margin-bottom:2px;">‚Äî</div>
        <div id="sidebar-user-role" style="font-size:11px;"></div>
      </div>
      <button class="btn-logout" onclick="logout()">Sair</button>
    </div>
  </div>

  <div class="main-content">

    <!-- OVERVIEW -->
    <div class="page active" id="page-overview">
      <div class="page-header">
        <h1>Vis√£o Geral</h1>
        <p>Resumo do desempenho do agente SDR</p>
      </div>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="label">Total de Leads</div>
          <div class="value" id="stat-total">‚Äî</div>
          <div class="sub">atendimentos realizados</div>
        </div>
        <div class="stat-card">
          <div class="label">Qualificados</div>
          <div class="value" id="stat-qual" style="color:#16a34a">‚Äî</div>
          <div class="sub">encaminhados ao advogado</div>
        </div>
        <div class="stat-card">
          <div class="label">Taxa de Qualifica√ß√£o</div>
          <div class="value" id="stat-taxa">‚Äî</div>
          <div class="sub">dos atendimentos</div>
        </div>
      </div>
      <div class="card">
        <h3>üìã √öltimos Leads</h3>
        <div id="overview-leads"><p class="loading">Carregando...</p></div>
      </div>
    </div>

    <!-- WHATSAPP -->
    <div class="page" id="page-whatsapp">
      <div class="page-header">
        <h1>üì± Conex√£o WhatsApp via QR Code</h1>
        <p>Conecte seu WhatsApp escaneando o QR Code</p>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
        <div class="card">
          <h3>üì∂ Status da Conex√£o</h3>
          <div id="wa-status-bar" class="wa-status-bar disconnected">
            <span class="wa-status-dot"></span>
            <span id="wa-status-text">Verificando...</span>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:4px;">
            <button class="btn-save" onclick="checkWAStatus()" style="padding:10px 20px;">üîÑ Verificar Status</button>
            <button class="btn-wa-disconnect" id="btn-desconectar" onclick="disconnectWA()" style="display:none;">‚èπ Desconectar</button>
          </div>
          <div style="margin-top:20px;padding:16px;background:#f8fafc;border-radius:10px;font-size:13px;color:#555;">
            <div style="font-weight:700;margin-bottom:8px;color:#1a1a2e;">üìã Informa√ß√µes da Inst√¢ncia</div>
            <div style="display:flex;flex-direction:column;gap:6px;">
              <div><strong>Inst√¢ncia:</strong> <code id="wa-instance-display" style="background:#e0e7ff;color:#4f46e5;padding:2px 6px;border-radius:4px;">‚Äî</code></div>
              <div><strong>Servidor:</strong> <code style="background:#e0e7ff;color:#4f46e5;padding:2px 6px;border-radius:4px;font-size:11px;">evolutionapi-evolution-api.yuhqmc.easypanel.host</code></div>
            </div>
          </div>
        </div>
        <div class="card">
          <h3>üì∑ QR Code de Conex√£o</h3>
          <div class="qr-container">
            <div class="qr-placeholder" id="qr-placeholder">
              <span class="qr-icon">üì≤</span>
              <span style="font-size:13px;font-weight:600;">Clique em "Gerar QR Code"</span>
              <span style="font-size:12px;">para conectar o WhatsApp</span>
            </div>
            <img id="qr-image" style="display:none;width:240px;height:240px;border-radius:12px;border:8px solid #fff;box-shadow:0 4px 20px rgba(0,0,0,0.12);" src="" alt="QR Code" />
            <div class="qr-timer" id="qr-timer" style="display:none;">QR expira em <span id="qr-countdown">60</span>s</div>
            <button class="btn-wa-connect" id="btn-gerar-qr" onclick="generateQR()">
              <span>üì∑</span> Gerar QR Code
            </button>
          </div>
        </div>
      </div>
      <div class="card">
        <h3>üìñ Como Conectar</h3>
        <div class="qr-steps">
          <div class="qr-step"><div class="qr-step-num">1</div><div>Clique em <strong>"Gerar QR Code"</strong> acima para criar um novo c√≥digo</div></div>
          <div class="qr-step"><div class="qr-step-num">2</div><div>No seu celular, abra o <strong>WhatsApp</strong> e v√° em <strong>Configura√ß√µes ‚Üí Dispositivos conectados</strong></div></div>
          <div class="qr-step"><div class="qr-step-num">3</div><div>Toque em <strong>"Conectar um dispositivo"</strong> e aponte a c√¢mera para o QR Code</div></div>
          <div class="qr-step"><div class="qr-step-num">4</div><div>Aguarde a confirma√ß√£o ‚Äî o status acima ficar√° <strong style="color:#16a34a;">üü¢ Conectado</strong></div></div>
          <div class="qr-step"><div class="qr-step-num">5</div><div>O agente SDR come√ßar√° a responder mensagens automaticamente pelo n√∫mero conectado</div></div>
        </div>
      </div>
    </div>

    <!-- BATE-PAPO AO VIVO -->
    <div class="page" id="page-batepapo">
      <div class="page-header" style="display:flex;align-items:center;justify-content:space-between;">
        <div>
          <h1>üí¨ Bate-Papo ao Vivo</h1>
          <p>Acompanhe as conversas em tempo real</p>
        </div>
        <div style="display:flex;align-items:center;gap:10px;">
          <span class="auto-refresh-badge"><span class="auto-refresh-dot"></span> Ao vivo</span>
          <button class="btn-secondary" onclick="loadConversations()" style="padding:8px 14px;font-size:13px;">üîÑ Atualizar</button>
        </div>
      </div>
      <div class="chat-layout">
        <!-- Lista de conversas -->
        <div class="chat-sidebar">
          <div class="chat-sidebar-header">
            <h3>Conversas Ativas</h3>
            <span id="conv-count" style="font-size:12px;color:#888;">0</span>
          </div>
          <input class="chat-search" type="text" placeholder="üîç Buscar n√∫mero..." id="chat-search" oninput="filterConversations(this.value)" />
          <div class="conv-list" id="conv-list">
            <div class="empty-state" style="padding:32px 16px;">
              <div style="font-size:32px;margin-bottom:8px;">üì≠</div>
              <div style="font-size:13px;">Nenhuma conversa ativa</div>
            </div>
          </div>
        </div>
        <!-- √Årea do chat -->
        <div class="chat-main" id="chat-main">
          <div class="chat-empty" id="chat-placeholder">
            <div class="icon">üí¨</div>
            <strong>Selecione uma conversa</strong>
            <span style="font-size:13px;">Clique em uma conversa √† esquerda para ver as mensagens</span>
          </div>
          <div id="chat-active" style="display:none;flex-direction:column;height:100%;overflow:hidden;">
            <div class="chat-header">
              <div class="chat-header-avatar" id="chat-avatar">?</div>
              <div class="chat-header-info">
                <h4 id="chat-number">‚Äî</h4>
                <p id="chat-last-seen">‚Äî</p>
              </div>
              <div class="chat-header-actions">
                <span id="chat-status-badge" class="badge badge-yellow" style="font-size:12px;"></span>
                <button class="btn-secondary" style="padding:7px 14px;font-size:12px;" onclick="clearSession()">üóë Reiniciar conversa</button>
              </div>
            </div>
            <div class="messages-area" id="messages-area"></div>
            <div class="chat-input-area">
              <textarea class="chat-input" id="chat-input" placeholder="Digite uma mensagem para enviar como agente..." rows="1"
                onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendManualMessage();}"
                oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"></textarea>
              <button class="btn-send" id="btn-send" onclick="sendManualMessage()" title="Enviar">‚û§</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- AGENTE -->
    <div class="page" id="page-agente">
      <div class="page-header"><h1>ü§ñ Agente & Prompt</h1><p>Configure as instru√ß√µes e personalidade do agente</p></div>
      <div class="card">
        <h3>üéØ Objetivo</h3>
        <div class="field-group"><label>Qual √© o objetivo do agente?</label>
          <textarea id="cfg-objetivo" placeholder="Ex: Qualificar leads de Direito Previdenci√°rio e encaminhar ao advogado."></textarea></div>
      </div>
      <div class="card">
        <h3>üìù Prompt Principal</h3>
        <div class="field-group"><label>Instru√ß√µes detalhadas do agente</label>
          <textarea id="cfg-prompt_sistema" style="min-height:200px" placeholder="Voc√™ √© um assistente de triagem jur√≠dica especializado em Direito Previdenci√°rio..."></textarea></div>
      </div>
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
        <button class="btn-save" onclick="saveConfigs(['objetivo','prompt_sistema'])">üíæ Salvar</button>
        <button class="btn-secondary" onclick="restaurarPadrao()">üîÑ Restaurar Padr√£o</button>
        <span class="save-status" id="save-agente"></span>
      </div>
    </div>

    <!-- COMUNICA√á√ÉO -->
    <div class="page" id="page-comunicacao">
      <div class="page-header"><h1>üó£Ô∏è Comunica√ß√£o</h1><p>Defina como o agente deve se comunicar</p></div>
      <div class="card">
        <h3>üé≠ Tonalidade de Voz</h3>
        <div class="field-group"><label>Como o agente deve falar?</label>
          <textarea id="cfg-tonalidade" placeholder="Ex: Emp√°tico, claro e objetivo. Use linguagem simples, sem jarg√£o jur√≠dico."></textarea></div>
      </div>
      <div class="card">
        <h3>üìè Regras de Comunica√ß√£o</h3>
        <div class="field-group"><label>Instru√ß√µes espec√≠ficas de como conduzir a conversa</label>
          <textarea id="cfg-instrucoes_comunicacao" placeholder="Ex: Fa√ßa uma pergunta por vez. Nunca prometa resultado. M√°ximo 10 trocas."></textarea></div>
      </div>
      <div class="card">
        <h3>üì± Mensagens de Encerramento</h3>
        <div class="field-group"><label>Mensagem quando lead √© QUALIFICADO</label>
          <textarea id="cfg-msg_qualificado" placeholder="Ex: √ìtimo! Vou encaminhar seu caso ao advogado. Em breve ele entrar√° em contato."></textarea></div>
        <div class="field-group"><label>Mensagem quando lead N√ÉO √© qualificado</label>
          <textarea id="cfg-msg_desqualificado" placeholder="Ex: Obrigado pelo contato! No momento n√£o identificamos um caso que atendemos."></textarea></div>
      </div>
      <button class="btn-save" onclick="saveConfigs(['tonalidade','instrucoes_comunicacao','msg_qualificado','msg_desqualificado'])">üíæ Salvar</button>
      <span class="save-status" id="save-comunicacao"></span>
    </div>

    <!-- QUALIFICA√á√ÉO -->
    <div class="page" id="page-qualificacao">
      <div class="page-header"><h1>‚úÖ Qualifica√ß√£o</h1><p>Defina os crit√©rios e o n√∫mero de destino dos leads</p></div>
      <div class="card">
        <h3>üìã Crit√©rios de Qualifica√ß√£o</h3>
        <div class="field-group"><label>Liste os crit√©rios (um por linha)</label>
          <textarea id="cfg-criterios_qualificacao" placeholder="1. Possui v√≠nculo com o INSS&#10;2. Tem benef√≠cio negado ou a requerer&#10;3. √â poss√≠vel identificar uma tese jur√≠dica"></textarea></div>
      </div>
      <div class="card">
        <h3>üì≤ WhatsApp de Destino</h3>
        <div class="field-group"><label>N√∫mero que recebe os relat√≥rios dos leads qualificados</label>
          <input type="text" id="cfg-numero_destino" placeholder="5511999999999 (DDI+DDD+n√∫mero, sem espa√ßos)" /></div>
      </div>
      <button class="btn-save" onclick="saveConfigs(['criterios_qualificacao','numero_destino'])">üíæ Salvar</button>
      <span class="save-status" id="save-qualificacao"></span>
    </div>

    <!-- PDFs -->
    <div class="page" id="page-pdfs">
      <div class="page-header"><h1>üìÑ Base de Conhecimento (PDFs)</h1><p>Documentos que o agente consulta durante as conversas</p></div>
      <div class="card">
        <h3>‚¨ÜÔ∏è Enviar novo PDF</h3>
        <div class="field-group"><label>Nome do documento</label>
          <input type="text" id="pdf-nome" placeholder="Ex: Tabela de Benef√≠cios INSS 2024" /></div>
        <div class="field-group"><label>Categoria</label>
          <select id="pdf-categoria">
            <option>Legisla√ß√£o</option><option>Jurisprud√™ncia</option>
            <option>Tabelas e Valores</option><option>Procedimentos INSS</option><option>Outros</option>
          </select></div>
        <div class="field-group"><label>Arquivo</label>
          <div class="upload-area" onclick="document.getElementById('pdf-file').click()">
            <div style="font-size:36px">üìÅ</div>
            <p id="pdf-filename">Clique para selecionar um PDF</p>
            <input type="file" id="pdf-file" accept=".pdf" onchange="updateFilename(this)" />
          </div></div>
        <div class="progress-bar" id="upload-progress"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
        <button class="upload-btn" id="btn-upload-pdf" onclick="uploadPDF()">‚¨ÜÔ∏è Enviar para o agente</button>
        <span class="save-status" id="upload-status"></span>
      </div>
      <div class="card">
        <h3>üìö Documentos na base</h3>
        <div id="pdf-list"><p class="loading">Carregando...</p></div>
      </div>
    </div>

    <!-- LEADS -->
    <div class="page" id="page-leads">
      <div class="page-header"><h1>üë• Leads</h1><p>Hist√≥rico de todos os atendimentos</p></div>
      <div class="card" style="overflow-x:auto">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
          <h3 style="margin:0">üìã Todos os atendimentos</h3>
          <button class="btn-save" style="padding:8px 16px;font-size:13px" onclick="loadLeads()">üîÑ Atualizar</button>
        </div>
        <div id="leads-table"><p class="loading">Carregando...</p></div>
      </div>
    </div>

    <!-- CLIENTES (admin only) -->
    <div class="page" id="page-clientes">
      <div class="page-header">
        <h1>üè¢ Clientes</h1>
        <p>Gerencie as contas dos seus clientes</p>
      </div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
          <h3 style="margin:0">üìã Contas cadastradas</h3>
          <button class="btn-save" onclick="openCreateClientModal()">‚ûï Novo Cliente</button>
        </div>
        <div id="clients-table"><p class="loading">Carregando...</p></div>
      </div>
    </div>

  </div>
</div>

<!-- MODAL CRIAR CLIENTE -->
<div class="modal-backdrop" id="modal-backdrop" onclick="if(event.target===this)closeModal()">
  <div class="modal-box">
    <h2>‚ûï Criar Novo Cliente</h2>
    <div class="field-group">
      <label>Nome do cliente</label>
      <input type="text" id="new-client-name" placeholder="Ex: Escrit√≥rio Pereira" />
    </div>
    <div class="field-group">
      <label>E-mail</label>
      <input type="email" id="new-client-email" placeholder="cliente@email.com" />
    </div>
    <div class="field-group">
      <label>Senha inicial</label>
      <input type="password" id="new-client-password" placeholder="M√≠nimo 6 caracteres" />
    </div>
    <div class="field-group">
      <label>Nome da inst√¢ncia WhatsApp <small style="color:#888;">(sem espa√ßos, ex: EscritorioPereira)</small></label>
      <input type="text" id="new-client-instance" placeholder="EscritorioPereira" />
    </div>
    <div class="modal-actions">
      <button class="btn-save" id="btn-create-client" onclick="createClient()">‚úÖ Criar conta</button>
      <button class="btn-secondary" onclick="closeModal()">Cancelar</button>
    </div>
    <div id="create-client-error" class="error-msg" style="margin-top:10px;text-align:left;"></div>
  </div>
</div>

<script>
  // =====================
  // CONFIGURA√á√ÉO
  // =====================
  const SUPABASE_URL = 'https://vyvdrbkcrvklcaombjqu.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ5dmRyYmtjcnZrbGNhb21ianF1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwNTMzNTgsImV4cCI6MjA4NzYyOTM1OH0.vmIYb6BGgsksaNGN2XPCm6I_mj02NSa49bLWXlTLQeY';
  const MANAGE_CLIENTS_URL = `${SUPABASE_URL}/functions/v1/manage-clients`;
  const N8N_UPLOAD_WEBHOOK = 'https://sx-n8n.yuhqmc.easypanel.host/webhook/upload-pdf-sdr';
  const EVO_URL = 'https://evolutionapi-evolution-api.yuhqmc.easypanel.host';
  const EVO_KEY = '32AEB8FC2DE4-4F79-A823-E620A11C224F';
  const EVO_INSTANCE_DEFAULT = 'TESTE'; // fallback se perfil n√£o tiver inst√¢ncia

  const { createClient } = supabase;
  const db = createClient(SUPABASE_URL, SUPABASE_KEY);

  let selectedConv = null;
  let allConversations = [];
  let chatRefreshInterval = null;
  let waStatusInterval = null;
  let qrCountdownInterval = null;
  let currentProfile = null; // { id, role, display_name, evo_instance, active }

  function getEvoInstance() {
    return (currentProfile?.evo_instance) || EVO_INSTANCE_DEFAULT;
  }

  // =====================
  // PROMPT PADR√ÉO
  // =====================
  const PROMPT_PADRAO = {
    objetivo: 'Qualificar leads de Direito Previdenci√°rio e encaminhar ao advogado respons√°vel para avalia√ß√£o do caso.',
    prompt_sistema: [
      'Voc√™ √© um assistente especializado em triagem de casos de Direito Previdenci√°rio.',
      'Seu papel √© conversar de forma humanizada, emp√°tica e objetiva com pessoas que buscam ajuda jur√≠dica previdenci√°ria, qualific√°-las e, quando aplic√°vel, encaminhar o caso para um advogado.',
      '',
      'Voc√™ N√ÉO √© advogado e N√ÉO d√° consultoria jur√≠dica. Voc√™ apenas coleta informa√ß√µes para que o advogado respons√°vel possa avaliar o caso.',
      '',
      'FLUXO DA CONVERSA:',
      '',
      'Etapa 1 ‚Äî Recep√ß√£o:',
      'Cumprimente o lead pelo nome (se dispon√≠vel):',
      '"Ol√°! Sou o assistente jur√≠dico do escrit√≥rio. Vou fazer algumas perguntas r√°pidas para entender melhor a sua situa√ß√£o e verificar se podemos te ajudar. Pode ser?"',
      '',
      'Etapa 2 ‚Äî Coleta de informa√ß√µes (fa√ßa UMA pergunta por vez):',
      '1. "Qual √© o seu nome completo?"',
      '2. "Voc√™ contribuiu para o INSS em algum momento da sua vida, ou √© dependente de algu√©m que contribuiu?"',
      '3. "Qual √© a sua situa√ß√£o atual? Por exemplo: benef√≠cio negado, cancelado, aposentadoria que ainda n√£o pediu, pens√£o por morte, aux√≠lio-doen√ßa, BPC/LOAS, ou outro?"',
      '4. "Voc√™ j√° tentou dar entrada no benef√≠cio? Se sim, o que aconteceu?"',
      '5. "Voc√™ tem documentos como carteira de trabalho, extrato do CNIS, carta de indeferimento do INSS ou outros?"',
      '6. "Qual o seu n√∫mero de celular com DDD para o advogado entrar em contato?"',
      '',
      'DESQUALIFICA√á√ÉO IMEDIATA (encerre com empatia se):',
      '- Caso √© trabalhista puro, sem v√≠nculo com INSS',
      '- Caso j√° est√° em andamento com outro advogado',
      '- Pessoa n√£o quer fornecer informa√ß√µes b√°sicas',
      '- Caso j√° foi julgado com tr√¢nsito em julgado sem possibilidade de revis√£o',
      '',
      'BUSCA NA WEB:',
      'Se necess√°rio para identificar a tese jur√≠dica, use a ferramenta de busca.',
      'Priorize fontes: gov.br, previdencia.gov.br, JusBrasil, STJ, TRF.',
      '',
      'FORMATO DE SA√çDA OBRIGAT√ìRIO:',
      'Ao concluir a triagem, inclua NO FINAL da sua √∫ltima mensagem o JSON abaixo:',
      '',
      'Para lead qualificado:',
      '```json',
      '{"qualificado":true,"nome":"Nome Completo","celular":"DDD+n√∫mero","tese":"Tese jur√≠dica identificada","resumo":"Resumo completo da conversa"}',
      '```',
      '',
      'Para lead n√£o qualificado:',
      '```json',
      '{"qualificado":false,"motivo":"Motivo da desqualifica√ß√£o"}',
      '```'
    ].join('\n'),
    tonalidade: 'Emp√°tico, claro e objetivo. Use linguagem simples, sem jarg√£o jur√≠dico. Seja especialmente gentil com idosos ou pessoas em situa√ß√£o vulner√°vel. Se o lead fizer uma pergunta jur√≠dica espec√≠fica, responda de forma gen√©rica e direcione: "Essa √© uma excelente pergunta para o advogado aprofundar com voc√™!"',
    instrucoes_comunicacao: '- Fa√ßa uma pergunta por vez. Aguarde a resposta antes de continuar.\n- Nunca prometa resultado ou vit√≥ria no processo.\n- Nunca d√™ consultoria jur√≠dica.\n- Limite a conversa ao m√°ximo de 10 trocas de mensagens antes de concluir a triagem.\n- Se o lead demorar mais de 24h para responder, envie um lembrete gentil uma √∫nica vez.\n- Se o lead enviar um arquivo (foto, PDF), confirme o recebimento e registre no caso.',
    criterios_qualificacao: '1. V√≠nculo INSS ‚Äî Contribuiu ao INSS ou √© dependente de quem contribuiu\n2. Benef√≠cio identific√°vel ‚Äî Existe um benef√≠cio previdenci√°rio aplic√°vel ao caso\n3. Indeferimento ou pend√™ncia ‚Äî Benef√≠cio foi negado, cancelado ou ainda n√£o foi requerido\n4. Tese jur√≠dica ‚Äî √â poss√≠vel identificar uma tese/fundamento legal para o caso\n5. Documenta√ß√£o m√≠nima ‚Äî Possui ao menos algum documento ou sabe como obt√™-lo',
    msg_qualificado: '√ìtimo! Com base no que voc√™ me contou, acredito que o nosso advogado pode te ajudar. Vou encaminhar as informa√ß√µes do seu caso para ele agora. Em breve ele entrar√° em contato com voc√™. Alguma d√∫vida ou informa√ß√£o adicional que queira que eu repasse?',
    msg_desqualificado: 'Obrigado por entrar em contato! Infelizmente, com base nas informa√ß√µes que voc√™ compartilhou, n√£o identificamos uma situa√ß√£o que se encaixe nos casos que atendemos no momento. Caso sua situa√ß√£o mude ou surja algum documento novo, fique √† vontade para nos contatar novamente. Desejamos tudo de bom para voc√™!',
    numero_destino: ''
  };

  // =====================
  // AUTH
  // =====================
  async function login() {
    const email = document.getElementById('login-email').value;
    const pass  = document.getElementById('login-password').value;
    const btn   = document.getElementById('btn-login');
    const err   = document.getElementById('login-error');
    btn.disabled = true; btn.textContent = 'Entrando...'; err.textContent = '';
    const { error } = await db.auth.signInWithPassword({ email, password: pass });
    if (error) {
      err.textContent = 'E-mail ou senha incorretos.';
      btn.disabled = false; btn.textContent = 'Entrar';
    } else { showDashboard(); }
  }

  async function logout() {
    clearInterval(chatRefreshInterval);
    clearInterval(waStatusInterval);
    await db.auth.signOut();
    document.getElementById('dashboard-page').style.display = 'none';
    document.getElementById('login-page').style.display = 'flex';
  }

  document.getElementById('login-password').addEventListener('keydown', e => {
    if (e.key === 'Enter') login();
  });

  window.addEventListener('load', async () => {
    const { data: { session } } = await db.auth.getSession();
    if (session) showDashboard();
  });

  async function showDashboard() {
    document.getElementById('login-page').style.display = 'none';
    document.getElementById('dashboard-page').style.display = 'block';

    // Carrega perfil do usu√°rio logado
    const { data: { user } } = await db.auth.getUser();
    if (user) {
      const { data: profile } = await db.from('profiles').select('*').eq('id', user.id).single();
      currentProfile = profile;

      // Se admin: exibe menu de clientes
      if (profile?.role === 'admin') {
        document.querySelectorAll('.admin-only').forEach(el => el.classList.add('visible'));
      }

      // Atualiza nome/inst√¢ncia na sidebar
      const instEl = document.getElementById('wa-instance-display');
      if (instEl) instEl.textContent = getEvoInstance();
      const nameEl = document.getElementById('sidebar-user-name');
      if (nameEl) nameEl.textContent = profile?.display_name || user.email;
      const roleEl = document.getElementById('sidebar-user-role');
      if (roleEl) roleEl.textContent = profile?.role === 'admin' ? 'üîë Super Admin' : 'üë§ Cliente';
    }

    loadConfigs(); loadStats(); loadOverviewLeads(); loadPDFList();
    checkWAStatus();
    waStatusInterval = setInterval(checkWAStatus, 15000);
  }

  // =====================
  // NAVEGA√á√ÉO
  // =====================
  function showPage(name, el) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById('page-' + name).classList.add('active');
    el.classList.add('active');
    if (name === 'leads') loadLeads();
    if (name === 'clientes') loadClients();
    if (name === 'batepapo') {
      loadConversations();
      clearInterval(chatRefreshInterval);
      chatRefreshInterval = setInterval(loadConversations, 5000);
    } else {
      clearInterval(chatRefreshInterval);
    }
  }

  // =====================
  // WHATSAPP ‚Äî QR CODE
  // =====================
  async function checkWAStatus() {
    const bar = document.getElementById('wa-status-bar');
    const txt = document.getElementById('wa-status-text');
    const dot = document.getElementById('nav-wa-dot');
    const btnDesc = document.getElementById('btn-desconectar');
    try {
      const res = await fetch(`${EVO_URL}/instance/connectionState/${getEvoInstance()}`, {
        headers: { 'apikey': EVO_KEY }
      });
      const data = await res.json();
      const state = data?.instance?.state || data?.state || 'close';
      if (state === 'open') {
        bar.className = 'wa-status-bar connected';
        txt.textContent = 'üü¢ WhatsApp Conectado ‚Äî Agente ativo e recebendo mensagens';
        dot.className = 'badge-dot online';
        btnDesc.style.display = 'inline-block';
        document.getElementById('btn-gerar-qr').style.display = 'none';
      } else {
        bar.className = 'wa-status-bar disconnected';
        txt.textContent = 'üî¥ WhatsApp Desconectado ‚Äî Gere o QR Code para conectar';
        dot.className = 'badge-dot offline';
        btnDesc.style.display = 'none';
        document.getElementById('btn-gerar-qr').style.display = 'flex';
      }
    } catch (e) {
      bar.className = 'wa-status-bar connecting';
      txt.textContent = 'üü° N√£o foi poss√≠vel verificar o status';
    }
  }

  async function generateQR() {
    const btn = document.getElementById('btn-gerar-qr');
    const placeholder = document.getElementById('qr-placeholder');
    const img = document.getElementById('qr-image');
    const timer = document.getElementById('qr-timer');
    btn.disabled = true; btn.innerHTML = '<span>‚è≥</span> Gerando...';
    try {
      const res = await fetch(`${EVO_URL}/instance/connect/${getEvoInstance()}`, {
        headers: { 'apikey': EVO_KEY }
      });
      const data = await res.json();
      const base64 = data?.base64 || data?.qrcode?.base64 || data?.code;
      if (base64) {
        placeholder.style.display = 'none';
        img.src = base64.startsWith('data:') ? base64 : `data:image/png;base64,${base64}`;
        img.style.display = 'block';
        timer.style.display = 'block';
        startQRCountdown();
        // Verifica se conectou
        setTimeout(checkWAStatus, 5000);
        const watchInterval = setInterval(async () => {
          await checkWAStatus();
          const state = document.getElementById('wa-status-bar').className;
          if (state.includes('connected')) {
            clearInterval(watchInterval);
            img.style.display = 'none';
            placeholder.style.display = 'flex';
            timer.style.display = 'none';
          }
        }, 3000);
      } else {
        alert('N√£o foi poss√≠vel gerar o QR Code. Verifique se o n8n e a Evolution API est√£o ativos.');
      }
    } catch (e) {
      alert('Erro ao conectar com a Evolution API: ' + e.message);
    }
    btn.disabled = false; btn.innerHTML = '<span>üîÑ</span> Novo QR Code';
  }

  function startQRCountdown() {
    clearInterval(qrCountdownInterval);
    let secs = 60;
    document.getElementById('qr-countdown').textContent = secs;
    qrCountdownInterval = setInterval(() => {
      secs--;
      document.getElementById('qr-countdown').textContent = secs;
      if (secs <= 0) {
        clearInterval(qrCountdownInterval);
        document.getElementById('qr-timer').style.display = 'none';
        document.getElementById('qr-image').style.display = 'none';
        document.getElementById('qr-placeholder').style.display = 'flex';
        document.getElementById('btn-gerar-qr').innerHTML = '<span>üì∑</span> Gerar QR Code';
      }
    }, 1000);
  }

  async function disconnectWA() {
    if (!confirm('Deseja desconectar o WhatsApp? O agente para de responder.')) return;
    try {
      await fetch(`${EVO_URL}/instance/logout/${getEvoInstance()}`, {
        method: 'DELETE', headers: { 'apikey': EVO_KEY }
      });
      setTimeout(checkWAStatus, 1000);
    } catch(e) { alert('Erro ao desconectar: ' + e.message); }
  }

  // =====================
  // BATE-PAPO AO VIVO
  // =====================
  async function loadConversations() {
    const { data } = await db.from('sessoes')
      .select('*').order('atualizado_em', { ascending: false });
    allConversations = data || [];
    document.getElementById('conv-count').textContent = allConversations.length + ' conversa(s)';
    renderConvList(allConversations);
    if (selectedConv) {
      const updated = allConversations.find(c => c.numero_whatsapp === selectedConv);
      if (updated) renderMessages(updated);
    }
  }

  function renderConvList(convs) {
    const el = document.getElementById('conv-list');
    if (!convs.length) {
      el.innerHTML = '<div class="empty-state" style="padding:32px 16px;"><div style="font-size:32px;margin-bottom:8px;">üì≠</div><div style="font-size:13px;">Nenhuma conversa ativa</div></div>';
      return;
    }
    el.innerHTML = convs.map(c => {
      const hist = parseHistory(c.historico);
      const last = hist.length ? hist[hist.length - 1] : null;
      const preview = last ? (last.content || '').slice(0, 50) : 'Sem mensagens';
      const time = c.atualizado_em ? timeAgo(c.atualizado_em) : '';
      const num = c.numero_whatsapp || '‚Äî';
      const initials = num.replace(/\D/g,'').slice(-4).slice(0,2) || '??';
      const isActive = selectedConv === c.numero_whatsapp;
      return `<div class="conv-item ${isActive ? 'active' : ''}" onclick="selectConv('${c.numero_whatsapp}')">
        <div class="conv-name">
          <span>${formatPhone(num)}</span>
          <span class="conv-time">${time}</span>
        </div>
        <div class="conv-preview">${preview}</div>
      </div>`;
    }).join('');
  }

  function filterConversations(query) {
    if (!query) { renderConvList(allConversations); return; }
    const filtered = allConversations.filter(c =>
      (c.numero_whatsapp || '').includes(query)
    );
    renderConvList(filtered);
  }

  function selectConv(numero) {
    selectedConv = numero;
    const conv = allConversations.find(c => c.numero_whatsapp === numero);
    if (!conv) return;
    document.getElementById('chat-placeholder').style.display = 'none';
    const activeEl = document.getElementById('chat-active');
    activeEl.style.display = 'flex';
    const initials = numero.replace(/\D/g,'').slice(-4).slice(0,2) || '??';
    document.getElementById('chat-avatar').textContent = initials;
    document.getElementById('chat-number').textContent = formatPhone(numero);
    document.getElementById('chat-last-seen').textContent = conv.atualizado_em
      ? '√öltima atividade: ' + new Date(conv.atualizado_em).toLocaleString('pt-BR')
      : 'Sess√£o ativa';
    renderMessages(conv);
    renderConvList(allConversations);
  }

  function renderMessages(conv) {
    const hist = parseHistory(conv.historico);
    const el = document.getElementById('messages-area');
    if (!hist.length) {
      el.innerHTML = '<div class="empty-state"><div style="font-size:28px">üí¨</div><p>Nenhuma mensagem ainda</p></div>';
      return;
    }
    el.innerHTML = hist.map(msg => {
      const isUser = msg.role === 'user';
      return `<div class="msg-row ${isUser ? 'user' : 'assistant'}">
        <div class="msg-bubble">${escapeHtml(msg.content || '')}</div>
      </div>`;
    }).join('');
    el.scrollTop = el.scrollHeight;
    const hist_len = hist.length;
    const lastRole = hist.length ? hist[hist.length-1].role : '';
    const statusBadge = document.getElementById('chat-status-badge');
    if (lastRole === 'assistant') {
      statusBadge.className = 'badge badge-blue'; statusBadge.textContent = 'ü§ñ Aguardando lead';
    } else {
      statusBadge.className = 'badge badge-yellow'; statusBadge.textContent = '‚è≥ Processando';
    }
  }

  async function sendManualMessage() {
    if (!selectedConv) return;
    const input = document.getElementById('chat-input');
    const msg = input.value.trim();
    if (!msg) return;
    const btn = document.getElementById('btn-send');
    btn.disabled = true; input.value = ''; input.style.height = 'auto';
    try {
      await fetch(`${EVO_URL}/message/sendText/${getEvoInstance()}`, {
        method: 'POST',
        headers: { 'apikey': EVO_KEY, 'Content-Type': 'application/json' },
        body: JSON.stringify({ number: selectedConv, text: msg })
      });
      // Atualiza hist√≥rico local
      await loadConversations();
    } catch(e) {
      alert('Erro ao enviar mensagem: ' + e.message);
    }
    btn.disabled = false;
  }

  async function clearSession() {
    if (!selectedConv) return;
    if (!confirm(`Reiniciar a conversa com ${formatPhone(selectedConv)}? O hist√≥rico ser√° apagado.`)) return;
    await db.from('sessoes').delete().eq('numero_whatsapp', selectedConv);
    selectedConv = null;
    document.getElementById('chat-placeholder').style.display = 'flex';
    document.getElementById('chat-active').style.display = 'none';
    loadConversations();
  }

  function parseHistory(hist) {
    if (!hist) return [];
    try {
      const parsed = typeof hist === 'string' ? JSON.parse(hist) : hist;
      if (Array.isArray(parsed)) return parsed.filter(m => m.role && m.content);
      return [];
    } catch { return []; }
  }

  function formatPhone(num) {
    const n = (num || '').replace(/\D/g,'');
    if (n.length >= 12) return `+${n.slice(0,2)} (${n.slice(2,4)}) ${n.slice(4,9)}-${n.slice(9)}`;
    return num;
  }

  function timeAgo(ts) {
    const diff = Math.floor((Date.now() - new Date(ts)) / 1000);
    if (diff < 60) return 'agora';
    if (diff < 3600) return Math.floor(diff/60) + 'min';
    if (diff < 86400) return Math.floor(diff/3600) + 'h';
    return Math.floor(diff/86400) + 'd';
  }

  function escapeHtml(str) {
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
  }

  // =====================
  // CONFIGURA√á√ïES
  // =====================
  async function loadConfigs() {
    // Aplica defaults primeiro (garante campos preenchidos na primeira vez)
    Object.entries(PROMPT_PADRAO).forEach(([chave, valor]) => {
      const el = document.getElementById('cfg-' + chave);
      if (el) el.value = valor;
    });
    // Sobrescreve com valores salvos no Supabase
    const { data } = await db.from('agente_config').select('chave, valor');
    if (!data) return;
    data.forEach(row => {
      const el = document.getElementById('cfg-' + row.chave);
      if (el && row.valor) el.value = row.valor;
    });
  }

  function restaurarPadrao() {
    if (!confirm('Restaurar todos os prompts para o padr√£o? Os valores atuais ser√£o substitu√≠dos (somente na tela ‚Äî salve para confirmar).')) return;
    Object.entries(PROMPT_PADRAO).forEach(([chave, valor]) => {
      const el = document.getElementById('cfg-' + chave);
      if (el) el.value = valor;
    });
  }

  async function saveConfigs(keys) {
    const statusId = keys.includes('prompt_sistema') ? 'save-agente'
      : keys.includes('tonalidade') ? 'save-comunicacao' : 'save-qualificacao';
    const statusEl = document.getElementById(statusId);
    statusEl.textContent = 'Salvando...'; statusEl.style.color = '#888';
    const { data: { user } } = await db.auth.getUser();
    for (const key of keys) {
      const el = document.getElementById('cfg-' + key);
      if (!el) continue;
      await db.from('agente_config').upsert(
        { chave: key, valor: el.value, user_id: user.id, atualizado_em: new Date().toISOString() },
        { onConflict: 'user_id,chave' }
      );
    }
    statusEl.textContent = '‚úÖ Salvo!'; statusEl.style.color = '#16a34a';
    setTimeout(() => statusEl.textContent = '', 3000);
  }

  // =====================
  // STATS + LEADS
  // =====================
  async function loadStats() {
    const { data } = await db.from('leads').select('qualificado');
    if (!data) return;
    const total = data.length;
    const qual  = data.filter(l => l.qualificado).length;
    const taxa  = total > 0 ? Math.round((qual/total)*100)+'%' : '0%';
    document.getElementById('stat-total').textContent = total;
    document.getElementById('stat-qual').textContent = qual;
    document.getElementById('stat-taxa').textContent = taxa;
  }

  async function loadOverviewLeads() {
    const { data } = await db.from('leads').select('*').order('criado_em', { ascending: false }).limit(5);
    const el = document.getElementById('overview-leads');
    if (!data || !data.length) {
      el.innerHTML = '<p class="empty-state">Nenhum lead ainda.</p>'; return;
    }
    el.innerHTML = renderLeadsTable(data);
  }

  async function loadLeads() {
    const { data } = await db.from('leads').select('*').order('criado_em', { ascending: false });
    const el = document.getElementById('leads-table');
    if (!data || !data.length) {
      el.innerHTML = '<p class="empty-state">Nenhum lead registrado ainda.</p>'; return;
    }
    el.innerHTML = renderLeadsTable(data);
  }

  function renderLeadsTable(data) {
    return `<table><thead><tr>
      <th>Data</th><th>Nome</th><th>Celular</th><th>Tese</th><th>Status</th>
    </tr></thead><tbody>${data.map(l => `<tr>
      <td>${l.criado_em ? new Date(l.criado_em).toLocaleString('pt-BR') : '‚Äî'}</td>
      <td>${l.nome || l.numero_whatsapp || '‚Äî'}</td>
      <td>${l.celular || '‚Äî'}</td>
      <td style="max-width:280px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${l.tese || l.resumo || '‚Äî'}</td>
      <td><span class="badge ${l.qualificado ? 'badge-green' : 'badge-red'}">${l.qualificado ? '‚úÖ Qualificado' : '‚ùå N√£o qualificado'}</span></td>
    </tr>`).join('')}</tbody></table>`;
  }

  // =====================
  // PDFs
  // =====================
  function updateFilename(input) {
    document.getElementById('pdf-filename').textContent = input.files[0]?.name || 'Clique para selecionar um PDF';
  }

  async function uploadPDF() {
    const nome = document.getElementById('pdf-nome').value.trim();
    const categoria = document.getElementById('pdf-categoria').value;
    const file = document.getElementById('pdf-file').files[0];
    const btn = document.getElementById('btn-upload-pdf');
    const status = document.getElementById('upload-status');
    if (!nome || !file) { alert('Preencha o nome e selecione um PDF.'); return; }
    btn.disabled = true; btn.textContent = 'Enviando...'; status.textContent = '';
    const formData = new FormData();
    formData.append('Nome do documento', nome);
    formData.append('Categoria', categoria);
    formData.append('Arquivo PDF', file);
    try {
      await fetch(N8N_UPLOAD_WEBHOOK, { method: 'POST', body: formData });
      status.textContent = '‚úÖ PDF enviado para processamento!'; status.style.color = '#16a34a';
      loadPDFList();
    } catch {
      status.textContent = '‚ùå Erro ao enviar. Verifique se o Workflow 2 est√° ativo.'; status.style.color = '#ef4444';
    }
    btn.disabled = false; btn.textContent = '‚¨ÜÔ∏è Enviar para o agente';
    setTimeout(() => status.textContent = '', 4000);
  }

  async function loadPDFList() {
    const { data } = await db.from('documentos_conhecimento').select('metadata').limit(30);
    const el = document.getElementById('pdf-list');
    if (!data || !data.length) {
      el.innerHTML = '<p class="empty-state">Nenhum PDF na base ainda.</p>'; return;
    }
    const unique = {};
    data.forEach(d => { const k = (d.metadata?.nome || 'Sem nome'); unique[k] = d.metadata; });
    el.innerHTML = '<div class="pdf-list">' + Object.values(unique).map(meta =>
      `<div class="pdf-item"><span>üìÑ ${meta.nome || 'Documento'}</span><span class="pdf-badge">${meta.categoria || 'Geral'}</span></div>`
    ).join('') + '</div>';
  }

  // =====================
  // ADMIN ‚Äî CLIENTES (via Edge Function segura)
  // =====================
  async function adminFetch(method, body) {
    const { data: { session } } = await db.auth.getSession();
    const res = await fetch(MANAGE_CLIENTS_URL, {
      method,
      headers: {
        'Authorization': `Bearer ${session?.access_token}`,
        'apikey': SUPABASE_KEY,
        'Content-Type': 'application/json'
      },
      body: body ? JSON.stringify(body) : undefined
    });
    return res.json();
  }

  async function loadClients() {
    if (currentProfile?.role !== 'admin') return;
    const el = document.getElementById('clients-table');
    el.innerHTML = '<p class="loading">Carregando...</p>';
    const profiles = await adminFetch('GET');
    if (!Array.isArray(profiles)) {
      el.innerHTML = '<p class="error-msg">Erro ao carregar clientes: ' + (profiles?.error || '') + '</p>'; return;
    }
    if (!profiles.length) {
      el.innerHTML = '<p class="empty-state">Nenhum cliente cadastrado ainda.</p>'; return;
    }
    el.innerHTML = `<table>
      <thead><tr><th>Nome</th><th>Tipo</th><th>Inst√¢ncia WA</th><th>Status</th><th>Criado</th><th>A√ß√µes</th></tr></thead>
      <tbody>${profiles.map(p => `<tr>
        <td style="font-weight:600">${escapeHtml(p.display_name || '‚Äî')}</td>
        <td><span class="badge ${p.role === 'admin' ? 'badge-purple' : 'badge-blue'}">${p.role === 'admin' ? 'üîë Admin' : 'üë§ Cliente'}</span></td>
        <td><code style="background:#f0f2f5;padding:2px 7px;border-radius:4px;font-size:12px;">${escapeHtml(p.evo_instance || '‚Äî')}</code></td>
        <td><span class="badge ${p.active ? 'badge-green' : 'badge-red'}">${p.active ? '‚úÖ Ativo' : '‚ùå Inativo'}</span></td>
        <td style="color:#888;font-size:12px;">${p.created_at ? new Date(p.created_at).toLocaleDateString('pt-BR') : '‚Äî'}</td>
        <td>
          ${p.role !== 'admin' ? `<button onclick="toggleClient('${p.id}', ${p.active})" style="padding:5px 12px;font-size:12px;" class="btn-secondary">${p.active ? 'Desativar' : 'Ativar'}</button>` : '<span style="color:#bbb;font-size:12px;">‚Äî</span>'}
        </td>
      </tr>`).join('')}</tbody>
    </table>`;
  }

  function openCreateClientModal() {
    ['new-client-name','new-client-email','new-client-password','new-client-instance'].forEach(id => {
      document.getElementById(id).value = '';
    });
    document.getElementById('create-client-error').textContent = '';
    document.getElementById('btn-create-client').disabled = false;
    document.getElementById('btn-create-client').textContent = '‚úÖ Criar conta';
    document.getElementById('modal-backdrop').classList.add('open');
  }

  function closeModal() {
    document.getElementById('modal-backdrop').classList.remove('open');
  }

  async function createClient() {
    const name     = document.getElementById('new-client-name').value.trim();
    const email    = document.getElementById('new-client-email').value.trim();
    const password = document.getElementById('new-client-password').value;
    const instance = document.getElementById('new-client-instance').value.trim().replace(/\s+/g, '');
    const errEl    = document.getElementById('create-client-error');
    const btn      = document.getElementById('btn-create-client');
    errEl.textContent = '';
    if (!name || !email || !password || !instance) {
      errEl.textContent = 'Preencha todos os campos.'; return;
    }
    if (password.length < 6) {
      errEl.textContent = 'Senha deve ter no m√≠nimo 6 caracteres.'; return;
    }
    btn.disabled = true; btn.textContent = 'Criando...';
    const result = await adminFetch('POST', { name, email, password, evo_instance: instance });
    if (result?.error) {
      errEl.textContent = 'Erro: ' + result.error;
      btn.disabled = false; btn.textContent = '‚úÖ Criar conta';
      return;
    }
    closeModal();
    loadClients();
  }

  async function toggleClient(userId, currentActive) {
    await adminFetch('PATCH', { user_id: userId, active: !currentActive });
    loadClients();
  }
</script>
</body>
</html>
