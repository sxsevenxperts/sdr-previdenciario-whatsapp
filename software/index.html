<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>XPERT.IA ‚Äî Painel</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; color: #1a1a2e; }

    /* LOGIN */
    #login-page { display: flex; align-items: center; justify-content: center; min-height: 100vh; }
    .login-box { background: #fff; padding: 48px 40px; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); width: 100%; max-width: 420px; }
    .login-box h1 { font-size: 24px; font-weight: 700; margin-bottom: 8px; color: #1a1a2e; }
    .login-box p { color: #666; margin-bottom: 32px; font-size: 14px; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: #444; }
    .form-group input { width: 100%; padding: 12px 14px; border: 1.5px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border 0.2s; }
    .form-group input:focus { outline: none; border-color: #4f46e5; }
    .btn-primary { width: 100%; padding: 13px; background: #4f46e5; color: #fff; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
    .btn-primary:hover { background: #4338ca; }
    .btn-primary:disabled { background: #a5b4fc; cursor: not-allowed; }
    .error-msg { color: #ef4444; font-size: 13px; margin-top: 12px; text-align: center; }

    /* DASHBOARD */
    #dashboard-page { display: none; min-height: 100vh; }
    .sidebar { position: fixed; top: 0; left: 0; width: 240px; height: 100vh; background: #1a1a2e; padding: 24px 0; display: flex; flex-direction: column; overflow-y: auto; }
    .sidebar .logo { padding: 0 24px 24px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .sidebar .logo h2 { color: #fff; font-size: 16px; font-weight: 700; }
    .sidebar .logo p { color: #a5b4fc; font-size: 12px; margin-top: 2px; }
    .nav-section { padding: 12px 24px 4px; font-size: 10px; font-weight: 700; color: rgba(255,255,255,0.3); text-transform: uppercase; letter-spacing: 1px; }
    .nav-item { display: flex; align-items: center; gap: 10px; padding: 12px 24px; color: rgba(255,255,255,0.6); cursor: pointer; transition: all 0.2s; font-size: 14px; border-left: 3px solid transparent; }
    .nav-item:hover { color: #fff; background: rgba(255,255,255,0.05); }
    .nav-item.active { color: #a5b4fc; border-left-color: #a5b4fc; background: rgba(165,180,252,0.1); }
    .nav-item .icon { font-size: 18px; width: 20px; text-align: center; }
    .nav-item .badge-dot { width: 8px; height: 8px; border-radius: 50%; margin-left: auto; }
    .badge-dot.online { background: #22c55e; }
    .badge-dot.offline { background: #ef4444; }
    .sidebar-bottom { margin-top: auto; padding: 16px 24px; border-top: 1px solid rgba(255,255,255,0.1); }
    .btn-logout { width: 100%; padding: 10px; background: rgba(239,68,68,0.15); color: #fca5a5; border: 1px solid rgba(239,68,68,0.3); border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; }
    .btn-logout:hover { background: rgba(239,68,68,0.25); }
    .main-content { margin-left: 240px; padding: 32px; }
    .page { display: none; }
    .page.active { display: block; }
    .page-header { margin-bottom: 28px; }
    .page-header h1 { font-size: 22px; font-weight: 700; }
    .page-header p { color: #666; font-size: 14px; margin-top: 4px; }
    .card { background: #fff; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); margin-bottom: 20px; }
    .card h3 { font-size: 15px; font-weight: 700; margin-bottom: 16px; color: #1a1a2e; display: flex; align-items: center; gap: 8px; }
    .field-group { margin-bottom: 18px; }
    .field-group label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: #444; }
    .field-group input, .field-group textarea, .field-group select { width: 100%; padding: 10px 12px; border: 1.5px solid #e0e0e0; border-radius: 8px; font-size: 14px; font-family: inherit; transition: border 0.2s; resize: vertical; }
    .field-group input:focus, .field-group textarea:focus { outline: none; border-color: #4f46e5; }
    .field-group textarea { min-height: 100px; line-height: 1.6; }
    .btn-save { padding: 11px 28px; background: #4f46e5; color: #fff; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; }
    .btn-save:hover { background: #4338ca; }
    .btn-save:disabled { background: #a5b4fc; }
    .btn-secondary { padding: 11px 20px; background: #fff; color: #4f46e5; border: 1.5px solid #4f46e5; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .btn-secondary:hover { background: #eef2ff; }
    .save-status { display: inline-block; margin-left: 12px; font-size: 13px; color: #16a34a; }
    .badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; }
    .badge-green { background: #dcfce7; color: #16a34a; }
    .badge-red { background: #fee2e2; color: #dc2626; }
    .badge-yellow { background: #fef9c3; color: #ca8a04; }
    .badge-blue { background: #dbeafe; color: #2563eb; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    table th { text-align: left; padding: 10px 12px; background: #f8fafc; font-weight: 600; color: #555; border-bottom: 1px solid #e5e7eb; }
    table td { padding: 12px 12px; border-bottom: 1px solid #f1f5f9; vertical-align: top; }
    table tr:hover td { background: #f8fafc; }
    .empty-state { text-align: center; padding: 48px; color: #aaa; }
    .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px; }
    .stat-card { background: #fff; border-radius: 12px; padding: 20px 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    .stat-card .label { font-size: 12px; font-weight: 600; color: #888; text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-card .value { font-size: 28px; font-weight: 700; margin-top: 4px; color: #1a1a2e; }
    .stat-card .sub { font-size: 12px; color: #666; margin-top: 2px; }
    .loading { color: #888; font-size: 13px; }
    .pdf-list { margin-top: 12px; }
    .pdf-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 14px; background: #f8fafc; border-radius: 8px; margin-bottom: 8px; font-size: 13px; }
    .pdf-item span { color: #444; }
    .pdf-badge { background: #e0e7ff; color: #4f46e5; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
    .upload-btn { padding: 10px 20px; background: #4f46e5; color: #fff; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; margin-top: 12px; }
    .upload-btn:disabled { background: #a5b4fc; }
    .progress-bar { height: 4px; background: #e5e7eb; border-radius: 4px; margin-top: 12px; overflow: hidden; display: none; }
    .progress-fill { height: 100%; background: #4f46e5; border-radius: 4px; transition: width 0.3s; }
    .upload-area { border: 2px dashed #d1d5db; border-radius: 10px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.2s; }
    .upload-area:hover { border-color: #4f46e5; background: #f5f3ff; }
    .upload-area input[type=file] { display: none; }
    .upload-area p { color: #666; font-size: 14px; margin-top: 8px; }

    /* TOGGLE SWITCH */
    .toggle-row { display: flex; align-items: center; justify-content: space-between; padding: 14px 0; }
    .toggle-row .toggle-info { flex: 1; }
    .toggle-row .toggle-label { font-size: 15px; font-weight: 600; color: #1a1a2e; }
    .toggle-row .toggle-desc { font-size: 13px; color: #888; margin-top: 2px; }
    .toggle-switch { position: relative; width: 50px; height: 28px; flex-shrink: 0; margin-left: 16px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #d1d5db; border-radius: 28px; transition: 0.3s; }
    .toggle-slider:before { content: ''; position: absolute; width: 22px; height: 22px; left: 3px; bottom: 3px; background: #fff; border-radius: 50%; transition: 0.3s; box-shadow: 0 1px 3px rgba(0,0,0,0.15); }
    .toggle-switch input:checked + .toggle-slider { background: #4f46e5; }
    .toggle-switch input:checked + .toggle-slider:before { transform: translateX(22px); }
    .audio-badge { display: inline-flex; align-items: center; gap: 4px; font-size: 11px; padding: 2px 8px; border-radius: 12px; background: #f3e8ff; color: #7c3aed; font-weight: 600; margin-left: 6px; vertical-align: middle; }

    /* MSG AUDIO ICONS */
    .msg-audio-tag { display: inline-flex; align-items: center; gap: 3px; font-size: 11px; color: #7c3aed; background: #f3e8ff; padding: 2px 8px; border-radius: 10px; margin-bottom: 4px; font-weight: 600; }

    /* ===================== CRM KANBAN ===================== */
    .crm-toolbar { display:flex; align-items:center; justify-content:space-between; margin-bottom:20px; flex-wrap:wrap; gap:10px; }
    .crm-board-wrap { overflow-x:auto; padding-bottom:16px; }
    .crm-board { display:flex; gap:14px; min-height:560px; width:max-content; }
    .crm-col { width:260px; background:#f8fafc; border-radius:14px; padding:12px; flex-shrink:0; display:flex; flex-direction:column; }
    .crm-col-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; padding:4px 2px; }
    .crm-col-title { font-size:13px; font-weight:700; color:#1a1a2e; display:flex; align-items:center; gap:6px; }
    .crm-col-count { background:#e5e7eb; color:#555; font-size:11px; font-weight:700; padding:2px 8px; border-radius:10px; }
    .crm-cards { flex:1; min-height:80px; border-radius:10px; transition:background 0.15s; }
    .crm-cards.dragover { background:#e0e7ff; outline:2px dashed #4f46e5; outline-offset:2px; }
    .crm-card { background:#fff; border-radius:10px; padding:14px 14px 12px; margin-bottom:10px; cursor:grab; box-shadow:0 1px 4px rgba(0,0,0,0.08); border-left:4px solid #e5e7eb; transition:box-shadow 0.15s, opacity 0.15s; user-select:none; }
    .crm-card:active { cursor:grabbing; opacity:0.65; box-shadow:0 4px 12px rgba(0,0,0,0.15); }
    .crm-card:hover { box-shadow:0 3px 10px rgba(0,0,0,0.12); }
    .crm-card[data-stage="novo_contato"]     { border-left-color:#f59e0b; }
    .crm-card[data-stage="em_atendimento"]   { border-left-color:#3b82f6; }
    .crm-card[data-stage="qualificado"]      { border-left-color:#16a34a; }
    .crm-card[data-stage="nao_qualificado"]  { border-left-color:#dc2626; }
    .crm-card[data-stage="convertido"]       { border-left-color:#7c3aed; }
    .crm-card[data-stage="perdido"]          { border-left-color:#9ca3af; }
    .crm-card-top { display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:6px; }
    .crm-card-name { font-size:13px; font-weight:700; color:#1a1a2e; }
    .crm-card-aniv { font-size:14px; cursor:default; }
    .crm-card-tese { font-size:12px; color:#555; margin-bottom:4px; line-height:1.4; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
    .crm-card-assunto { font-size:11px; color:#7c3aed; background:#f3e8ff; padding:2px 7px; border-radius:8px; display:inline-block; margin-bottom:8px; font-weight:600; }
    .crm-card-footer { display:flex; justify-content:space-between; align-items:center; font-size:11px; color:#888; border-top:1px solid #f1f5f9; padding-top:8px; margin-top:4px; }
    .crm-card-tasks { display:flex; align-items:center; gap:3px; }
    .crm-card-tasks.has-pending { color:#f59e0b; font-weight:700; }
    /* Column left-border colors */
    .crm-col[data-stage="novo_contato"]    .crm-col-count { background:#fef9c3; color:#92400e; }
    .crm-col[data-stage="em_atendimento"]  .crm-col-count { background:#dbeafe; color:#1e40af; }
    .crm-col[data-stage="qualificado"]     .crm-col-count { background:#dcfce7; color:#166534; }
    .crm-col[data-stage="nao_qualificado"] .crm-col-count { background:#fee2e2; color:#991b1b; }
    .crm-col[data-stage="convertido"]      .crm-col-count { background:#f3e8ff; color:#5b21b6; }
    .crm-col[data-stage="perdido"]         .crm-col-count { background:#f1f5f9; color:#64748b; }
    /* CRM Modal */
    .crm-modal-box { width:600px; max-width:95vw; max-height:90vh; overflow:hidden; display:flex; flex-direction:column; }
    .crm-modal-tabs { display:flex; gap:0; border-bottom:2px solid #e5e7eb; margin:-32px -32px 24px; padding:0 32px; }
    .crm-tab { padding:12px 18px; font-size:13px; font-weight:600; color:#888; cursor:pointer; border-bottom:2px solid transparent; margin-bottom:-2px; transition:all 0.15s; }
    .crm-tab.active { color:#4f46e5; border-bottom-color:#4f46e5; }
    .crm-tab-content { display:none; overflow-y:auto; flex:1; }
    .crm-tab-content.active { display:block; }
    .tarefa-item { display:flex; align-items:center; gap:10px; padding:8px 0; border-bottom:1px solid #f1f5f9; }
    .tarefa-item input[type=checkbox] { width:16px; height:16px; cursor:pointer; accent-color:#4f46e5; }
    .tarefa-item .tarefa-desc { flex:1; font-size:13px; }
    .tarefa-item .tarefa-desc.done { text-decoration:line-through; color:#aaa; }
    .tarefa-item .tarefa-date { font-size:11px; color:#888; flex-shrink:0; }
    .tarefa-item .tarefa-del { background:none; border:none; color:#ef4444; cursor:pointer; font-size:16px; padding:0 2px; }
    .btn-entrar-conversa { width:100%; padding:13px; background:#25d366; color:#fff; border:none; border-radius:10px; font-size:14px; font-weight:700; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; margin-top:16px; }
    .btn-entrar-conversa:hover { background:#1ebe5b; }
    .btn-add-tarefa { padding:9px 16px; background:#f0f2f5; color:#444; border:1.5px solid #e0e0e0; border-radius:8px; font-size:13px; font-weight:600; cursor:pointer; }
    .btn-add-tarefa:hover { background:#e5e7eb; }
    /* Gerenciar Colunas */
    .stages-list { display:flex; flex-direction:column; gap:8px; margin:16px 0; max-height:380px; overflow-y:auto; }
    .stage-row { display:flex; align-items:center; gap:10px; background:#f8fafc; border-radius:10px; padding:10px 12px; cursor:grab; border:1.5px solid #e5e7eb; }
    .stage-row:active { cursor:grabbing; opacity:0.7; }
    .stage-row.drag-over { border-color:#4f46e5; background:#eef2ff; }
    .stage-drag-handle { color:#ccc; font-size:16px; cursor:grab; flex-shrink:0; }
    .stage-color-dot { width:14px; height:14px; border-radius:50%; flex-shrink:0; border:2px solid rgba(0,0,0,0.1); cursor:pointer; }
    .stage-name-input { flex:1; border:none; background:transparent; font-size:14px; font-weight:600; color:#1a1a2e; outline:none; padding:2px 4px; border-radius:4px; }
    .stage-name-input:focus { background:#fff; border:1.5px solid #4f46e5; padding:1px 3px; }
    .stage-del-btn { background:none; border:none; color:#d1d5db; cursor:pointer; font-size:16px; padding:0 2px; flex-shrink:0; }
    .stage-del-btn:hover { color:#ef4444; }
    .color-palette { display:flex; flex-wrap:wrap; gap:6px; padding:8px; background:#fff; border-radius:8px; box-shadow:0 4px 16px rgba(0,0,0,0.15); position:absolute; z-index:2000; }
    .color-swatch { width:22px; height:22px; border-radius:50%; cursor:pointer; border:2px solid transparent; }
    .color-swatch:hover, .color-swatch.selected { border-color:#1a1a2e; transform:scale(1.15); }
    /* WHATSAPP PAGE */
    .wa-status-bar { display: flex; align-items: center; gap: 12px; padding: 16px 20px; border-radius: 10px; margin-bottom: 20px; font-weight: 600; font-size: 15px; }
    .wa-status-bar.connected { background: #dcfce7; color: #16a34a; border: 1.5px solid #bbf7d0; }
    .wa-status-bar.disconnected { background: #fee2e2; color: #dc2626; border: 1.5px solid #fecaca; }
    .wa-status-bar.connecting { background: #fef9c3; color: #ca8a04; border: 1.5px solid #fef08a; }
    .wa-status-dot { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }
    .wa-status-bar.connected .wa-status-dot { background: #16a34a; box-shadow: 0 0 0 3px rgba(22,163,74,0.2); }
    .wa-status-bar.disconnected .wa-status-dot { background: #dc2626; box-shadow: 0 0 0 3px rgba(220,38,38,0.2); }
    .wa-status-bar.connecting .wa-status-dot { background: #ca8a04; animation: pulse 1s infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
    .qr-container { display: flex; flex-direction: column; align-items: center; padding: 32px; }
    .qr-container img { width: 240px; height: 240px; border: 8px solid #fff; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.12); }
    .qr-placeholder { width: 240px; height: 240px; background: #f8fafc; border: 2px dashed #d1d5db; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; color: #aaa; }
    .qr-placeholder .qr-icon { font-size: 48px; }
    .qr-steps { display: flex; flex-direction: column; gap: 12px; margin-top: 20px; }
    .qr-step { display: flex; align-items: flex-start; gap: 12px; font-size: 14px; color: #444; }
    .qr-step-num { width: 24px; height: 24px; background: #4f46e5; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; flex-shrink: 0; margin-top: 1px; }
    .btn-secondary { padding: 10px 22px; background: #f0f2f5; color: #444; border: 1.5px solid #e0e0e0; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .btn-secondary:hover { background: #e5e7eb; }
    .btn-wa-connect { padding: 12px 28px; background: #25d366; color: #fff; border: none; border-radius: 8px; font-size: 15px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 8px; margin-top: 16px; }
    .btn-wa-connect:hover { background: #1ebe5b; }
    .btn-wa-connect:disabled { background: #a5b4fc; cursor: not-allowed; }
    .btn-wa-disconnect { padding: 10px 22px; background: rgba(239,68,68,0.1); color: #dc2626; border: 1.5px solid rgba(239,68,68,0.3); border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; }
    .btn-wa-disconnect:hover { background: rgba(239,68,68,0.2); }
    .qr-timer { font-size: 13px; color: #888; margin-top: 8px; }
    .qr-timer span { color: #ef4444; font-weight: 700; }

    /* BATE-PAPO */
    .chat-layout { display: grid; grid-template-columns: 300px 1fr; gap: 0; height: calc(100vh - 160px); min-height: 500px; background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); overflow: hidden; }
    .chat-sidebar { border-right: 1px solid #f1f5f9; display: flex; flex-direction: column; overflow: hidden; }
    .chat-sidebar-header { padding: 16px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; justify-content: space-between; }
    .chat-sidebar-header h3 { font-size: 14px; font-weight: 700; color: #1a1a2e; }
    .chat-search { padding: 10px 14px; border: 1.5px solid #e5e7eb; border-radius: 8px; font-size: 13px; width: 100%; margin: 10px 14px; width: calc(100% - 28px); }
    .chat-search:focus { outline: none; border-color: #4f46e5; }
    .conv-list { flex: 1; overflow-y: auto; }
    .conv-item { padding: 14px 16px; border-bottom: 1px solid #f8fafc; cursor: pointer; transition: background 0.15s; }
    .conv-item:hover { background: #f8fafc; }
    .conv-item.active { background: #eef2ff; border-left: 3px solid #4f46e5; }
    .conv-name { font-size: 13px; font-weight: 700; color: #1a1a2e; display: flex; justify-content: space-between; align-items: center; }
    .conv-time { font-size: 11px; color: #aaa; font-weight: 400; }
    .conv-preview { font-size: 12px; color: #888; margin-top: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .conv-unread { background: #4f46e5; color: #fff; border-radius: 10px; font-size: 10px; font-weight: 700; padding: 1px 6px; min-width: 18px; text-align: center; }
    .chat-main { display: flex; flex-direction: column; overflow: hidden; }
    .chat-header { padding: 14px 20px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; gap: 12px; }
    .chat-header-avatar { width: 38px; height: 38px; background: #4f46e5; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 15px; font-weight: 700; flex-shrink: 0; }
    .chat-header-info h4 { font-size: 14px; font-weight: 700; }
    .chat-header-info p { font-size: 12px; color: #888; }
    .chat-header-actions { margin-left: auto; display: flex; gap: 8px; }
    .messages-area { flex: 1; overflow-y: auto; padding: 20px; background: #f8fafc; display: flex; flex-direction: column; gap: 10px; }
    .msg-row { display: flex; align-items: flex-end; gap: 8px; }
    .msg-row.user { flex-direction: row-reverse; }
    .msg-bubble { max-width: 68%; padding: 10px 14px; border-radius: 16px; font-size: 13px; line-height: 1.55; word-break: break-word; }
    .msg-row.assistant .msg-bubble { background: #fff; color: #1a1a2e; border-bottom-left-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.07); }
    .msg-row.user .msg-bubble { background: #4f46e5; color: #fff; border-bottom-right-radius: 4px; }
    .msg-time { font-size: 10px; color: #bbb; margin-bottom: 2px; flex-shrink: 0; }
    .msg-row.user .msg-time { text-align: right; }
    .chat-input-area { padding: 16px; border-top: 1px solid #f1f5f9; display: flex; gap: 10px; align-items: flex-end; background: #fff; }
    .chat-input { flex: 1; padding: 12px 14px; border: 1.5px solid #e0e0e0; border-radius: 20px; font-size: 14px; font-family: inherit; resize: none; max-height: 100px; line-height: 1.5; }
    .chat-input:focus { outline: none; border-color: #4f46e5; }
    .btn-send { width: 42px; height: 42px; background: #4f46e5; color: #fff; border: none; border-radius: 50%; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: background 0.2s; }
    .btn-send:hover { background: #4338ca; }
    .btn-send:disabled { background: #a5b4fc; }
    .chat-empty { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #aaa; gap: 8px; }
    .chat-empty .icon { font-size: 48px; }
    .auto-refresh-badge { display: inline-flex; align-items: center; gap: 5px; background: #dcfce7; color: #16a34a; padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; }
    .auto-refresh-dot { width: 6px; height: 6px; background: #16a34a; border-radius: 50%; animation: pulse 1.5s infinite; }
    .tabs { display: flex; gap: 4px; margin-bottom: 24px; background: #f0f2f5; padding: 4px; border-radius: 10px; width: fit-content; }
    .tab-btn { padding: 8px 18px; border: none; background: transparent; border-radius: 7px; cursor: pointer; font-size: 13px; font-weight: 600; color: #666; transition: all 0.2s; }
    .tab-btn.active { background: #fff; color: #4f46e5; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* MODAL */
    .modal-backdrop { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:1000; align-items:center; justify-content:center; }
    .modal-backdrop.open { display:flex; }
    .modal-box { background:#fff; padding:32px; border-radius:16px; width:460px; max-width:92vw; box-shadow:0 16px 48px rgba(0,0,0,0.2); }
    .modal-box h2 { font-size:18px; font-weight:700; margin-bottom:24px; color:#1a1a2e; }
    .modal-actions { display:flex; gap:10px; margin-top:20px; }

    /* ADMIN */
    .badge-purple { background:#ede9fe; color:#7c3aed; }
    .admin-only { display:none !important; }
    .admin-only.visible { display:flex !important; }
    .nav-section.admin-only.visible { display:block !important; }
    .client-tag { font-size:10px; background:#f0fdf4; color:#16a34a; padding:2px 7px; border-radius:10px; font-weight:700; }
    .client-tag.inactive { background:#fee2e2; color:#dc2626; }

    /* FATURAMENTO */
    .billing-hero { background: linear-gradient(135deg,#4f46e5 0%,#7c3aed 100%); color:#fff; border-radius:16px; padding:32px 36px; margin-bottom:24px; display:flex; justify-content:space-between; align-items:center; }
    .billing-hero h2 { font-size:22px; font-weight:800; margin-bottom:4px; }
    .billing-hero p { opacity:.8; font-size:14px; }
    .billing-hero .price { font-size:42px; font-weight:900; letter-spacing:-1px; }
    .billing-hero .price sup { font-size:18px; font-weight:600; vertical-align:super; }
    .billing-hero .price sub { font-size:14px; font-weight:400; opacity:.75; }
    .billing-status-badge { display:inline-flex; align-items:center; gap:6px; padding:6px 16px; border-radius:30px; font-size:13px; font-weight:700; margin-top:12px; }
    .billing-status-badge.trial { background:rgba(255,255,255,0.2); color:#fff; }
    .billing-status-badge.ativa { background:#dcfce7; color:#16a34a; }
    .billing-status-badge.inadimplente { background:#fee2e2; color:#dc2626; }
    .billing-status-badge.cancelada { background:#f3f4f6; color:#6b7280; }
    .billing-info-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:16px; margin-bottom:24px; }
    .billing-info-card { background:#fff; border-radius:12px; padding:20px 22px; box-shadow:0 2px 8px rgba(0,0,0,.06); }
    .billing-info-card .label { font-size:11px; font-weight:700; text-transform:uppercase; color:#888; letter-spacing:.5px; }
    .billing-info-card .value { font-size:20px; font-weight:700; margin-top:4px; color:#1a1a2e; }
    .billing-info-card .sub { font-size:12px; color:#666; margin-top:2px; }
    .history-row-pago { color:#16a34a; font-weight:700; }
    .history-row-pendente { color:#ca8a04; font-weight:700; }
    .history-row-atrasado { color:#dc2626; font-weight:700; }
    .btn-danger { padding:7px 16px; background:rgba(239,68,68,.1); color:#dc2626; border:1.5px solid rgba(239,68,68,.3); border-radius:8px; font-size:13px; font-weight:600; cursor:pointer; }
    .btn-success { padding:7px 16px; background:rgba(22,163,74,.1); color:#16a34a; border:1.5px solid rgba(22,163,74,.3); border-radius:8px; font-size:13px; font-weight:600; cursor:pointer; }
    .billing-actions { display:flex; gap:8px; flex-wrap:wrap; }

    /* CR√âDITOS / TOKENS */
    .credits-balance { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: #fff; border-radius: 16px; padding: 24px 28px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
    .credits-balance h3 { font-size: 13px; font-weight: 600; opacity: 0.7; margin-bottom: 4px; text-transform: uppercase; letter-spacing: .5px; }
    .credits-balance .tokens-value { font-size: 36px; font-weight: 800; letter-spacing: -1px; }
    .credits-balance .tokens-sub { font-size: 12px; opacity: 0.6; margin-top: 2px; }
    .credits-balance .tokens-box { background: rgba(255,255,255,0.12); padding: 14px 20px; border-radius: 12px; text-align: center; min-width: 120px; }
    .credits-balance .tokens-box .leads-num { font-size: 28px; font-weight: 800; }
    .credits-balance .tokens-box .leads-label { font-size: 11px; opacity: 0.7; margin-top: 2px; }
    .pricing-section-title { font-size: 16px; font-weight: 700; margin-bottom: 16px; color: #1a1a2e; display: flex; align-items: center; gap: 8px; }
    .pricing-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
    .pricing-card { background: #fff; border-radius: 14px; padding: 24px 20px; box-shadow: 0 2px 8px rgba(0,0,0,.07); border: 2px solid #e5e7eb; position: relative; transition: all .2s; }
    .pricing-card:hover { border-color: #4f46e5; box-shadow: 0 6px 24px rgba(79,70,229,.15); transform: translateY(-2px); }
    .pricing-card.popular { border-color: #4f46e5; box-shadow: 0 4px 24px rgba(79,70,229,.2); }
    .pricing-card .pop-badge { position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: #4f46e5; color: #fff; font-size: 11px; font-weight: 700; padding: 3px 14px; border-radius: 20px; white-space: nowrap; }
    .pricing-card .pkg-name { font-size: 15px; font-weight: 700; color: #1a1a2e; margin-bottom: 2px; }
    .pricing-card .pkg-leads { font-size: 12px; color: #888; margin-bottom: 14px; }
    .pricing-card .pkg-price { font-size: 34px; font-weight: 800; color: #4f46e5; letter-spacing: -1px; line-height: 1; }
    .pricing-card .pkg-price sup { font-size: 16px; font-weight: 600; vertical-align: super; }
    .pricing-card .pkg-price sub { font-size: 13px; font-weight: 400; color: #888; }
    .pricing-card .pkg-tokens { font-size: 12px; color: #888; margin: 8px 0 14px; }
    .pkg-features { list-style: none; margin: 0 0 16px; padding: 0; display: flex; flex-direction: column; gap: 6px; }
    .pkg-features li { font-size: 12px; color: #555; display: flex; align-items: center; gap: 6px; }
    .pkg-features li::before { content: '‚úì'; color: #16a34a; font-weight: 700; flex-shrink: 0; }
    .pricing-card .btn-buy { width: 100%; padding: 11px; background: #4f46e5; color: #fff; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: background .2s; }
    .pricing-card .btn-buy:hover { background: #4338ca; }
    .buy-modal-pkg-info { background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 16px; border: 1.5px solid #e5e7eb; }
    .buy-modal-pkg-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .buy-modal-pkg-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px; color: #555; margin-top: 12px; }
    .pedidos-badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; }
    .pedidos-badge.pendente { background: #fef9c3; color: #ca8a04; }
    .pedidos-badge.aprovado { background: #dcfce7; color: #16a34a; }
    .pedidos-badge.recusado { background: #fee2e2; color: #dc2626; }

    /* POPUP TOKENS BAIXOS */
    .token-alert-backdrop { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:2000; align-items:center; justify-content:center; backdrop-filter:blur(3px); animation:fadeIn .25s ease; }
    .token-alert-backdrop.open { display:flex; }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    .token-alert-box { background:#fff; border-radius:20px; width:460px; max-width:94vw; box-shadow:0 24px 64px rgba(0,0,0,0.22); overflow:hidden; animation:slideUp .3s ease; }
    @keyframes slideUp { from{transform:translateY(30px);opacity:0} to{transform:translateY(0);opacity:1} }
    .token-alert-header { background:linear-gradient(135deg,#dc2626 0%,#b91c1c 100%); padding:28px 28px 20px; text-align:center; position:relative; }
    .token-alert-header.warning { background:linear-gradient(135deg,#ea580c 0%,#c2410c 100%); }
    .token-alert-icon { font-size:48px; display:block; margin-bottom:10px; animation:shake .5s ease .3s both; }
    @keyframes shake { 0%,100%{transform:rotate(0)} 20%{transform:rotate(-8deg)} 40%{transform:rotate(8deg)} 60%{transform:rotate(-5deg)} 80%{transform:rotate(5deg)} }
    .token-alert-header h2 { color:#fff; font-size:20px; font-weight:800; margin-bottom:4px; }
    .token-alert-header p { color:rgba(255,255,255,0.85); font-size:13px; }
    .token-alert-saldo { display:inline-flex; align-items:center; gap:8px; background:rgba(255,255,255,0.2); border-radius:30px; padding:6px 16px; margin-top:10px; color:#fff; font-size:13px; font-weight:700; }
    .token-alert-body { padding:24px 28px; }
    .token-alert-pkg { background:linear-gradient(135deg,#eef2ff 0%,#e0e7ff 100%); border:2px solid #4f46e5; border-radius:14px; padding:20px 22px; margin-bottom:20px; position:relative; }
    .token-alert-pkg .pop-label { position:absolute; top:-12px; left:50%; transform:translateX(-50%); background:#4f46e5; color:#fff; font-size:11px; font-weight:800; padding:4px 16px; border-radius:20px; white-space:nowrap; letter-spacing:.3px; }
    .token-alert-pkg-row { display:flex; justify-content:space-between; align-items:center; }
    .token-alert-pkg-name { font-size:18px; font-weight:800; color:#1a1a2e; }
    .token-alert-pkg-price { font-size:28px; font-weight:900; color:#4f46e5; letter-spacing:-1px; }
    .token-alert-pkg-price sup { font-size:14px; font-weight:700; vertical-align:super; }
    .token-alert-pkg-features { display:flex; flex-wrap:wrap; gap:8px; margin-top:12px; }
    .token-alert-pkg-features span { background:#fff; border-radius:20px; padding:4px 12px; font-size:12px; font-weight:600; color:#4f46e5; border:1px solid #c7d2fe; }
    .token-alert-urgency { display:flex; align-items:center; gap:8px; background:#fef9c3; border:1px solid #fde68a; border-radius:10px; padding:10px 14px; margin-bottom:16px; font-size:13px; color:#78350f; font-weight:600; }
    .btn-token-alert-buy { width:100%; padding:15px; background:linear-gradient(135deg,#4f46e5 0%,#7c3aed 100%); color:#fff; border:none; border-radius:12px; font-size:16px; font-weight:800; cursor:pointer; letter-spacing:.3px; transition:all .2s; box-shadow:0 4px 16px rgba(79,70,229,.4); }
    .btn-token-alert-buy:hover { transform:translateY(-1px); box-shadow:0 6px 24px rgba(79,70,229,.5); }
    .btn-token-alert-later { width:100%; padding:10px; background:transparent; color:#aaa; border:none; cursor:pointer; font-size:13px; margin-top:8px; transition:color .2s; }
    .btn-token-alert-later:hover { color:#666; }
    .token-progress-bar { height:8px; background:#fee2e2; border-radius:8px; margin:12px 0 4px; overflow:hidden; }
    .token-progress-fill { height:100%; border-radius:8px; transition:width .5s ease; }

    /* FLOW DESIGNER */
    .flow-toolbar { display:flex; align-items:center; gap:10px; margin-bottom:16px; flex-wrap:wrap; }
    .flow-toolbar input { flex:1; min-width:200px; padding:9px 14px; border:1.5px solid #e0e0e0; border-radius:8px; font-size:14px; }
    .flow-toolbar input:focus { outline:none; border-color:#4f46e5; }
    .flow-layout { display:grid; grid-template-columns:200px 1fr; gap:0; height:calc(100vh - 220px); min-height:500px; background:#fff; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.06); overflow:hidden; }
    .flow-palette { border-right:1px solid #f1f5f9; padding:16px 12px; display:flex; flex-direction:column; gap:8px; overflow-y:auto; background:#fafafa; }
    .flow-palette h4 { font-size:11px; font-weight:700; color:#888; text-transform:uppercase; letter-spacing:.8px; margin-bottom:4px; }
    .palette-node { padding:10px 12px; background:#fff; border:1.5px solid #e5e7eb; border-radius:8px; cursor:grab; font-size:13px; font-weight:600; text-align:center; transition:all .2s; user-select:none; }
    .palette-node:hover { border-color:#4f46e5; background:#eef2ff; color:#4f46e5; }
    .palette-node:active { cursor:grabbing; }
    .flow-canvas-wrap { position:relative; overflow:hidden; background:#f8fafc; }
    #drawflow { width:100%; height:100%; }
    .drawflow { background-color:#f8fafc !important; background-image: radial-gradient(circle, #d1d5db 1px, transparent 1px) !important; background-size: 24px 24px !important; }
    .drawflow .drawflow-node { background:#fff; border:2px solid #e5e7eb; border-radius:10px; min-width:140px; box-shadow:0 2px 8px rgba(0,0,0,.08); }
    .drawflow .drawflow-node.selected { border-color:#4f46e5; box-shadow:0 0 0 3px rgba(79,70,229,.2); }
    .drawflow .drawflow-node .title-box { background:#4f46e5; color:#fff; padding:8px 12px; border-radius:8px 8px 0 0; font-size:12px; font-weight:700; }
    .drawflow .drawflow-node .box { padding:12px; font-size:12px; color:#444; }
    .drawflow .drawflow-node.node-inicio .title-box { background:#16a34a; }
    .drawflow .drawflow-node.node-fim .title-box { background:#dc2626; }
    .drawflow .drawflow-node.node-qualificado .title-box { background:#16a34a; }
    .drawflow .drawflow-node.node-desqualificado .title-box { background:#dc2626; }
    .drawflow .drawflow-node.node-condicao .title-box { background:#ca8a04; }
    .drawflow .drawflow-node.node-pergunta .title-box { background:#7c3aed; }
    .drawflow-delete { background:#ef4444 !important; }
    .flow-saved-list { display:flex; flex-direction:column; gap:8px; }
    .flow-saved-item { display:flex; align-items:center; justify-content:space-between; padding:10px 14px; background:#f8fafc; border-radius:8px; font-size:13px; cursor:pointer; border:1.5px solid transparent; transition:all .2s; }
    .flow-saved-item:hover { border-color:#4f46e5; background:#eef2ff; }
    .flow-empty-canvas { display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:#aaa; gap:8px; pointer-events:none; }
    .flow-empty-canvas .icon { font-size:48px; }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/drawflow/dist/drawflow.min.css" />
</head>
<body>

<!-- LOGIN -->
<div id="login-page">
  <div class="login-box">
    <h1>ü§ñ XPERT.IA</h1>
    <p>Painel de administra√ß√£o do agente IA</p>
    <div class="form-group">
      <label>E-mail</label>
      <input type="email" id="login-email" placeholder="seu@email.com" />
    </div>
    <div class="form-group">
      <label>Senha</label>
      <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
    </div>
    <button class="btn-primary" id="btn-login" onclick="login()">Entrar</button>
    <div class="error-msg" id="login-error"></div>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard-page">
  <div class="sidebar">
    <div class="logo">
      <h2>ü§ñ XPERT.IA</h2>
      <p>Painel de Administra√ß√£o</p>
    </div>
    <div style="padding: 8px 0; flex: 1;">
      <div class="nav-section">Principal</div>
      <div class="nav-item active" onclick="showPage('overview', this)">
        <span class="icon">üìä</span> Vis√£o Geral
      </div>
      <div class="nav-section">WhatsApp</div>
      <div class="nav-item" onclick="showPage('whatsapp', this)" id="nav-whatsapp">
        <span class="icon">üì±</span> Conex√£o QR Code
        <span class="badge-dot offline" id="nav-wa-dot"></span>
      </div>
      <div class="nav-item" onclick="showPage('batepapo', this)">
        <span class="icon">üí¨</span> Bate-Papo ao Vivo
      </div>
      <div class="nav-item" onclick="showPage('crm', this)">
        <span class="icon">üóÇÔ∏è</span> CRM ‚Äî Pipeline
      </div>
      <div class="nav-section">Configura√ß√£o</div>
      <div class="nav-item" onclick="showPage('agente', this)">
        <span class="icon">ü§ñ</span> Agente & Prompt
      </div>
      <div class="nav-item" onclick="showPage('comunicacao', this)">
        <span class="icon">üó£Ô∏è</span> Comunica√ß√£o
      </div>
      <div class="nav-item" onclick="showPage('qualificacao', this)">
        <span class="icon">‚úÖ</span> Qualifica√ß√£o
      </div>
      <div class="nav-item" onclick="showPage('pdfs', this)">
        <span class="icon">üìÑ</span> Base de PDFs
      </div>
      <div class="nav-section">Resultados</div>
      <div class="nav-item" onclick="showPage('leads', this)">
        <span class="icon">üë•</span> Leads
      </div>
      <div class="nav-section">Ferramentas</div>
      <div class="nav-item" onclick="showPage('fluxos', this)">
        <span class="icon">üîÄ</span> Designer de Fluxos
      </div>
      <div class="nav-section">Conta</div>
      <div class="nav-item" onclick="showPage('faturamento', this)">
        <span class="icon">üí≥</span> Faturamento
      </div>
      <div class="nav-section admin-only" id="admin-nav-section">Super Admin</div>
      <div class="nav-item admin-only" id="admin-nav-clientes" onclick="showPage('clientes', this)">
        <span class="icon">üè¢</span> Clientes
      </div>
    </div>
    <div class="sidebar-bottom">
      <div style="margin-bottom:12px;font-size:12px;color:rgba(255,255,255,0.5);">
        <div id="sidebar-user-name" style="color:#fff;font-weight:600;font-size:13px;margin-bottom:2px;">‚Äî</div>
        <div id="sidebar-user-role" style="font-size:11px;"></div>
      </div>
      <button class="btn-logout" onclick="logout()">Sair</button>
    </div>
  </div>

  <div class="main-content">

    <!-- OVERVIEW -->
    <div class="page active" id="page-overview">
      <div class="page-header">
        <h1>Vis√£o Geral</h1>
        <p>Resumo do desempenho do agente XPERT.IA</p>
      </div>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="label">Total de Leads</div>
          <div class="value" id="stat-total">‚Äî</div>
          <div class="sub">atendimentos realizados</div>
        </div>
        <div class="stat-card">
          <div class="label">Qualificados</div>
          <div class="value" id="stat-qual" style="color:#16a34a">‚Äî</div>
          <div class="sub">encaminhados ao advogado</div>
        </div>
        <div class="stat-card">
          <div class="label">Taxa de Qualifica√ß√£o</div>
          <div class="value" id="stat-taxa">‚Äî</div>
          <div class="sub">dos atendimentos</div>
        </div>
      </div>
      <div class="card">
        <h3>üìã √öltimos Leads</h3>
        <div id="overview-leads"><p class="loading">Carregando...</p></div>
      </div>
    </div>

    <!-- WHATSAPP -->
    <div class="page" id="page-whatsapp">
      <div class="page-header">
        <h1>üì± Conex√£o WhatsApp via QR Code</h1>
        <p>Conecte seu WhatsApp escaneando o QR Code</p>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
        <div class="card">
          <h3>üì∂ Status da Conex√£o</h3>
          <div id="wa-status-bar" class="wa-status-bar disconnected">
            <span class="wa-status-dot"></span>
            <span id="wa-status-text">Verificando...</span>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:4px;">
            <button class="btn-save" onclick="checkWAStatus()" style="padding:10px 20px;">üîÑ Verificar Status</button>
            <button class="btn-wa-disconnect" id="btn-desconectar" onclick="disconnectWA()" style="display:none;">‚èπ Desconectar</button>
          </div>
          <div style="margin-top:20px;padding:16px;background:#f8fafc;border-radius:10px;font-size:13px;color:#555;">
            <div style="font-weight:700;margin-bottom:8px;color:#1a1a2e;">üìã Informa√ß√µes da Inst√¢ncia</div>
            <div style="display:flex;flex-direction:column;gap:6px;">
              <div><strong>Inst√¢ncia:</strong> <code id="wa-instance-display" style="background:#e0e7ff;color:#4f46e5;padding:2px 6px;border-radius:4px;">‚Äî</code></div>
              <div><strong>Servidor:</strong> <code style="background:#e0e7ff;color:#4f46e5;padding:2px 6px;border-radius:4px;font-size:11px;">Proxy Seguro (evo-proxy)</code></div>
            </div>
          </div>
        </div>
        <div class="card">
          <h3>üì∑ QR Code de Conex√£o</h3>
          <div class="qr-container">
            <div class="qr-placeholder" id="qr-placeholder">
              <span class="qr-icon">üì≤</span>
              <span style="font-size:13px;font-weight:600;">Clique em "Gerar QR Code"</span>
              <span style="font-size:12px;">para conectar o WhatsApp</span>
            </div>
            <img id="qr-image" style="display:none;width:240px;height:240px;border-radius:12px;border:8px solid #fff;box-shadow:0 4px 20px rgba(0,0,0,0.12);" src="" alt="QR Code" />
            <div class="qr-timer" id="qr-timer" style="display:none;">QR expira em <span id="qr-countdown">60</span>s</div>
            <button class="btn-wa-connect" id="btn-gerar-qr" onclick="generateQR()">
              <span>üì∑</span> Gerar QR Code
            </button>
          </div>
        </div>
      </div>
      <div class="card">
        <h3>üìñ Como Conectar</h3>
        <div class="qr-steps">
          <div class="qr-step"><div class="qr-step-num">1</div><div>Clique em <strong>"Gerar QR Code"</strong> acima para criar um novo c√≥digo</div></div>
          <div class="qr-step"><div class="qr-step-num">2</div><div>No seu celular, abra o <strong>WhatsApp</strong> e v√° em <strong>Configura√ß√µes ‚Üí Dispositivos conectados</strong></div></div>
          <div class="qr-step"><div class="qr-step-num">3</div><div>Toque em <strong>"Conectar um dispositivo"</strong> e aponte a c√¢mera para o QR Code</div></div>
          <div class="qr-step"><div class="qr-step-num">4</div><div>Aguarde a confirma√ß√£o ‚Äî o status acima ficar√° <strong style="color:#16a34a;">üü¢ Conectado</strong></div></div>
          <div class="qr-step"><div class="qr-step-num">5</div><div>O agente XPERT.IA come√ßar√° a responder mensagens automaticamente pelo n√∫mero conectado</div></div>
        </div>
      </div>
    </div>

    <!-- BATE-PAPO AO VIVO -->
    <div class="page" id="page-batepapo">
      <div class="page-header" style="display:flex;align-items:center;justify-content:space-between;">
        <div>
          <h1>üí¨ Bate-Papo ao Vivo</h1>
          <p>Acompanhe as conversas em tempo real</p>
        </div>
        <div style="display:flex;align-items:center;gap:10px;">
          <span class="auto-refresh-badge"><span class="auto-refresh-dot"></span> Ao vivo</span>
          <button class="btn-secondary" onclick="loadConversations()" style="padding:8px 14px;font-size:13px;">üîÑ Atualizar</button>
        </div>
      </div>
      <div class="chat-layout">
        <!-- Lista de conversas -->
        <div class="chat-sidebar">
          <div class="chat-sidebar-header">
            <h3>Conversas Ativas</h3>
            <span id="conv-count" style="font-size:12px;color:#888;">0</span>
          </div>
          <input class="chat-search" type="text" placeholder="üîç Buscar n√∫mero..." id="chat-search" oninput="filterConversations(this.value)" />
          <div class="conv-list" id="conv-list">
            <div class="empty-state" style="padding:32px 16px;">
              <div style="font-size:32px;margin-bottom:8px;">üì≠</div>
              <div style="font-size:13px;">Nenhuma conversa ativa</div>
            </div>
          </div>
        </div>
        <!-- √Årea do chat -->
        <div class="chat-main" id="chat-main">
          <div class="chat-empty" id="chat-placeholder">
            <div class="icon">üí¨</div>
            <strong>Selecione uma conversa</strong>
            <span style="font-size:13px;">Clique em uma conversa √† esquerda para ver as mensagens</span>
          </div>
          <div id="chat-active" style="display:none;flex-direction:column;height:100%;overflow:hidden;">
            <div class="chat-header">
              <div class="chat-header-avatar" id="chat-avatar">?</div>
              <div class="chat-header-info">
                <h4 id="chat-number">‚Äî</h4>
                <p id="chat-last-seen">‚Äî</p>
              </div>
              <div class="chat-header-actions">
                <span id="chat-status-badge" class="badge badge-yellow" style="font-size:12px;"></span>
                <button id="btn-toggle-agente" class="btn-secondary" style="padding:7px 14px;font-size:12px;" onclick="toggleAgente()">‚è∏ Pausar Agente</button>
                <button class="btn-secondary" style="padding:7px 14px;font-size:12px;" onclick="clearSession()">üóë Reiniciar</button>
              </div>
            </div>
            <div id="agente-pausado-banner" style="display:none;background:#fef9c3;border-bottom:1px solid #fef08a;padding:8px 20px;font-size:13px;font-weight:600;color:#92400e;">
              ‚è∏ Agente pausado para esta conversa ‚Äî voc√™ est√° no controle. <button onclick="toggleAgente()" style="margin-left:12px;padding:4px 12px;background:#ca8a04;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:12px;">‚ñ∂ Reativar Agente</button>
            </div>
            <div class="messages-area" id="messages-area"></div>
            <div class="chat-input-area">
              <textarea class="chat-input" id="chat-input" placeholder="Digite uma mensagem para enviar direto ao WhatsApp..." rows="1"
                onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendManualMessage();}"
                oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"></textarea>
              <button class="btn-send" id="btn-send" onclick="sendManualMessage()" title="Enviar">‚û§</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- AGENTE -->
    <div class="page" id="page-agente">
      <div class="page-header"><h1>ü§ñ Agente & Prompt</h1><p>Configure as instru√ß√µes e personalidade do agente</p></div>
      <div class="card">
        <h3>üéØ Objetivo</h3>
        <div class="field-group"><label>Qual √© o objetivo do agente?</label>
          <textarea id="cfg-objetivo" placeholder="Ex: Qualificar leads de Direito Previdenci√°rio e encaminhar ao advogado."></textarea></div>
      </div>
      <div class="card">
        <h3>üìù Prompt Principal</h3>
        <div class="field-group"><label>Instru√ß√µes detalhadas do agente</label>
          <textarea id="cfg-prompt_sistema" style="min-height:200px" placeholder="Voc√™ √© um assistente de triagem jur√≠dica especializado em Direito Previdenci√°rio..."></textarea></div>
      </div>
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
        <button class="btn-save" onclick="saveConfigs(['objetivo','prompt_sistema'])">üíæ Salvar</button>
        <button class="btn-secondary" onclick="restaurarPadrao()">üîÑ Restaurar Padr√£o</button>
        <span class="save-status" id="save-agente"></span>
      </div>
    </div>

    <!-- CRM -->
    <div class="page" id="page-crm">
      <div class="page-header"><h1>üóÇÔ∏è CRM ‚Äî Pipeline de Leads</h1><p>Acompanhe cada lead do primeiro contato at√© a convers√£o</p></div>
      <div class="crm-toolbar">
        <div style="display:flex;gap:8px;align-items:center;">
          <button class="btn-save" style="padding:9px 18px;font-size:13px;" onclick="loadCRM()">üîÑ Atualizar</button>
          <button class="btn-secondary" style="padding:9px 18px;font-size:13px;" onclick="openNewLeadModal()">‚ûï Novo Lead</button>
          <button class="btn-secondary" style="padding:9px 18px;font-size:13px;" onclick="openStagesModal()">‚öôÔ∏è Colunas</button>
        </div>
        <div style="font-size:12px;color:#888;">Arraste os cards entre as colunas para atualizar o est√°gio</div>
      </div>
      <div class="crm-board-wrap">
        <div class="crm-board" id="crm-board">
          <div style="padding:40px;color:#aaa;font-size:14px;">Carregando CRM...</div>
        </div>
      </div>
    </div>

    <!-- MODAL CRM: DETALHES DO LEAD -->
    <div class="modal-backdrop" id="modal-crm-lead" onclick="if(event.target===this)closeCRMModal()">
      <div class="modal-box crm-modal-box">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0;">
          <h2 id="crm-modal-title" style="font-size:16px;font-weight:700;">Lead</h2>
          <button onclick="closeCRMModal()" style="background:none;border:none;font-size:20px;cursor:pointer;color:#888;padding:0;">‚úï</button>
        </div>
        <div class="crm-modal-tabs">
          <div class="crm-tab active" onclick="switchCRMTab('dados',this)">üìã Dados</div>
          <div class="crm-tab" onclick="switchCRMTab('tarefas',this)">‚òëÔ∏è Tarefas</div>
          <div class="crm-tab" onclick="switchCRMTab('notas',this)">üìù Notas</div>
          <div class="crm-tab" onclick="switchCRMTab('conversa',this)">üí¨ Conversa</div>
        </div>
        <!-- TAB DADOS -->
        <div class="crm-tab-content active" id="crm-tab-dados">
          <input type="hidden" id="crm-lead-id" />
          <input type="hidden" id="crm-lead-numero" />
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;">
            <div class="field-group" style="margin:0;"><label>Nome</label><input type="text" id="crm-nome" placeholder="Nome do lead" /></div>
            <div class="field-group" style="margin:0;"><label>Celular</label><input type="text" id="crm-celular" placeholder="5511999999999" /></div>
            <div class="field-group" style="margin:0;"><label>Tese jur√≠dica</label><input type="text" id="crm-tese" placeholder="Ex: Aposentadoria por invalidez" /></div>
            <div class="field-group" style="margin:0;"><label>Assunto</label><input type="text" id="crm-assunto" placeholder="Ex: Aguardando documentos" /></div>
            <div class="field-group" style="margin:0;"><label>Data de anivers√°rio</label><input type="date" id="crm-aniversario" /></div>
            <div class="field-group" style="margin:0;"><label>Est√°gio no CRM</label>
              <select id="crm-stage">
                <option value="novo_contato">üÜï Novo Contato</option>
                <option value="em_atendimento">üí¨ Em Atendimento</option>
                <option value="qualificado">‚úÖ Qualificado</option>
                <option value="nao_qualificado">‚ùå N√£o Qualificado</option>
                <option value="convertido">üéâ Convertido</option>
                <option value="perdido">üö™ Perdido</option>
              </select>
            </div>
          </div>
          <div class="field-group" style="margin-top:14px 0 0;"><label>Resumo da triagem</label><textarea id="crm-resumo" style="min-height:70px" placeholder="Resumo gerado pelo agente"></textarea></div>
          <div class="modal-actions" style="margin-top:16px;">
            <button class="btn-save" onclick="saveLeadDetails()">üíæ Salvar dados</button>
            <span class="save-status" id="crm-save-status"></span>
          </div>
        </div>
        <!-- TAB TAREFAS -->
        <div class="crm-tab-content" id="crm-tab-tarefas">
          <div id="crm-tarefas-list" style="margin-bottom:16px;min-height:60px;"></div>
          <div style="display:flex;gap:8px;align-items:flex-end;border-top:1px solid #f1f5f9;padding-top:14px;margin-top:4px;">
            <div class="field-group" style="flex:1;margin:0;"><label>Nova tarefa</label><input type="text" id="nova-tarefa-desc" placeholder="Ex: Ligar para confirmar documentos" /></div>
            <div class="field-group" style="margin:0;width:140px;"><label>Vencimento</label><input type="date" id="nova-tarefa-data" /></div>
            <button class="btn-add-tarefa" onclick="addTarefa()" style="margin-bottom:0;flex-shrink:0;">‚ûï Adicionar</button>
          </div>
        </div>
        <!-- TAB NOTAS -->
        <div class="crm-tab-content" id="crm-tab-notas">
          <div class="field-group"><label>Anota√ß√µes sobre o lead</label>
            <textarea id="crm-notas" style="min-height:180px" placeholder="Qualquer observa√ß√£o relevante: informa√ß√µes adicionais, prefer√™ncias, contexto do caso..."></textarea>
          </div>
          <button class="btn-save" onclick="saveLeadNotas()">üíæ Salvar notas</button>
          <span class="save-status" id="crm-notas-status"></span>
        </div>
        <!-- TAB CONVERSA -->
        <div class="crm-tab-content" id="crm-tab-conversa">
          <div style="background:#f8fafc;border-radius:10px;padding:16px;margin-bottom:16px;font-size:13px;color:#555;line-height:1.6;">
            <strong>üí¨ Entrar na conversa</strong> abre o Bate-Papo com este lead e <strong>pausa o agente automaticamente</strong>. Voc√™ assume o controle diretamente. Quando quiser que o agente retome, clique em "‚ñ∂Ô∏è Retomar agente" no Bate-Papo ‚Äî ele saber√° exatamente onde parou e continuar√° o atendimento.
          </div>
          <button class="btn-entrar-conversa" onclick="entrarNaConversa()">
            üí¨ Entrar na conversa (pausa o agente)
          </button>
        </div>
      </div>
    </div>

    <!-- MODAL CRM: NOVO LEAD MANUAL -->
    <div class="modal-backdrop" id="modal-novo-lead" onclick="if(event.target===this)closeNewLeadModal()">
      <div class="modal-box" style="width:460px;">
        <h2>‚ûï Novo Lead Manual</h2>
        <div class="field-group"><label>Nome</label><input type="text" id="nl-nome" placeholder="Nome do contato" /></div>
        <div class="field-group"><label>WhatsApp (com DDI+DDD)</label><input type="text" id="nl-numero" placeholder="5511999999999" /></div>
        <div class="field-group"><label>Assunto</label><input type="text" id="nl-assunto" placeholder="Ex: Quer saber sobre aposentadoria" /></div>
        <div class="modal-actions">
          <button class="btn-save" onclick="createManualLead()">‚úÖ Criar lead</button>
          <button class="btn-secondary" onclick="closeNewLeadModal()">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- MODAL: GERENCIAR COLUNAS -->
    <div class="modal-backdrop" id="modal-gerenciar-colunas" onclick="if(event.target===this)closeStagesModal()">
      <div class="modal-box" style="width:480px;position:relative;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
          <h2 style="font-size:16px;font-weight:700;">‚öôÔ∏è Gerenciar Colunas</h2>
          <button onclick="closeStagesModal()" style="background:none;border:none;font-size:20px;cursor:pointer;color:#888;padding:0;">‚úï</button>
        </div>
        <p style="font-size:12px;color:#999;margin-bottom:8px;">Arraste para reordenar ¬∑ Clique na bolinha para trocar a cor ¬∑ Edite o nome diretamente</p>
        <div class="stages-list" id="stages-list"></div>
        <div id="color-palette-popup" class="color-palette" style="display:none;"></div>
        <div style="display:flex;gap:10px;margin-top:8px;border-top:1px solid #f1f5f9;padding-top:14px;">
          <button class="btn-secondary" onclick="addNewStage()" style="flex:1;padding:10px;">‚ûï Nova coluna</button>
          <button class="btn-save" onclick="saveCRMStages()" style="flex:1;padding:10px;">üíæ Salvar</button>
        </div>
        <span class="save-status" id="stages-save-status" style="display:block;text-align:center;margin-top:8px;min-height:18px;"></span>
      </div>
    </div>

    <!-- COMUNICA√á√ÉO -->
    <div class="page" id="page-comunicacao">
      <div class="page-header"><h1>üó£Ô∏è Comunica√ß√£o</h1><p>Defina como o agente deve se comunicar</p></div>
      <div class="card">
        <h3>üé≠ Tonalidade de Voz</h3>
        <div class="field-group"><label>Como o agente deve falar?</label>
          <textarea id="cfg-tonalidade" placeholder="Ex: Emp√°tico, claro e objetivo. Use linguagem simples, sem jarg√£o jur√≠dico."></textarea></div>
      </div>
      <div class="card">
        <h3>üìè Regras de Comunica√ß√£o</h3>
        <div class="field-group"><label>Instru√ß√µes espec√≠ficas de como conduzir a conversa</label>
          <textarea id="cfg-instrucoes_comunicacao" placeholder="Ex: Fa√ßa uma pergunta por vez. Nunca prometa resultado. M√°ximo 10 trocas."></textarea></div>
      </div>
      <div class="card">
        <h3>üì± Mensagens de Encerramento</h3>
        <div class="field-group"><label>Mensagem quando lead √© QUALIFICADO</label>
          <textarea id="cfg-msg_qualificado" placeholder="Ex: √ìtimo! Vou encaminhar seu caso ao advogado. Em breve ele entrar√° em contato."></textarea></div>
        <div class="field-group"><label>Mensagem quando lead N√ÉO √© qualificado</label>
          <textarea id="cfg-msg_desqualificado" placeholder="Ex: Obrigado pelo contato! No momento n√£o identificamos um caso que atendemos."></textarea></div>
      </div>
      <div class="card">
        <h3>üîä Resposta em √Åudio</h3>
        <div class="toggle-row">
          <div class="toggle-info">
            <div class="toggle-label">Responder em √°udio no WhatsApp</div>
            <div class="toggle-desc">Quando ativado, o agente envia a resposta como mensagem de voz. √Åudios recebidos s√£o sempre transcritos independentemente desta op√ß√£o.</div>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="cfg-responder_em_audio" checked />
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div style="margin-top:8px;padding:10px 14px;background:#f0fdf4;border-radius:8px;font-size:12px;color:#166534;">
          üí° <strong>Custo:</strong> ~R$0,003 por mensagem de √°udio enviada (OpenAI TTS). Transcri√ß√£o de √°udio recebido: ~R$0,003 por √°udio de 30s (Whisper).
        </div>
      </div>
      <button class="btn-save" onclick="saveConfigs(['tonalidade','instrucoes_comunicacao','msg_qualificado','msg_desqualificado','responder_em_audio'])">üíæ Salvar</button>
      <span class="save-status" id="save-comunicacao"></span>
    </div>

    <!-- QUALIFICA√á√ÉO -->
    <div class="page" id="page-qualificacao">
      <div class="page-header"><h1>‚úÖ Qualifica√ß√£o</h1><p>Defina os crit√©rios e o n√∫mero de destino dos leads</p></div>
      <div class="card">
        <h3>üìã Crit√©rios de Qualifica√ß√£o</h3>
        <div class="field-group"><label>Liste os crit√©rios (um por linha)</label>
          <textarea id="cfg-criterios_qualificacao" placeholder="1. Possui v√≠nculo com o INSS&#10;2. Tem benef√≠cio negado ou a requerer&#10;3. √â poss√≠vel identificar uma tese jur√≠dica"></textarea></div>
      </div>
      <div class="card">
        <h3>üì≤ WhatsApp de Destino</h3>
        <div class="field-group"><label>N√∫mero que recebe os relat√≥rios dos leads qualificados</label>
          <input type="text" id="cfg-numero_destino" placeholder="5511999999999 (DDI+DDD+n√∫mero, sem espa√ßos)" /></div>
      </div>
      <button class="btn-save" onclick="saveConfigs(['criterios_qualificacao','numero_destino'])">üíæ Salvar</button>
      <span class="save-status" id="save-qualificacao"></span>
    </div>

    <!-- PDFs -->
    <div class="page" id="page-pdfs">
      <div class="page-header"><h1>üìÑ Base de Conhecimento (PDFs)</h1><p>Documentos que o agente consulta durante as conversas</p></div>
      <div class="card">
        <h3>‚¨ÜÔ∏è Enviar novo PDF</h3>
        <div class="field-group"><label>Nome do documento</label>
          <input type="text" id="pdf-nome" placeholder="Ex: Tabela de Benef√≠cios INSS 2024" /></div>
        <div class="field-group"><label>Categoria</label>
          <select id="pdf-categoria">
            <option>Legisla√ß√£o</option><option>Jurisprud√™ncia</option>
            <option>Tabelas e Valores</option><option>Procedimentos INSS</option><option>Outros</option>
          </select></div>
        <div class="field-group"><label>Arquivo</label>
          <div class="upload-area" onclick="document.getElementById('pdf-file').click()">
            <div style="font-size:36px">üìÅ</div>
            <p id="pdf-filename">Clique para selecionar um PDF</p>
            <input type="file" id="pdf-file" accept=".pdf" onchange="updateFilename(this)" />
          </div></div>
        <div class="progress-bar" id="upload-progress"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
        <button class="upload-btn" id="btn-upload-pdf" onclick="uploadPDF()">‚¨ÜÔ∏è Enviar para o agente</button>
        <span class="save-status" id="upload-status"></span>
      </div>
      <div class="card">
        <h3>üìö Documentos na base</h3>
        <div id="pdf-list"><p class="loading">Carregando...</p></div>
      </div>
    </div>

    <!-- LEADS -->
    <div class="page" id="page-leads">
      <div class="page-header"><h1>üë• Leads</h1><p>Hist√≥rico de todos os atendimentos</p></div>
      <div class="card" style="overflow-x:auto">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
          <h3 style="margin:0">üìã Todos os atendimentos</h3>
          <button class="btn-save" style="padding:8px 16px;font-size:13px" onclick="loadLeads()">üîÑ Atualizar</button>
        </div>
        <div id="leads-table"><p class="loading">Carregando...</p></div>
      </div>
    </div>

    <!-- FATURAMENTO -->
    <div class="page" id="page-faturamento">
      <div class="page-header"><h1>üí≥ Faturamento</h1><p>Gerencie sua assinatura e hist√≥rico de pagamentos</p></div>

      <!-- Hero da assinatura -->
      <div class="billing-hero" id="billing-hero">
        <div>
          <h2>ü§ñ XPERT.IA ‚Äî Plano Mensal</h2>
          <p>O √∫nico agente IA que <strong>ouve √°udios, pesquisa na web e recebe arquivos</strong> no WhatsApp</p>
          <div id="billing-status-badge" class="billing-status-badge trial">‚è≥ Per√≠odo de teste</div>
          <div style="margin-top:12px;font-size:13px;opacity:.8;">
            ‚úÖ &nbsp;IA WhatsApp 24/7 &nbsp;|&nbsp; ‚úÖ &nbsp;5M tokens/m√™s &nbsp;|&nbsp; üîä &nbsp;√Åudio &nbsp;|&nbsp; üåê &nbsp;Pesquisa Web &nbsp;|&nbsp; üìé &nbsp;Arquivos
          </div>
        </div>
        <div style="text-align:right">
          <div class="price"><sup>R$</sup>497<sub>/m√™s</sub></div>
          <div style="opacity:.75;font-size:13px;margin-top:4px" id="billing-next-date">Pr√≥xima cobran√ßa: ‚Äî</div>
          <div style="margin-top:8px;font-size:12px;opacity:.65;">Precisa de mais? Compre tokens extras abaixo</div>
        </div>
      </div>

      <div class="billing-info-grid">
        <div class="billing-info-card">
          <div class="label">Plano</div>
          <div class="value">Mensal</div>
          <div class="sub">5M tokens inclusos/m√™s</div>
        </div>
        <div class="billing-info-card">
          <div class="label">Status</div>
          <div class="value" id="billing-status-text">‚Äî</div>
          <div class="sub" id="billing-cycle-text">Cobran√ßa mensal</div>
        </div>
        <div class="billing-info-card">
          <div class="label">Vencimento</div>
          <div class="value" id="billing-due-day">‚Äî</div>
          <div class="sub">todo m√™s</div>
        </div>
      </div>

      <!-- SALDO DE CR√âDITOS -->
      <div class="credits-balance" id="credits-balance-card">
        <div>
          <h3>üí∞ Saldo de Tokens</h3>
          <div class="tokens-value" id="saldo-tokens-display">‚Äî</div>
          <div class="tokens-sub">tokens dispon√≠veis para atendimento</div>
        </div>
        <div style="display:flex;gap:12px;">
          <div class="tokens-box">
            <div class="leads-num" id="saldo-leads-display">‚Äî</div>
            <div class="leads-label">leads restantes</div>
          </div>
          <div class="tokens-box" style="background:rgba(34,197,94,0.2);">
            <div class="leads-num" id="saldo-usado-display">‚Äî</div>
            <div class="leads-label">usados este m√™s</div>
          </div>
        </div>
      </div>

      <!-- COMPRAR TOKENS EXTRAS -->
      <div class="pricing-section-title">‚ö° Comprar Tokens Extras</div>
      <p style="font-size:13px;color:#888;margin-bottom:16px;margin-top:-8px;">
        Seu plano j√° inclui <strong>5M tokens/m√™s</strong>. Precisa atender mais leads? Adicione tokens extras a qualquer momento.
      </p>
      <div class="pricing-grid">
        <!-- Mini -->
        <div class="pricing-card">
          <div class="pkg-name">‚ûï Mini</div>
          <div class="pkg-leads">+135 leads extras</div>
          <div class="pkg-price"><sup>R$</sup>97</div>
          <div class="pkg-tokens">+5 milh√µes de tokens</div>
          <ul class="pkg-features">
            <li>+135 atendimentos</li>
            <li>Soma ao saldo atual</li>
            <li>Sem prazo de validade</li>
          </ul>
          <button class="btn-buy" onclick="showBuyModal('mini')">Adicionar</button>
        </div>
        <!-- M√©dio -->
        <div class="pricing-card popular">
          <div class="pop-badge">‚≠ê Mais Popular</div>
          <div class="pkg-name">‚ûï‚ûï M√©dio</div>
          <div class="pkg-leads">+270 leads extras</div>
          <div class="pkg-price"><sup>R$</sup>177</div>
          <div class="pkg-tokens">+10 milh√µes de tokens</div>
          <ul class="pkg-features">
            <li>+270 atendimentos</li>
            <li>Soma ao saldo atual</li>
            <li>Sem prazo de validade</li>
            <li>Melhor custo/benef√≠cio</li>
          </ul>
          <button class="btn-buy" onclick="showBuyModal('medio')">Adicionar</button>
        </div>
        <!-- Grande -->
        <div class="pricing-card">
          <div class="pkg-name">üöÄ Grande</div>
          <div class="pkg-leads">+540 leads extras</div>
          <div class="pkg-price"><sup>R$</sup>297</div>
          <div class="pkg-tokens">+20 milh√µes de tokens</div>
          <ul class="pkg-features">
            <li>+540 atendimentos</li>
            <li>Soma ao saldo atual</li>
            <li>Sem prazo de validade</li>
            <li>Suporte priorit√°rio</li>
          </ul>
          <button class="btn-buy" onclick="showBuyModal('grande')">Adicionar</button>
        </div>
        <!-- Ilimitado -->
        <div class="pricing-card">
          <div class="pkg-name">üíº Max</div>
          <div class="pkg-leads">+1.350 leads extras</div>
          <div class="pkg-price"><sup>R$</sup>597</div>
          <div class="pkg-tokens">+50 milh√µes de tokens</div>
          <ul class="pkg-features">
            <li>+1.350 atendimentos</li>
            <li>Soma ao saldo atual</li>
            <li>Sem prazo de validade</li>
            <li>Suporte dedicado</li>
          </ul>
          <button class="btn-buy" onclick="showBuyModal('max')">Adicionar</button>
        </div>
      </div>

      <!-- Pedidos pendentes do cliente -->
      <div class="card" id="pedidos-cliente-card" style="margin-bottom:20px;">
        <h3>üì¶ Meus Pedidos</h3>
        <div id="pedidos-cliente-table"><p class="loading">Carregando...</p></div>
      </div>

      <!-- Hist√≥rico de cobran√ßas (cliente) -->
      <div class="card" id="billing-history-card">
        <h3>üßæ Hist√≥rico de Cobran√ßas</h3>
        <div id="billing-history-table"><p class="loading">Carregando...</p></div>
      </div>

      <!-- Admin: pedidos de cr√©ditos -->
      <div class="card admin-only" id="admin-pedidos-card" style="margin-bottom:20px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
          <h3 style="margin:0">üì¶ Pedidos de Cr√©ditos</h3>
          <button class="btn-save" style="padding:8px 16px;font-size:13px" onclick="loadAdminPedidos()">üîÑ Atualizar</button>
        </div>
        <div id="admin-pedidos-table"><p class="loading">Carregando...</p></div>
      </div>

      <!-- Admin: gerenciar assinaturas de todos os clientes -->
      <div class="card admin-only" id="billing-admin-card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
          <h3 style="margin:0">üè¢ Assinaturas dos Clientes</h3>
          <button class="btn-save" style="padding:8px 16px;font-size:13px" onclick="loadAdminBilling()">üîÑ Atualizar</button>
        </div>
        <div id="admin-billing-table"><p class="loading">Carregando...</p></div>
      </div>
    </div>

    <!-- DESIGNER DE FLUXOS -->
    <div class="page" id="page-fluxos">
      <div class="page-header"><h1>üîÄ Designer de Fluxos</h1><p>Crie e salve fluxos visuais de conversa para o seu agente</p></div>

      <div class="flow-toolbar">
        <input type="text" id="flow-name-input" placeholder="Nome do fluxo..." />
        <button class="btn-save" onclick="saveFlow()">üíæ Salvar</button>
        <button class="btn-secondary" onclick="newFlow()">‚ûï Novo</button>
        <button class="btn-secondary" onclick="clearCanvas()">üóëÔ∏è Limpar tela</button>
        <button class="btn-secondary" onclick="exportFlow()">üì§ Exportar JSON</button>
      </div>

      <div class="flow-layout">
        <!-- Paleta de n√≥s -->
        <div class="flow-palette">
          <h4>N√≥s dispon√≠veis</h4>
          <div class="palette-node" draggable="true" ondragstart="drag(event,'inicio')">üü¢ In√≠cio</div>
          <div class="palette-node" draggable="true" ondragstart="drag(event,'mensagem')">üí¨ Mensagem Bot</div>
          <div class="palette-node" draggable="true" ondragstart="drag(event,'pergunta')">‚ùì Pergunta</div>
          <div class="palette-node" draggable="true" ondragstart="drag(event,'condicao')">üîÄ Condi√ß√£o</div>
          <div class="palette-node" draggable="true" ondragstart="drag(event,'qualificado')">‚úÖ Qualificado</div>
          <div class="palette-node" draggable="true" ondragstart="drag(event,'desqualificado')">‚ùå Desqualificado</div>
          <div class="palette-node" draggable="true" ondragstart="drag(event,'fim')">üî¥ Fim</div>

          <h4 style="margin-top:16px">Fluxos salvos</h4>
          <div id="saved-flows-list"><p style="font-size:12px;color:#aaa;text-align:center;padding:8px;">Nenhum fluxo salvo</p></div>
        </div>

        <!-- Canvas Drawflow -->
        <div class="flow-canvas-wrap" id="flow-canvas-wrap"
             ondrop="drop(event)" ondragover="allowDrop(event)">
          <div id="drawflow"></div>
        </div>
      </div>
    </div>

    <!-- CLIENTES (admin only) -->
    <div class="page" id="page-clientes">
      <div class="page-header">
        <h1>üè¢ Clientes</h1>
        <p>Gerencie as contas dos seus clientes</p>
      </div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
          <h3 style="margin:0">üìã Contas cadastradas</h3>
          <button class="btn-save" onclick="openCreateClientModal()">‚ûï Novo Cliente</button>
        </div>
        <div id="clients-table"><p class="loading">Carregando...</p></div>
      </div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
          <h3 style="margin:0">ü§ñ Uso de Tokens GPT (este m√™s)</h3>
          <button class="btn-secondary" style="padding:7px 14px;font-size:13px" onclick="loadTokenUsageAdmin()">üîÑ Atualizar</button>
        </div>
        <div id="token-usage-admin-table"><p class="loading">Carregando...</p></div>
      </div>
    </div>

  </div>
</div>

<!-- POPUP ALERTA TOKENS BAIXOS -->
<div class="token-alert-backdrop" id="token-alert-popup">
  <div class="token-alert-box">
    <div class="token-alert-header" id="token-alert-header">
      <span class="token-alert-icon" id="token-alert-icon">‚ö†Ô∏è</span>
      <h2 id="token-alert-title">Seus tokens est√£o acabando!</h2>
      <p id="token-alert-subtitle">O agente pode parar de atender novos leads em breve.</p>
      <div class="token-alert-saldo">
        <span>üî¢</span>
        <span id="token-alert-saldo-txt">‚Äî</span>
        <span>tokens restantes</span>
      </div>
    </div>
    <div class="token-alert-body">
      <!-- Barra de progresso do saldo -->
      <div style="font-size:12px;color:#888;margin-bottom:4px;display:flex;justify-content:space-between;">
        <span>Saldo atual</span>
        <span id="token-alert-pct-txt">‚Äî</span>
      </div>
      <div class="token-progress-bar">
        <div class="token-progress-fill" id="token-alert-progress" style="width:0%;background:#ef4444;"></div>
      </div>
      <div style="font-size:11px;color:#aaa;text-align:right;margin-bottom:16px;">
        de 5.000.000 tokens do plano base
      </div>

      <!-- Urg√™ncia -->
      <div class="token-alert-urgency" id="token-alert-urgency">
        ‚è≥ <span id="token-alert-urgency-txt">Recarregue agora para n√£o perder atendimentos!</span>
      </div>

      <!-- Pacote recomendado -->
      <div class="token-alert-pkg">
        <div class="pop-label">‚≠ê RECOMENDADO PARA VOC√ä</div>
        <div class="token-alert-pkg-row">
          <div>
            <div class="token-alert-pkg-name">‚ûï‚ûï M√©dio</div>
            <div style="font-size:12px;color:#666;margin-top:2px;">+270 atendimentos extras</div>
          </div>
          <div style="text-align:right;">
            <div class="token-alert-pkg-price"><sup>R$</sup>177</div>
            <div style="font-size:11px;color:#888;">pagamento via PIX</div>
          </div>
        </div>
        <div class="token-alert-pkg-features">
          <span>+10M tokens</span>
          <span>+270 leads</span>
          <span>Sem prazo de validade</span>
          <span>Cr√©dito em at√© 2h</span>
        </div>
      </div>

      <button class="btn-token-alert-buy" onclick="buyFromAlert()">
        ‚ö° Quero adicionar tokens agora
      </button>
      <button class="btn-token-alert-later" onclick="dismissTokenAlert()">
        Lembrar mais tarde
      </button>
    </div>
  </div>
</div>

<!-- MODAL COMPRAR CR√âDITOS -->
<div class="modal-backdrop" id="modal-buy-credits" onclick="if(event.target===this)closeBuyModal()">
  <div class="modal-box">
    <h2 id="buy-modal-title">üõí Comprar Cr√©ditos</h2>
    <div class="buy-modal-pkg-info">
      <div class="buy-modal-pkg-row">
        <span id="buy-pkg-name" style="font-weight:700;font-size:16px;"></span>
        <span id="buy-pkg-price" style="font-size:22px;font-weight:800;color:#4f46e5;"></span>
      </div>
      <div class="buy-modal-pkg-grid">
        <div id="buy-pkg-leads"></div>
        <div id="buy-pkg-tokens"></div>
        <div>ü§ñ IA ativa 24/7</div>
        <div>üìä Relat√≥rios completos</div>
      </div>
    </div>
    <div style="background:#f0fdf4;border:1.5px solid #bbf7d0;border-radius:10px;padding:14px 16px;margin-bottom:12px;">
      <div style="font-weight:700;font-size:13px;color:#16a34a;margin-bottom:6px;">üì≤ Como pagar</div>
      <div style="font-size:12px;color:#374151;line-height:1.7;">
        1. Clique em <strong>Confirmar Pedido</strong> abaixo<br>
        2. Aguarde o contato do administrador com a chave PIX<br>
        3. Ap√≥s confirma√ß√£o do pagamento, os tokens ser√£o adicionados em at√© 2h
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-save" id="btn-confirm-buy" onclick="confirmBuy()">‚úÖ Confirmar Pedido</button>
      <button class="btn-secondary" onclick="closeBuyModal()">Cancelar</button>
    </div>
    <div id="buy-modal-error" class="error-msg" style="margin-top:10px;"></div>
  </div>
</div>

<!-- MODAL ADICIONAR CR√âDITOS (admin) -->
<div class="modal-backdrop" id="modal-add-credits" onclick="if(event.target===this)closeAddCreditsModal()">
  <div class="modal-box">
    <h2>üí∞ Adicionar Cr√©ditos ao Cliente</h2>
    <div class="field-group">
      <label>Cliente</label>
      <div id="add-credits-client-name" style="font-weight:700;font-size:15px;padding:8px 0;"></div>
    </div>
    <div class="field-group">
      <label>Tokens a adicionar</label>
      <input type="number" id="add-credits-tokens" placeholder="Ex: 10000000" min="1000000" step="1000000" />
      <div style="font-size:12px;color:#888;margin-top:4px;">Refer√™ncia: 10M tokens ‚âà 270 leads</div>
    </div>
    <div class="field-group">
      <label>Observa√ß√£o (opcional)</label>
      <input type="text" id="add-credits-obs" placeholder="Ex: Pacote Pro ‚Äî $68" />
    </div>
    <div class="modal-actions">
      <button class="btn-save" id="btn-confirm-add-credits" onclick="confirmAddCredits()">‚úÖ Adicionar Cr√©ditos</button>
      <button class="btn-secondary" onclick="closeAddCreditsModal()">Cancelar</button>
    </div>
    <div id="add-credits-error" class="error-msg" style="margin-top:10px;"></div>
  </div>
</div>

<!-- MODAL CRIAR CLIENTE -->
<div class="modal-backdrop" id="modal-backdrop" onclick="if(event.target===this)closeModal()">
  <div class="modal-box">
    <h2>‚ûï Criar Novo Cliente</h2>
    <div class="field-group">
      <label>Nome do cliente</label>
      <input type="text" id="new-client-name" placeholder="Ex: Escrit√≥rio Pereira" />
    </div>
    <div class="field-group">
      <label>E-mail</label>
      <input type="email" id="new-client-email" placeholder="cliente@email.com" />
    </div>
    <div class="field-group">
      <label>Senha inicial</label>
      <input type="password" id="new-client-password" placeholder="M√≠nimo 6 caracteres" />
    </div>
    <div class="field-group">
      <label>Nome da inst√¢ncia WhatsApp <small style="color:#888;">(sem espa√ßos, ex: EscritorioPereira)</small></label>
      <input type="text" id="new-client-instance" placeholder="EscritorioPereira" />
    </div>
    <div class="modal-actions">
      <button class="btn-save" id="btn-create-client" onclick="createClient()">‚úÖ Criar conta</button>
      <button class="btn-secondary" onclick="closeModal()">Cancelar</button>
    </div>
    <div id="create-client-error" class="error-msg" style="margin-top:10px;text-align:left;"></div>
  </div>
</div>

<script>
  // =====================
  // CONFIGURA√á√ÉO
  // =====================
  const SUPABASE_URL = 'https://vyvdrbkcrvklcaombjqu.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ5dmRyYmtjcnZrbGNhb21ianF1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwNTMzNTgsImV4cCI6MjA4NzYyOTM1OH0.vmIYb6BGgsksaNGN2XPCm6I_mj02NSa49bLWXlTLQeY';
  const MANAGE_CLIENTS_URL = `${SUPABASE_URL}/functions/v1/manage-clients`;
  const N8N_UPLOAD_WEBHOOK = 'https://sx-n8n.yuhqmc.easypanel.host/webhook/upload-pdf-sdr';
  // Evolution API ‚Äî chamadas via Edge Function proxy (chave segura no servidor)
  const EVO_PROXY_URL = `${SUPABASE_URL}/functions/v1/evo-proxy`;

  // Helper: chama Evolution API via proxy autenticado (nunca exp√µe a chave)
  async function evoProxy(action, body = null) {
    const session = (await db.auth.getSession()).data.session;
    if (!session) throw new Error('Sess√£o expirada. Fa√ßa login novamente.');
    const opts = {
      method: body ? 'POST' : 'GET',
      headers: {
        'Authorization': `Bearer ${session.access_token}`,
        'apikey': SUPABASE_KEY,
        ...(body ? { 'Content-Type': 'application/json' } : {})
      },
      ...(body ? { body: JSON.stringify(body) } : {})
    };
    const res = await fetch(`${EVO_PROXY_URL}?action=${action}`, opts);
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || `Erro ${res.status}`);
    return data;
  }

  const { createClient } = supabase;
  const db = createClient(SUPABASE_URL, SUPABASE_KEY);

  let selectedConv = null;
  let allConversations = [];
  let chatRefreshInterval = null;
  let waStatusInterval = null;
  let qrCountdownInterval = null;
  let currentProfile = null; // { id, role, display_name, evo_instance, active }

  // getEvoInstance removido ‚Äî o proxy evo-proxy resolve a inst√¢ncia automaticamente pelo JWT

  // =====================
  // PROMPT PADR√ÉO
  // =====================
  const PROMPT_PADRAO = {
    objetivo: 'Qualificar leads de Direito Previdenci√°rio e encaminhar ao advogado respons√°vel para avalia√ß√£o do caso.',
    prompt_sistema: [
      'Voc√™ √© um assistente especializado em triagem de casos de Direito Previdenci√°rio.',
      'Seu papel √© conversar de forma humanizada, emp√°tica e objetiva com pessoas que buscam ajuda jur√≠dica previdenci√°ria, qualific√°-las e, quando aplic√°vel, encaminhar o caso para um advogado.',
      '',
      'Voc√™ N√ÉO √© advogado e N√ÉO d√° consultoria jur√≠dica. Voc√™ apenas coleta informa√ß√µes para que o advogado respons√°vel possa avaliar o caso.',
      '',
      'FLUXO DA CONVERSA:',
      '',
      'Etapa 1 ‚Äî Recep√ß√£o:',
      'Cumprimente o lead pelo nome (se dispon√≠vel):',
      '"Ol√°! Sou o assistente jur√≠dico do escrit√≥rio. Vou fazer algumas perguntas r√°pidas para entender melhor a sua situa√ß√£o e verificar se podemos te ajudar. Pode ser?"',
      '',
      'Etapa 2 ‚Äî Coleta de informa√ß√µes (fa√ßa UMA pergunta por vez):',
      '1. "Qual √© o seu nome completo?"',
      '2. "Voc√™ contribuiu para o INSS em algum momento da sua vida, ou √© dependente de algu√©m que contribuiu?"',
      '3. "Qual √© a sua situa√ß√£o atual? Por exemplo: benef√≠cio negado, cancelado, aposentadoria que ainda n√£o pediu, pens√£o por morte, aux√≠lio-doen√ßa, BPC/LOAS, ou outro?"',
      '4. "Voc√™ j√° tentou dar entrada no benef√≠cio? Se sim, o que aconteceu?"',
      '5. "Voc√™ tem documentos como carteira de trabalho, extrato do CNIS, carta de indeferimento do INSS ou outros?"',
      '6. "Qual o seu n√∫mero de celular com DDD para o advogado entrar em contato?"',
      '',
      'DESQUALIFICA√á√ÉO IMEDIATA (encerre com empatia se):',
      '- Caso √© trabalhista puro, sem v√≠nculo com INSS',
      '- Caso j√° est√° em andamento com outro advogado',
      '- Pessoa n√£o quer fornecer informa√ß√µes b√°sicas',
      '- Caso j√° foi julgado com tr√¢nsito em julgado sem possibilidade de revis√£o',
      '',
      'BUSCA NA WEB:',
      'Se necess√°rio para identificar a tese jur√≠dica, use a ferramenta de busca.',
      'Priorize fontes: gov.br, previdencia.gov.br, JusBrasil, STJ, TRF.',
      '',
      'FORMATO DE SA√çDA OBRIGAT√ìRIO:',
      'Ao concluir a triagem, inclua NO FINAL da sua √∫ltima mensagem o JSON abaixo:',
      '',
      'Para lead qualificado:',
      '```json',
      '{"qualificado":true,"nome":"Nome Completo","celular":"DDD+n√∫mero","tese":"Tese jur√≠dica identificada","resumo":"Resumo completo da conversa"}',
      '```',
      '',
      'Para lead n√£o qualificado:',
      '```json',
      '{"qualificado":false,"motivo":"Motivo da desqualifica√ß√£o"}',
      '```'
    ].join('\n'),
    tonalidade: 'Emp√°tico, claro e objetivo. Use linguagem simples, sem jarg√£o jur√≠dico. Seja especialmente gentil com idosos ou pessoas em situa√ß√£o vulner√°vel. Se o lead fizer uma pergunta jur√≠dica espec√≠fica, responda de forma gen√©rica e direcione: "Essa √© uma excelente pergunta para o advogado aprofundar com voc√™!"',
    instrucoes_comunicacao: '- Fa√ßa uma pergunta por vez. Aguarde a resposta antes de continuar.\n- Nunca prometa resultado ou vit√≥ria no processo.\n- Nunca d√™ consultoria jur√≠dica.\n- Limite a conversa ao m√°ximo de 10 trocas de mensagens antes de concluir a triagem.\n- Se o lead demorar mais de 24h para responder, envie um lembrete gentil uma √∫nica vez.\n- Se o lead enviar um arquivo (foto, PDF), confirme o recebimento e registre no caso.',
    criterios_qualificacao: '1. V√≠nculo INSS ‚Äî Contribuiu ao INSS ou √© dependente de quem contribuiu\n2. Benef√≠cio identific√°vel ‚Äî Existe um benef√≠cio previdenci√°rio aplic√°vel ao caso\n3. Indeferimento ou pend√™ncia ‚Äî Benef√≠cio foi negado, cancelado ou ainda n√£o foi requerido\n4. Tese jur√≠dica ‚Äî √â poss√≠vel identificar uma tese/fundamento legal para o caso\n5. Documenta√ß√£o m√≠nima ‚Äî Possui ao menos algum documento ou sabe como obt√™-lo',
    msg_qualificado: '√ìtimo! Com base no que voc√™ me contou, acredito que o nosso advogado pode te ajudar. Vou encaminhar as informa√ß√µes do seu caso para ele agora. Em breve ele entrar√° em contato com voc√™. Alguma d√∫vida ou informa√ß√£o adicional que queira que eu repasse?',
    msg_desqualificado: 'Obrigado por entrar em contato! Infelizmente, com base nas informa√ß√µes que voc√™ compartilhou, n√£o identificamos uma situa√ß√£o que se encaixe nos casos que atendemos no momento. Caso sua situa√ß√£o mude ou surja algum documento novo, fique √† vontade para nos contatar novamente. Desejamos tudo de bom para voc√™!',
    numero_destino: ''
  };

  // =====================
  // AUTH
  // =====================
  async function login() {
    const email = document.getElementById('login-email').value;
    const pass  = document.getElementById('login-password').value;
    const btn   = document.getElementById('btn-login');
    const err   = document.getElementById('login-error');
    btn.disabled = true; btn.textContent = 'Entrando...'; err.textContent = '';
    const { error } = await db.auth.signInWithPassword({ email, password: pass });
    if (error) {
      err.textContent = 'E-mail ou senha incorretos.';
      btn.disabled = false; btn.textContent = 'Entrar';
    } else { showDashboard(); }
  }

  async function logout() {
    clearInterval(chatRefreshInterval);
    clearInterval(waStatusInterval);
    await db.auth.signOut();
    document.getElementById('dashboard-page').style.display = 'none';
    document.getElementById('login-page').style.display = 'flex';
  }

  document.getElementById('login-password').addEventListener('keydown', e => {
    if (e.key === 'Enter') login();
  });

  window.addEventListener('load', async () => {
    const { data: { session } } = await db.auth.getSession();
    if (session) showDashboard();
  });

  async function showDashboard() {
    document.getElementById('login-page').style.display = 'none';
    document.getElementById('dashboard-page').style.display = 'block';

    // Carrega perfil do usu√°rio logado
    const { data: { user } } = await db.auth.getUser();
    if (user) {
      const { data: profile } = await db.from('profiles').select('*').eq('id', user.id).single();
      currentProfile = profile;

      // Se admin: exibe menu de clientes
      if (profile?.role === 'admin') {
        document.querySelectorAll('.admin-only').forEach(el => el.classList.add('visible'));
      }

      // Atualiza nome/inst√¢ncia na sidebar
      const instEl = document.getElementById('wa-instance-display');
      if (instEl) instEl.textContent = currentProfile?.evo_instance || 'N√£o configurada';
      const nameEl = document.getElementById('sidebar-user-name');
      if (nameEl) nameEl.textContent = profile?.display_name || user.email;
      const roleEl = document.getElementById('sidebar-user-role');
      if (roleEl) roleEl.textContent = profile?.role === 'admin' ? 'üîë Super Admin' : 'üë§ Cliente';
    }

    loadConfigs(); loadStats(); loadOverviewLeads(); loadPDFList();
    loadCredits(); // verifica saldo e dispara alerta se necess√°rio
    checkWAStatus();
    waStatusInterval = setInterval(checkWAStatus, 15000);
  }

  // =====================
  // NAVEGA√á√ÉO
  // =====================
  function showPage(name, el) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById('page-' + name).classList.add('active');
    el.classList.add('active');
    if (name === 'leads') loadLeads();
    if (name === 'crm') loadCRM();
    if (name === 'clientes') { loadClients(); loadTokenUsageAdmin(); }
    if (name === 'faturamento') {
      loadBilling();
      loadCredits();
      if (currentProfile?.role === 'admin') {
        document.getElementById('billing-admin-card').classList.add('visible');
        document.getElementById('admin-pedidos-card').classList.add('visible');
        loadAdminBilling();
        loadAdminPedidos();
      }
    }
    if (name === 'fluxos') {
      setTimeout(() => { initDrawflow(); loadSavedFlows(); }, 100);
    }
    if (name === 'batepapo') {
      loadConversations();
      clearInterval(chatRefreshInterval);
      chatRefreshInterval = setInterval(loadConversations, 5000);
    } else {
      clearInterval(chatRefreshInterval);
    }
  }

  // =====================
  // WHATSAPP ‚Äî QR CODE
  // =====================
  async function checkWAStatus() {
    const bar = document.getElementById('wa-status-bar');
    const txt = document.getElementById('wa-status-text');
    const dot = document.getElementById('nav-wa-dot');
    const btnDesc = document.getElementById('btn-desconectar');
    try {
      const data = await evoProxy('status');
      const state = data?.instance?.state || data?.state || 'close';
      if (state === 'open') {
        bar.className = 'wa-status-bar connected';
        txt.textContent = 'üü¢ WhatsApp Conectado ‚Äî Agente ativo e recebendo mensagens';
        dot.className = 'badge-dot online';
        btnDesc.style.display = 'inline-block';
        document.getElementById('btn-gerar-qr').style.display = 'none';
      } else {
        bar.className = 'wa-status-bar disconnected';
        txt.textContent = 'üî¥ WhatsApp Desconectado ‚Äî Gere o QR Code para conectar';
        dot.className = 'badge-dot offline';
        btnDesc.style.display = 'none';
        document.getElementById('btn-gerar-qr').style.display = 'flex';
      }
    } catch (e) {
      bar.className = 'wa-status-bar connecting';
      txt.textContent = 'üü° N√£o foi poss√≠vel verificar o status';
    }
  }

  async function generateQR() {
    const btn = document.getElementById('btn-gerar-qr');
    const placeholder = document.getElementById('qr-placeholder');
    const img = document.getElementById('qr-image');
    const timer = document.getElementById('qr-timer');
    btn.disabled = true; btn.innerHTML = '<span>‚è≥</span> Gerando...';
    try {
      const data = await evoProxy('connect');
      const base64 = data?.base64 || data?.qrcode?.base64 || data?.code;
      if (base64) {
        placeholder.style.display = 'none';
        img.src = base64.startsWith('data:') ? base64 : `data:image/png;base64,${base64}`;
        img.style.display = 'block';
        timer.style.display = 'block';
        startQRCountdown();
        // Verifica se conectou
        setTimeout(checkWAStatus, 5000);
        const watchInterval = setInterval(async () => {
          await checkWAStatus();
          const state = document.getElementById('wa-status-bar').className;
          if (state.includes('connected')) {
            clearInterval(watchInterval);
            img.style.display = 'none';
            placeholder.style.display = 'flex';
            timer.style.display = 'none';
          }
        }, 3000);
      } else {
        alert('N√£o foi poss√≠vel gerar o QR Code. Verifique se o n8n e a Evolution API est√£o ativos.');
      }
    } catch (e) {
      alert('Erro ao conectar com a Evolution API: ' + e.message);
    }
    btn.disabled = false; btn.innerHTML = '<span>üîÑ</span> Novo QR Code';
  }

  function startQRCountdown() {
    clearInterval(qrCountdownInterval);
    let secs = 60;
    document.getElementById('qr-countdown').textContent = secs;
    qrCountdownInterval = setInterval(() => {
      secs--;
      document.getElementById('qr-countdown').textContent = secs;
      if (secs <= 0) {
        clearInterval(qrCountdownInterval);
        document.getElementById('qr-timer').style.display = 'none';
        document.getElementById('qr-image').style.display = 'none';
        document.getElementById('qr-placeholder').style.display = 'flex';
        document.getElementById('btn-gerar-qr').innerHTML = '<span>üì∑</span> Gerar QR Code';
      }
    }, 1000);
  }

  async function disconnectWA() {
    if (!confirm('Deseja desconectar o WhatsApp? O agente para de responder.')) return;
    try {
      await evoProxy('logout');
      setTimeout(checkWAStatus, 1000);
    } catch(e) { alert('Erro ao desconectar: ' + e.message); }
  }

  // =====================
  // BATE-PAPO AO VIVO
  // =====================
  async function loadConversations() {
    const { data } = await db.from('sessoes')
      .select('*').order('atualizado_em', { ascending: false });
    allConversations = data || [];
    document.getElementById('conv-count').textContent = allConversations.length + ' conversa(s)';
    renderConvList(allConversations);
    if (selectedConv) {
      const updated = allConversations.find(c => c.numero_whatsapp === selectedConv);
      if (updated) renderMessages(updated);
    }
  }

  function renderConvList(convs) {
    const el = document.getElementById('conv-list');
    if (!convs.length) {
      el.innerHTML = '<div class="empty-state" style="padding:32px 16px;"><div style="font-size:32px;margin-bottom:8px;">üì≠</div><div style="font-size:13px;">Nenhuma conversa ativa</div></div>';
      return;
    }
    el.innerHTML = convs.map(c => {
      const hist = parseHistory(c.historico);
      const last = hist.length ? hist[hist.length - 1] : null;
      const preview = last ? (last.content || '').slice(0, 50) : 'Sem mensagens';
      const time = c.atualizado_em ? timeAgo(c.atualizado_em) : '';
      const num = c.numero_whatsapp || '‚Äî';
      const initials = num.replace(/\D/g,'').slice(-4).slice(0,2) || '??';
      const isActive = selectedConv === c.numero_whatsapp;
      const pausedTag = c.agente_pausado ? ' <span style="font-size:10px;background:#fef9c3;color:#92400e;padding:1px 5px;border-radius:4px;">‚è∏</span>' : '';
      return `<div class="conv-item ${isActive ? 'active' : ''}" onclick="selectConv('${c.numero_whatsapp}')">
        <div class="conv-name">
          <span>${formatPhone(num)}${pausedTag}</span>
          <span class="conv-time">${time}</span>
        </div>
        <div class="conv-preview">${preview}</div>
      </div>`;
    }).join('');
  }

  function filterConversations(query) {
    if (!query) { renderConvList(allConversations); return; }
    const filtered = allConversations.filter(c =>
      (c.numero_whatsapp || '').includes(query)
    );
    renderConvList(filtered);
  }

  function selectConv(numero) {
    selectedConv = numero;
    const conv = allConversations.find(c => c.numero_whatsapp === numero);
    if (!conv) return;
    document.getElementById('chat-placeholder').style.display = 'none';
    const activeEl = document.getElementById('chat-active');
    activeEl.style.display = 'flex';
    const initials = numero.replace(/\D/g,'').slice(-4).slice(0,2) || '??';
    document.getElementById('chat-avatar').textContent = initials;
    document.getElementById('chat-number').textContent = formatPhone(numero);
    document.getElementById('chat-last-seen').textContent = conv.atualizado_em
      ? '√öltima atividade: ' + new Date(conv.atualizado_em).toLocaleString('pt-BR')
      : 'Sess√£o ativa';
    // Atualiza banner e bot√£o de pausa
    updateAgentePausadoUI(conv.agente_pausado);
    renderMessages(conv);
    renderConvList(allConversations);
  }

  function updateAgentePausadoUI(pausado) {
    const banner = document.getElementById('agente-pausado-banner');
    const btn    = document.getElementById('btn-toggle-agente');
    if (pausado) {
      banner.style.display = 'block';
      btn.textContent = '‚ñ∂ Reativar Agente';
      btn.style.background = '#dcfce7'; btn.style.color = '#16a34a'; btn.style.borderColor = '#bbf7d0';
    } else {
      banner.style.display = 'none';
      btn.textContent = '‚è∏ Pausar Agente';
      btn.style.background = ''; btn.style.color = ''; btn.style.borderColor = '';
    }
  }

  async function toggleAgente() {
    if (!selectedConv) return;
    const conv = allConversations.find(c => c.numero_whatsapp === selectedConv);
    if (!conv) return;
    const novoPausa = !conv.agente_pausado;
    await db.from('sessoes')
      .update({ agente_pausado: novoPausa, pausado_em: novoPausa ? new Date().toISOString() : null })
      .eq('numero_whatsapp', selectedConv)
      .eq('user_id', currentProfile?.id);
    conv.agente_pausado = novoPausa;
    updateAgentePausadoUI(novoPausa);
  }

  function renderMessages(conv) {
    const hist = parseHistory(conv.historico);
    const el = document.getElementById('messages-area');
    if (!hist.length) {
      el.innerHTML = '<div class="empty-state"><div style="font-size:28px">üí¨</div><p>Nenhuma mensagem ainda</p></div>';
      return;
    }
    el.innerHTML = hist.map(msg => {
      const isUser = msg.role === 'user';
      const isAudio = msg.type === 'audio';
      const audioTag = isAudio
        ? `<div class="msg-audio-tag">${isUser ? 'üé§ √Åudio transcrito' : 'üîä Resposta em √°udio'}</div>`
        : '';
      return `<div class="msg-row ${isUser ? 'user' : 'assistant'}">
        <div class="msg-bubble">${audioTag}${escapeHtml(msg.content || '')}</div>
      </div>`;
    }).join('');
    el.scrollTop = el.scrollHeight;
    const hist_len = hist.length;
    const lastRole = hist.length ? hist[hist.length-1].role : '';
    const statusBadge = document.getElementById('chat-status-badge');
    if (lastRole === 'assistant') {
      statusBadge.className = 'badge badge-blue'; statusBadge.textContent = 'ü§ñ Aguardando lead';
    } else {
      statusBadge.className = 'badge badge-yellow'; statusBadge.textContent = '‚è≥ Processando';
    }
  }

  async function sendManualMessage() {
    if (!selectedConv) return;
    const input = document.getElementById('chat-input');
    const msg = input.value.trim();
    if (!msg) return;
    const btn = document.getElementById('btn-send');
    btn.disabled = true; input.value = ''; input.style.height = 'auto';
    try {
      await evoProxy('send-text', { number: selectedConv, text: msg });
      // Atualiza hist√≥rico local
      await loadConversations();
    } catch(e) {
      alert('Erro ao enviar mensagem: ' + e.message);
    }
    btn.disabled = false;
  }

  async function clearSession() {
    if (!selectedConv) return;
    if (!confirm(`Reiniciar a conversa com ${formatPhone(selectedConv)}? O hist√≥rico ser√° apagado.`)) return;
    await db.from('sessoes').delete().eq('numero_whatsapp', selectedConv).eq('user_id', currentProfile.id);
    selectedConv = null;
    document.getElementById('chat-placeholder').style.display = 'flex';
    document.getElementById('chat-active').style.display = 'none';
    loadConversations();
  }

  function parseHistory(hist) {
    if (!hist) return [];
    try {
      const parsed = typeof hist === 'string' ? JSON.parse(hist) : hist;
      if (Array.isArray(parsed)) return parsed.filter(m => m.role && m.content);
      return [];
    } catch { return []; }
  }

  function formatPhone(num) {
    const n = (num || '').replace(/\D/g,'');
    if (n.length >= 12) return `+${n.slice(0,2)} (${n.slice(2,4)}) ${n.slice(4,9)}-${n.slice(9)}`;
    return num;
  }

  function timeAgo(ts) {
    const diff = Math.floor((Date.now() - new Date(ts)) / 1000);
    if (diff < 60) return 'agora';
    if (diff < 3600) return Math.floor(diff/60) + 'min';
    if (diff < 86400) return Math.floor(diff/3600) + 'h';
    return Math.floor(diff/86400) + 'd';
  }

  function escapeHtml(str) {
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
  }

  // =====================
  // CRM KANBAN
  // =====================
  const CRM_STAGES = [
    { id: 'novo_contato',    label: 'üÜï Novo Contato',      color: '#f59e0b' },
    { id: 'em_atendimento',  label: 'üí¨ Em Atendimento',    color: '#3b82f6' },
    { id: 'qualificado',     label: '‚úÖ Qualificado',        color: '#16a34a' },
    { id: 'nao_qualificado', label: '‚ùå N√£o Qualificado',   color: '#dc2626' },
    { id: 'convertido',      label: 'üéâ Convertido',         color: '#7c3aed' },
    { id: 'perdido',         label: 'üö™ Perdido',            color: '#9ca3af' }
  ];

  let crmLeads = [];
  let crmStages = [...CRM_STAGES];
  let crmOpenLeadId = null;

  async function loadCRM() {
    const board = document.getElementById('crm-board');
    board.innerHTML = '<div style="padding:40px;color:#aaa;font-size:14px;">Carregando...</div>';
    await loadCRMStages();
    const { data, error } = await db.from('leads')
      .select('*, lead_tarefas(id, concluida)')
      .order('atualizado_em', { ascending: false });
    if (error || !data) { board.innerHTML = '<div style="padding:40px;color:#ef4444;">Erro ao carregar CRM</div>'; return; }
    crmLeads = data;
    renderKanban(data);
  }

  function renderKanban(leads) {
    const board = document.getElementById('crm-board');
    const byStage = {};
    crmStages.forEach(s => byStage[s.id] = []);
    leads.forEach(l => {
      const s = l.stage || crmStages[0]?.id || 'novo_contato';
      if (!byStage[s]) byStage[crmStages[0]?.id || 'novo_contato'].push(l);
      else byStage[s].push(l);
    });
    board.innerHTML = crmStages.map(stage => {
      const cols = byStage[stage.id] || [];
      return `<div class="crm-col" data-stage="${stage.id}" style="border-top:3px solid ${stage.color};">
        <div class="crm-col-header">
          <span class="crm-col-title">${stage.label}</span>
          <span class="crm-col-count">${cols.length}</span>
        </div>
        <div class="crm-cards" data-stage="${stage.id}"
          ondragover="event.preventDefault();this.classList.add('dragover')"
          ondragleave="this.classList.remove('dragover')"
          ondrop="dropCard(event,this)">
          ${cols.map(l => renderCard(l, stage.color)).join('')}
        </div>
      </div>`;
    }).join('');
  }

  function renderCard(lead, stageColor) {
    const tasks = lead.lead_tarefas || [];
    const pendentes = tasks.filter(t => !t.concluida).length;
    const hoje = new Date(); hoje.setHours(0,0,0,0);
    let anivIcon = '';
    if (lead.data_aniversario) {
      const aniv = new Date(lead.data_aniversario + 'T00:00:00');
      aniv.setFullYear(hoje.getFullYear());
      const diff = Math.round((aniv - hoje) / 86400000);
      if (diff === 0) anivIcon = '<span class="crm-card-aniv" title="Anivers√°rio hoje! üéÇ">üéÇ</span>';
      else if (diff === 1) anivIcon = '<span class="crm-card-aniv" title="Anivers√°rio amanh√£">üéÅ</span>';
    }
    const stg = lead.stage || crmStages[0]?.id || 'novo_contato';
    const color = stageColor || crmStages.find(s => s.id === stg)?.color || '#e5e7eb';
    return `<div class="crm-card" data-lead-id="${lead.id}" data-stage="${stg}"
      style="border-left-color:${color};"
      draggable="true"
      ondragstart="dragCard(event,this)"
      onclick="openLeadModal(${lead.id})">
      <div class="crm-card-top">
        <span class="crm-card-name">${escapeHtml(lead.nome || lead.numero_whatsapp || '‚Äî')}</span>
        ${anivIcon}
      </div>
      ${lead.tese ? `<div class="crm-card-tese">${escapeHtml(lead.tese)}</div>` : ''}
      ${lead.assunto ? `<div class="crm-card-assunto">${escapeHtml(lead.assunto)}</div>` : ''}
      <div class="crm-card-footer">
        <span class="crm-card-tasks ${pendentes > 0 ? 'has-pending' : ''}">
          ${pendentes > 0 ? `üìã ${pendentes} tarefa${pendentes>1?'s':''} pendente${pendentes>1?'s':''}` : tasks.length > 0 ? `‚úÖ ${tasks.length} tarefa${tasks.length>1?'s':''}` : ''}
        </span>
        <span class="crm-card-date">${lead.atualizado_em ? timeAgo(lead.atualizado_em) : '‚Äî'}</span>
      </div>
    </div>`;
  }

  // ---- Drag & Drop ----
  let dragLeadId = null;
  function dragCard(event, el) {
    dragLeadId = el.dataset.leadId;
    event.dataTransfer.effectAllowed = 'move';
  }
  async function dropCard(event, dropZone) {
    event.preventDefault();
    dropZone.classList.remove('dragover');
    if (!dragLeadId) return;
    const newStage = dropZone.dataset.stage;
    const card = document.querySelector(`.crm-card[data-lead-id="${dragLeadId}"]`);
    if (card) { card.dataset.stage = newStage; dropZone.appendChild(card); }
    await updateLeadStage(dragLeadId, newStage);
    dragLeadId = null;
    // Atualiza contador das colunas
    crmStages.forEach(s => {
      const col = document.querySelector(`.crm-col[data-stage="${s.id}"]`);
      if (col) col.querySelector('.crm-col-count').textContent = col.querySelectorAll('.crm-card').length;
    });
  }
  async function updateLeadStage(leadId, stage) {
    await db.from('leads').update({ stage, atualizado_em: new Date().toISOString() }).eq('id', leadId);
    const l = crmLeads.find(x => String(x.id) === String(leadId));
    if (l) l.stage = stage;
  }

  // ---- Modal de detalhes ----
  async function openLeadModal(leadId) {
    crmOpenLeadId = leadId;
    const lead = crmLeads.find(x => x.id === leadId) || {};
    document.getElementById('crm-lead-id').value = leadId;
    document.getElementById('crm-lead-numero').value = lead.numero_whatsapp || '';
    document.getElementById('crm-modal-title').textContent = lead.nome || lead.numero_whatsapp || 'Lead';
    document.getElementById('crm-nome').value = lead.nome || '';
    document.getElementById('crm-celular').value = lead.celular || '';
    document.getElementById('crm-tese').value = lead.tese || '';
    document.getElementById('crm-assunto').value = lead.assunto || '';
    document.getElementById('crm-aniversario').value = lead.data_aniversario || '';
    // Popula select de est√°gio dinamicamente
    const stgSel = document.getElementById('crm-stage');
    stgSel.innerHTML = crmStages.map(s => `<option value="${s.id}">${s.label}</option>`).join('');
    stgSel.value = lead.stage || crmStages[0]?.id || 'novo_contato';
    document.getElementById('crm-resumo').value = lead.resumo || '';
    document.getElementById('crm-notas').value = lead.notas || '';
    switchCRMTab('dados', document.querySelector('.crm-tab'));
    document.getElementById('modal-crm-lead').classList.add('open');
    await loadTarefas(leadId);
  }

  function closeCRMModal() {
    document.getElementById('modal-crm-lead').classList.remove('open');
    crmOpenLeadId = null;
  }

  function switchCRMTab(tab, el) {
    document.querySelectorAll('.crm-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.crm-tab-content').forEach(t => t.classList.remove('active'));
    if (el) el.classList.add('active');
    else { const tabs = document.querySelectorAll('.crm-tab'); if(tabs.length) tabs[0].classList.add('active'); }
    document.getElementById('crm-tab-' + tab).classList.add('active');
  }

  async function saveLeadDetails() {
    const id = crmOpenLeadId;
    if (!id) return;
    const st = document.getElementById('crm-save-status');
    st.textContent = 'Salvando...'; st.style.color = '#888';
    await db.from('leads').update({
      nome: document.getElementById('crm-nome').value,
      celular: document.getElementById('crm-celular').value,
      tese: document.getElementById('crm-tese').value,
      assunto: document.getElementById('crm-assunto').value,
      data_aniversario: document.getElementById('crm-aniversario').value || null,
      stage: document.getElementById('crm-stage').value,
      resumo: document.getElementById('crm-resumo').value,
      atualizado_em: new Date().toISOString()
    }).eq('id', id);
    st.textContent = '‚úÖ Salvo!'; st.style.color = '#16a34a';
    setTimeout(() => st.textContent = '', 3000);
    // Atualiza local e re-renderiza card
    const lead = crmLeads.find(x => x.id === id);
    if (lead) {
      lead.nome = document.getElementById('crm-nome').value;
      lead.tese = document.getElementById('crm-tese').value;
      lead.assunto = document.getElementById('crm-assunto').value;
      lead.stage = document.getElementById('crm-stage').value;
      lead.data_aniversario = document.getElementById('crm-aniversario').value || null;
      const card = document.querySelector(`.crm-card[data-lead-id="${id}"]`);
      if (card) {
        card.outerHTML = renderCard(lead);
      }
      document.getElementById('crm-modal-title').textContent = lead.nome || lead.numero_whatsapp || 'Lead';
    }
  }

  async function saveLeadNotas() {
    const id = crmOpenLeadId; if (!id) return;
    const st = document.getElementById('crm-notas-status');
    st.textContent = 'Salvando...'; st.style.color = '#888';
    await db.from('leads').update({ notas: document.getElementById('crm-notas').value, atualizado_em: new Date().toISOString() }).eq('id', id);
    st.textContent = '‚úÖ Salvo!'; st.style.color = '#16a34a';
    setTimeout(() => st.textContent = '', 2500);
  }

  // ---- Tarefas ----
  async function loadTarefas(leadId) {
    const { data } = await db.from('lead_tarefas').select('*').eq('lead_id', leadId).order('criado_em');
    renderTarefas(data || []);
    // Atualiza count no lead local
    const lead = crmLeads.find(x => x.id === leadId);
    if (lead) lead.lead_tarefas = data || [];
  }

  function renderTarefas(tarefas) {
    const el = document.getElementById('crm-tarefas-list');
    if (!tarefas.length) { el.innerHTML = '<div style="color:#aaa;font-size:13px;padding:8px 0;">Nenhuma tarefa ainda. Adicione abaixo.</div>'; return; }
    el.innerHTML = tarefas.map(t => `<div class="tarefa-item" data-tarefa-id="${t.id}">
      <input type="checkbox" ${t.concluida?'checked':''} onchange="toggleTarefa('${t.id}',this.checked)" />
      <span class="tarefa-desc ${t.concluida?'done':''}">${escapeHtml(t.descricao)}</span>
      ${t.data_vencimento ? `<span class="tarefa-date">üìÖ ${new Date(t.data_vencimento+'T00:00:00').toLocaleDateString('pt-BR')}</span>` : ''}
      <button class="tarefa-del" onclick="deleteTarefa('${t.id}')" title="Excluir">‚úï</button>
    </div>`).join('');
  }

  async function addTarefa() {
    const desc = document.getElementById('nova-tarefa-desc').value.trim();
    if (!desc || !crmOpenLeadId) return;
    const { data: { user } } = await db.auth.getUser();
    const dataVenc = document.getElementById('nova-tarefa-data').value || null;
    await db.from('lead_tarefas').insert({ lead_id: crmOpenLeadId, user_id: user.id, descricao: desc, data_vencimento: dataVenc });
    document.getElementById('nova-tarefa-desc').value = '';
    document.getElementById('nova-tarefa-data').value = '';
    await loadTarefas(crmOpenLeadId);
  }

  async function toggleTarefa(tarefaId, concluida) {
    await db.from('lead_tarefas').update({ concluida }).eq('id', tarefaId);
    const el = document.querySelector(`.tarefa-item[data-tarefa-id="${tarefaId}"] .tarefa-desc`);
    if (el) el.classList.toggle('done', concluida);
    await loadTarefas(crmOpenLeadId);
  }

  async function deleteTarefa(tarefaId) {
    await db.from('lead_tarefas').delete().eq('id', tarefaId);
    await loadTarefas(crmOpenLeadId);
  }

  // ---- Entrar na conversa (pausa agente) ----
  async function entrarNaConversa() {
    const numero = document.getElementById('crm-lead-numero').value;
    if (!numero) { alert('Este lead n√£o tem n√∫mero de WhatsApp registrado.'); return; }
    closeCRMModal();
    // Navega para Bate-Papo
    const navBatepapo = document.querySelector('.nav-item[onclick*="batepapo"]');
    showPage('batepapo', navBatepapo);
    // Espera carregar e seleciona a conversa
    setTimeout(async () => {
      await loadConversations();
      setTimeout(async () => {
        selectConv(numero);
        // Pausa o agente automaticamente
        const { data: conv } = await db.from('sessoes').select('agente_pausado').eq('numero_whatsapp', numero).eq('user_id', currentProfile?.id).single();
        if (conv && !conv.agente_pausado) {
          await db.from('sessoes').update({ agente_pausado: true, pausado_em: new Date().toISOString() }).eq('numero_whatsapp', numero).eq('user_id', currentProfile?.id);
          updateAgentePausadoUI(true);
        }
      }, 600);
    }, 400);
  }

  // ---- Novo lead manual ----
  function openNewLeadModal() { document.getElementById('modal-novo-lead').classList.add('open'); }
  function closeNewLeadModal() { document.getElementById('modal-novo-lead').classList.remove('open'); }

  async function createManualLead() {
    const numero = document.getElementById('nl-numero').value.replace(/\D/g,'');
    const nome   = document.getElementById('nl-nome').value.trim();
    const assunto = document.getElementById('nl-assunto').value.trim();
    if (!numero) { alert('Informe o n√∫mero de WhatsApp'); return; }
    const { data: { user } } = await db.auth.getUser();
    await db.from('leads').insert({ numero_whatsapp: numero, nome, assunto, user_id: user.id, stage: 'novo_contato', atualizado_em: new Date().toISOString() });
    closeNewLeadModal();
    document.getElementById('nl-nome').value = '';
    document.getElementById('nl-numero').value = '';
    document.getElementById('nl-assunto').value = '';
    await loadCRM();
  }

  // =====================
  // GERENCIAR COLUNAS CRM
  // =====================
  const STAGE_COLORS = [
    '#f59e0b','#3b82f6','#16a34a','#dc2626','#7c3aed','#9ca3af',
    '#f97316','#ec4899','#06b6d4','#84cc16','#64748b','#8b5cf6',
    '#0891b2','#b45309','#15803d','#be123c'
  ];
  let stagesDragSrc = null;
  let colorPaletteTarget = null;

  async function loadCRMStages() {
    try {
      const { data } = await db.from('agente_config')
        .select('valor').eq('chave','crm_stages').maybeSingle();
      if (data?.valor) {
        const parsed = JSON.parse(data.valor);
        if (Array.isArray(parsed) && parsed.length) { crmStages = parsed; return crmStages; }
      }
    } catch {}
    crmStages = [...CRM_STAGES];
    return crmStages;
  }

  async function openStagesModal() {
    await loadCRMStages();
    renderStagesList();
    document.getElementById('stages-save-status').textContent = '';
    document.getElementById('modal-gerenciar-colunas').classList.add('open');
  }

  function closeStagesModal() {
    document.getElementById('modal-gerenciar-colunas').classList.remove('open');
    hideColorPalette();
  }

  function renderStagesList() {
    const list = document.getElementById('stages-list');
    list.innerHTML = crmStages.map((s, i) => `
      <div class="stage-row" data-idx="${i}"
        draggable="true"
        ondragstart="stageRowDragStart(event,this)"
        ondragover="stageRowDragOver(event,this)"
        ondragleave="this.classList.remove('drag-over')"
        ondrop="stageRowDrop(event,this)"
        ondragend="stageRowDragEnd(this)">
        <span class="stage-drag-handle" title="Arrastar para reordenar">‚†ø</span>
        <span class="stage-color-dot" style="background:${s.color};" onclick="showColorPalette(event,${i})" title="Trocar cor"></span>
        <input class="stage-name-input" type="text" value="${s.label.replace(/"/g,'&quot;')}" placeholder="Nome da coluna" />
        <button class="stage-del-btn" onclick="deleteStageRow(${i})" title="Remover coluna">‚úï</button>
      </div>`).join('');
  }

  function stageRowDragStart(e, el) {
    stagesDragSrc = el;
    e.dataTransfer.effectAllowed = 'move';
    setTimeout(() => el.style.opacity = '0.45', 0);
  }
  function stageRowDragOver(e, el) {
    e.preventDefault();
    document.querySelectorAll('.stage-row').forEach(r => r.classList.remove('drag-over'));
    if (el !== stagesDragSrc) el.classList.add('drag-over');
  }
  function stageRowDragEnd(el) {
    el.style.opacity = '';
    document.querySelectorAll('.stage-row').forEach(r => r.classList.remove('drag-over'));
  }
  function stageRowDrop(e, el) {
    e.stopPropagation();
    el.classList.remove('drag-over');
    if (!stagesDragSrc || stagesDragSrc === el) { stagesDragSrc = null; return; }
    // L√™ labels atuais antes de reordenar
    syncStageLabelsFromDOM();
    const list = document.getElementById('stages-list');
    const rows = [...list.querySelectorAll('.stage-row')];
    const srcIdx = rows.indexOf(stagesDragSrc);
    const dstIdx = rows.indexOf(el);
    if (srcIdx < 0 || dstIdx < 0) { stagesDragSrc = null; return; }
    const [moved] = crmStages.splice(srcIdx, 1);
    crmStages.splice(dstIdx, 0, moved);
    stagesDragSrc.style.opacity = '';
    stagesDragSrc = null;
    renderStagesList();
  }

  function syncStageLabelsFromDOM() {
    const inputs = document.querySelectorAll('#stages-list .stage-name-input');
    inputs.forEach((inp, i) => { if (crmStages[i]) crmStages[i].label = inp.value.trim() || crmStages[i].label; });
  }

  function addNewStage() {
    syncStageLabelsFromDOM();
    crmStages.push({ id: 'custom_' + Date.now(), label: 'Nova coluna', color: '#64748b' });
    renderStagesList();
    setTimeout(() => {
      const inputs = document.querySelectorAll('#stages-list .stage-name-input');
      if (inputs.length) { const last = inputs[inputs.length - 1]; last.focus(); last.select(); }
    }, 50);
  }

  function deleteStageRow(idx) {
    if (crmStages.length <= 1) { alert('Mantenha ao menos uma coluna.'); return; }
    syncStageLabelsFromDOM();
    crmStages.splice(idx, 1);
    renderStagesList();
  }

  async function saveCRMStages() {
    syncStageLabelsFromDOM();
    const st = document.getElementById('stages-save-status');
    st.textContent = 'Salvando...'; st.style.color = '#888';
    const { data: { user } } = await db.auth.getUser();
    const { error } = await db.from('agente_config').upsert(
      { user_id: user.id, chave: 'crm_stages', valor: JSON.stringify(crmStages) },
      { onConflict: 'user_id,chave' }
    );
    if (error) { st.textContent = '‚ùå Erro ao salvar'; st.style.color = '#ef4444'; return; }
    st.textContent = '‚úÖ Colunas salvas!'; st.style.color = '#16a34a';
    setTimeout(() => { closeStagesModal(); renderKanban(crmLeads); }, 900);
  }

  // ---- Color palette ----
  function showColorPalette(e, stageIdx) {
    e.stopPropagation();
    colorPaletteTarget = stageIdx;
    const popup = document.getElementById('color-palette-popup');
    popup.innerHTML = STAGE_COLORS.map(c =>
      `<span class="color-swatch ${crmStages[stageIdx]?.color===c?'selected':''}"
        style="background:${c};" onclick="pickStageColor('${c}')"></span>`
    ).join('');
    // Posi√ß√£o relativa ao modal-box
    const dot = e.currentTarget;
    const dotRect = dot.getBoundingClientRect();
    const mbox = document.querySelector('#modal-gerenciar-colunas .modal-box');
    const mRect = mbox.getBoundingClientRect();
    popup.style.display = 'flex';
    popup.style.top  = (dotRect.bottom - mRect.top + 6) + 'px';
    popup.style.left = (dotRect.left   - mRect.left) + 'px';
    popup.style.position = 'absolute';
    setTimeout(() => document.addEventListener('click', hideColorPaletteOutside, { once: true }), 30);
  }

  function pickStageColor(color) {
    if (colorPaletteTarget !== null && crmStages[colorPaletteTarget]) {
      crmStages[colorPaletteTarget].color = color;
      renderStagesList();
    }
    hideColorPalette();
  }

  function hideColorPalette() {
    const p = document.getElementById('color-palette-popup');
    if (p) p.style.display = 'none';
    colorPaletteTarget = null;
  }
  function hideColorPaletteOutside() { hideColorPalette(); }

  // =====================
  // CONFIGURA√á√ïES
  // =====================
  async function loadConfigs() {
    // Aplica defaults primeiro (garante campos preenchidos na primeira vez)
    Object.entries(PROMPT_PADRAO).forEach(([chave, valor]) => {
      const el = document.getElementById('cfg-' + chave);
      if (el) el.value = valor;
    });
    // Sobrescreve com valores salvos no Supabase
    const { data } = await db.from('agente_config').select('chave, valor');
    if (!data) return;
    data.forEach(row => {
      const el = document.getElementById('cfg-' + row.chave);
      if (!el) return;
      if (el.type === 'checkbox') {
        el.checked = row.valor === 'true' || row.valor === true;
      } else if (row.valor) {
        el.value = row.valor;
      }
    });
  }

  function restaurarPadrao() {
    if (!confirm('Restaurar todos os prompts para o padr√£o? Os valores atuais ser√£o substitu√≠dos (somente na tela ‚Äî salve para confirmar).')) return;
    Object.entries(PROMPT_PADRAO).forEach(([chave, valor]) => {
      const el = document.getElementById('cfg-' + chave);
      if (el) el.value = valor;
    });
  }

  async function saveConfigs(keys) {
    const statusId = keys.includes('prompt_sistema') ? 'save-agente'
      : keys.includes('tonalidade') ? 'save-comunicacao' : 'save-qualificacao';
    const statusEl = document.getElementById(statusId);
    statusEl.textContent = 'Salvando...'; statusEl.style.color = '#888';
    const { data: { user } } = await db.auth.getUser();
    for (const key of keys) {
      const el = document.getElementById('cfg-' + key);
      if (!el) continue;
      const valor = el.type === 'checkbox' ? String(el.checked) : el.value;
      await db.from('agente_config').upsert(
        { chave: key, valor, user_id: user.id, atualizado_em: new Date().toISOString() },
        { onConflict: 'user_id,chave' }
      );
    }
    statusEl.textContent = '‚úÖ Salvo!'; statusEl.style.color = '#16a34a';
    setTimeout(() => statusEl.textContent = '', 3000);
  }

  // =====================
  // STATS + LEADS
  // =====================
  async function loadStats() {
    const { data } = await db.from('leads').select('qualificado');
    if (!data) return;
    const total = data.length;
    const qual  = data.filter(l => l.qualificado).length;
    const taxa  = total > 0 ? Math.round((qual/total)*100)+'%' : '0%';
    document.getElementById('stat-total').textContent = total;
    document.getElementById('stat-qual').textContent = qual;
    document.getElementById('stat-taxa').textContent = taxa;
  }

  async function loadOverviewLeads() {
    const { data } = await db.from('leads').select('*').order('criado_em', { ascending: false }).limit(5);
    const el = document.getElementById('overview-leads');
    if (!data || !data.length) {
      el.innerHTML = '<p class="empty-state">Nenhum lead ainda.</p>'; return;
    }
    el.innerHTML = renderLeadsTable(data);
  }

  async function loadLeads() {
    const { data } = await db.from('leads').select('*').order('criado_em', { ascending: false });
    const el = document.getElementById('leads-table');
    if (!data || !data.length) {
      el.innerHTML = '<p class="empty-state">Nenhum lead registrado ainda.</p>'; return;
    }
    el.innerHTML = renderLeadsTable(data);
  }

  function renderLeadsTable(data) {
    return `<table><thead><tr>
      <th>Data</th><th>Nome</th><th>Celular</th><th>Tese</th><th>Status</th>
    </tr></thead><tbody>${data.map(l => `<tr>
      <td>${l.criado_em ? new Date(l.criado_em).toLocaleString('pt-BR') : '‚Äî'}</td>
      <td>${l.nome || l.numero_whatsapp || '‚Äî'}</td>
      <td>${l.celular || '‚Äî'}</td>
      <td style="max-width:280px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${l.tese || l.resumo || '‚Äî'}</td>
      <td><span class="badge ${l.qualificado ? 'badge-green' : 'badge-red'}">${l.qualificado ? '‚úÖ Qualificado' : '‚ùå N√£o qualificado'}</span></td>
    </tr>`).join('')}</tbody></table>`;
  }

  // =====================
  // PDFs
  // =====================
  function updateFilename(input) {
    document.getElementById('pdf-filename').textContent = input.files[0]?.name || 'Clique para selecionar um PDF';
  }

  async function uploadPDF() {
    const nome = document.getElementById('pdf-nome').value.trim();
    const categoria = document.getElementById('pdf-categoria').value;
    const file = document.getElementById('pdf-file').files[0];
    const btn = document.getElementById('btn-upload-pdf');
    const status = document.getElementById('upload-status');
    if (!nome || !file) { alert('Preencha o nome e selecione um PDF.'); return; }
    btn.disabled = true; btn.textContent = 'Enviando...'; status.textContent = '';
    const formData = new FormData();
    formData.append('Nome do documento', nome);
    formData.append('Categoria', categoria);
    formData.append('Arquivo PDF', file);
    // Envia user_id para isolamento de dados por cliente (multi-tenancy)
    const { data: { user: uploadUser } } = await db.auth.getUser();
    if (uploadUser) formData.append('user_id', uploadUser.id);
    try {
      await fetch(N8N_UPLOAD_WEBHOOK, { method: 'POST', body: formData });
      status.textContent = '‚úÖ PDF enviado para processamento!'; status.style.color = '#16a34a';
      loadPDFList();
    } catch {
      status.textContent = '‚ùå Erro ao enviar. Verifique se o Workflow 2 est√° ativo.'; status.style.color = '#ef4444';
    }
    btn.disabled = false; btn.textContent = '‚¨ÜÔ∏è Enviar para o agente';
    setTimeout(() => status.textContent = '', 4000);
  }

  async function loadPDFList() {
    const { data } = await db.from('documentos_conhecimento').select('metadata').limit(30);
    const el = document.getElementById('pdf-list');
    if (!data || !data.length) {
      el.innerHTML = '<p class="empty-state">Nenhum PDF na base ainda.</p>'; return;
    }
    const unique = {};
    data.forEach(d => { const k = (d.metadata?.nome || 'Sem nome'); unique[k] = d.metadata; });
    el.innerHTML = '<div class="pdf-list">' + Object.values(unique).map(meta =>
      `<div class="pdf-item"><span>üìÑ ${meta.nome || 'Documento'}</span><span class="pdf-badge">${meta.categoria || 'Geral'}</span></div>`
    ).join('') + '</div>';
  }

  // =====================
  // ADMIN ‚Äî CLIENTES (via Edge Function segura)
  // =====================
  async function adminFetch(method, body) {
    const { data: { session } } = await db.auth.getSession();
    const res = await fetch(MANAGE_CLIENTS_URL, {
      method,
      headers: {
        'Authorization': `Bearer ${session?.access_token}`,
        'apikey': SUPABASE_KEY,
        'Content-Type': 'application/json'
      },
      body: body ? JSON.stringify(body) : undefined
    });
    return res.json();
  }

  async function loadClients() {
    if (currentProfile?.role !== 'admin') return;
    const el = document.getElementById('clients-table');
    el.innerHTML = '<p class="loading">Carregando...</p>';
    const profiles = await adminFetch('GET');
    if (!Array.isArray(profiles)) {
      el.innerHTML = '<p class="error-msg">Erro ao carregar clientes: ' + (profiles?.error || '') + '</p>'; return;
    }
    if (!profiles.length) {
      el.innerHTML = '<p class="empty-state">Nenhum cliente cadastrado ainda.</p>'; return;
    }
    // Carrega saldos de tokens
    const { data: saldos } = await db.from('tokens_creditos').select('user_id, saldo_tokens');
    const saldoMap = {};
    (saldos || []).forEach(s => { saldoMap[s.user_id] = s.saldo_tokens; });

    el.innerHTML = `<table>
      <thead><tr><th>Nome</th><th>Tipo</th><th>Inst√¢ncia WA</th><th>Status</th><th>Tokens</th><th>Leads rest.</th><th>A√ß√µes</th></tr></thead>
      <tbody>${profiles.map(p => {
        const saldo = saldoMap[p.id] || 0;
        const leads = Math.floor(saldo / TOKENS_POR_LEAD);
        const cor = saldo === 0 ? '#dc2626' : saldo < 3000000 ? '#ca8a04' : '#16a34a';
        return `<tr>
          <td style="font-weight:600">${escapeHtml(p.display_name || '‚Äî')}</td>
          <td><span class="badge ${p.role==='admin'?'badge-purple':'badge-blue'}">${p.role==='admin'?'üîë Admin':'üë§ Cliente'}</span></td>
          <td><code style="background:#f0f2f5;padding:2px 7px;border-radius:4px;font-size:12px;">${escapeHtml(p.evo_instance||'‚Äî')}</code></td>
          <td><span class="badge ${p.active?'badge-green':'badge-red'}">${p.active?'‚úÖ Ativo':'‚ùå Inativo'}</span></td>
          <td style="font-weight:700;color:${cor};font-size:13px;">${(saldo/1000000).toFixed(1)}M</td>
          <td style="font-size:13px;color:#555;">${leads.toLocaleString('pt-BR')}</td>
          <td style="display:flex;gap:6px;flex-wrap:wrap;">
            ${p.role !== 'admin' ? `
              <button onclick="toggleClient('${p.id}',${p.active})" style="padding:5px 10px;font-size:12px;" class="btn-secondary">${p.active?'Desativar':'Ativar'}</button>
              <button onclick="openAddCreditsModal('${p.id}','${escapeHtml(p.display_name||'')}')" style="padding:5px 10px;font-size:12px;" class="btn-success">üí∞ Cr√©ditos</button>
            ` : '<span style="color:#bbb;font-size:12px;">‚Äî</span>'}
          </td>
        </tr>`;
      }).join('')}</tbody>
    </table>`
  }

  function openCreateClientModal() {
    ['new-client-name','new-client-email','new-client-password','new-client-instance'].forEach(id => {
      document.getElementById(id).value = '';
    });
    document.getElementById('create-client-error').textContent = '';
    document.getElementById('btn-create-client').disabled = false;
    document.getElementById('btn-create-client').textContent = '‚úÖ Criar conta';
    document.getElementById('modal-backdrop').classList.add('open');
  }

  function closeModal() {
    document.getElementById('modal-backdrop').classList.remove('open');
  }

  async function createClient() {
    const name     = document.getElementById('new-client-name').value.trim();
    const email    = document.getElementById('new-client-email').value.trim();
    const password = document.getElementById('new-client-password').value;
    const instance = document.getElementById('new-client-instance').value.trim().replace(/\s+/g, '');
    const errEl    = document.getElementById('create-client-error');
    const btn      = document.getElementById('btn-create-client');
    errEl.textContent = '';
    if (!name || !email || !password || !instance) {
      errEl.textContent = 'Preencha todos os campos.'; return;
    }
    if (password.length < 6) {
      errEl.textContent = 'Senha deve ter no m√≠nimo 6 caracteres.'; return;
    }
    btn.disabled = true; btn.textContent = 'Criando...';
    const result = await adminFetch('POST', { name, email, password, evo_instance: instance });
    if (result?.error) {
      errEl.textContent = 'Erro: ' + result.error;
      btn.disabled = false; btn.textContent = '‚úÖ Criar conta';
      return;
    }
    closeModal();
    loadClients();
  }

  async function toggleClient(userId, currentActive) {
    await adminFetch('PATCH', { user_id: userId, active: !currentActive });
    loadClients();
  }

  // =====================
  // CR√âDITOS / TOKENS
  // =====================
  const TOKENS_POR_LEAD = 37037; // m√©dia real: 10M tokens = 270 pessoas

  // Plano base inclui 5M tokens/m√™s (R$ 497/m√™s)
  const TOKENS_PLANO_BASE = 5000000; // inclusos na assinatura mensal
  const PRECO_PLANO_BASE_BRL = 497;

  // Pacotes de tokens EXTRAS (soma ao saldo)
  const PACOTES_CREDITOS = {
    mini:   { nome: '‚ûï Mini',    leads: 135,   tokens: 5000000,   preco_brl: 97,  moeda: 'BRL' },
    medio:  { nome: '‚ûï‚ûï M√©dio', leads: 270,   tokens: 10000000,  preco_brl: 177, moeda: 'BRL' },
    grande: { nome: 'üöÄ Grande',  leads: 540,   tokens: 20000000,  preco_brl: 297, moeda: 'BRL' },
    max:    { nome: 'üíº Max',     leads: 1350,  tokens: 50000000,  preco_brl: 597, moeda: 'BRL' },
  };

  let buyPacoteAtual = null;
  let addCreditsUserId = null;

  async function loadCredits() {
    const { data: { user } } = await db.auth.getUser();
    if (!user) return;
    const { data } = await db.from('tokens_creditos').select('*').eq('user_id', user.id).single();
    const saldo = data?.saldo_tokens || 0;
    const usadoMes = data?.tokens_usados_mes || 0;
    const leads = Math.floor(saldo / TOKENS_POR_LEAD);
    const leadsUsados = Math.floor(usadoMes / TOKENS_POR_LEAD);
    const saldoEl = document.getElementById('saldo-tokens-display');
    const leadsEl = document.getElementById('saldo-leads-display');
    const usadoEl = document.getElementById('saldo-usado-display');
    if (saldoEl) saldoEl.textContent = saldo.toLocaleString('pt-BR');
    if (leadsEl) leadsEl.textContent = leads.toLocaleString('pt-BR');
    if (usadoEl) usadoEl.textContent = leadsUsados.toLocaleString('pt-BR');
    // Verifica se deve mostrar alerta de tokens baixos
    checkTokenAlert(saldo);
    // Carrega pedidos do cliente
    loadMeusPedidos(user.id);
  }

  async function loadMeusPedidos(userId) {
    const el = document.getElementById('pedidos-cliente-table');
    if (!el) return;
    const { data } = await db.from('pedidos_creditos').select('*').eq('user_id', userId).order('criado_em', { ascending: false }).limit(10);
    if (!data || !data.length) {
      el.innerHTML = '<p class="empty-state" style="padding:20px;">Nenhum pedido realizado ainda.</p>'; return;
    }
    el.innerHTML = `<table>
      <thead><tr><th>Data</th><th>Pacote</th><th>Tokens</th><th>Valor</th><th>Status</th></tr></thead>
      <tbody>${data.map(p => `<tr>
        <td style="font-size:12px;color:#888">${new Date(p.criado_em).toLocaleDateString('pt-BR')}</td>
        <td style="font-weight:600">${PACOTES_CREDITOS[p.pacote]?.nome || p.pacote}</td>
        <td>${(p.tokens/1000000).toFixed(1)}M tokens</td>
        <td style="font-weight:700;color:#4f46e5">${p.preco_brl ? 'R$ '+p.preco_brl : p.preco_usd ? '$'+p.preco_usd : '‚Äî'}</td>
        <td><span class="pedidos-badge ${p.status}">${p.status === 'pendente' ? '‚è≥ Pendente' : p.status === 'aprovado' ? '‚úÖ Aprovado' : '‚ùå Recusado'}</span></td>
      </tr>`).join('')}</tbody>
    </table>`;
  }

  // =====================
  // POPUP ALERTA TOKENS BAIXOS
  // =====================
  const TOKENS_ALERTA_BAIXO    = 2000000; // < 2M ‚Üí alerta laranja (~54 leads)
  const TOKENS_ALERTA_CRITICO  = 500000;  // < 500k ‚Üí alerta vermelho (~13 leads)
  const TOKENS_BASE_PLANO      = 5000000; // refer√™ncia do plano base

  function checkTokenAlert(saldo) {
    // S√≥ mostra 1x por sess√£o e s√≥ para clientes
    if (currentProfile?.role === 'admin') return;
    if (sessionStorage.getItem('token_alert_dismissed')) return;
    if (saldo >= TOKENS_ALERTA_BAIXO) return;

    const popup   = document.getElementById('token-alert-popup');
    const header  = document.getElementById('token-alert-header');
    const icon    = document.getElementById('token-alert-icon');
    const title   = document.getElementById('token-alert-title');
    const sub     = document.getElementById('token-alert-subtitle');
    const saldoTx = document.getElementById('token-alert-saldo-txt');
    const progress= document.getElementById('token-alert-progress');
    const pctTxt  = document.getElementById('token-alert-pct-txt');
    const urgTxt  = document.getElementById('token-alert-urgency-txt');

    const leads   = Math.floor(saldo / TOKENS_POR_LEAD);
    const pct     = Math.max(2, Math.round((saldo / TOKENS_BASE_PLANO) * 100));

    saldoTx.textContent = saldo.toLocaleString('pt-BR');
    pctTxt.textContent  = `${pct}% restante`;
    progress.style.width = `${pct}%`;

    if (saldo <= TOKENS_ALERTA_CRITICO) {
      // CR√çTICO ‚Äî vermelho
      header.className    = 'token-alert-header';
      icon.textContent    = 'üö®';
      title.textContent   = 'Tokens esgotados! Agente parado!';
      sub.textContent     = 'O agente n√£o est√° mais conseguindo atender novos leads.';
      progress.style.background = '#dc2626';
      urgTxt.textContent  = `Restam apenas ${leads} atendimento${leads !== 1 ? 's' : ''}. Recarregue AGORA!`;
    } else {
      // BAIXO ‚Äî laranja
      header.className    = 'token-alert-header warning';
      icon.textContent    = '‚ö†Ô∏è';
      title.textContent   = 'Seus tokens est√£o acabando!';
      sub.textContent     = `Restam apenas ~${leads} atendimentos. Recarregue para n√£o perder leads.`;
      progress.style.background = '#ea580c';
      urgTxt.textContent  = `Com ~${leads} tokens restantes, voc√™ pode perder novos leads em breve!`;
    }

    // Mostra com delay de 1.5s para n√£o ser intrusivo no login
    setTimeout(() => popup.classList.add('open'), 1500);
  }

  function dismissTokenAlert() {
    document.getElementById('token-alert-popup').classList.remove('open');
    sessionStorage.setItem('token_alert_dismissed', '1');
  }

  function buyFromAlert() {
    dismissTokenAlert();
    // Navega para faturamento e abre modal do M√©dio diretamente
    showPage('faturamento', document.querySelector('.nav-item[onclick*="faturamento"]'));
    setTimeout(() => showBuyModal('medio'), 400);
  }

  // Fecha ao clicar fora
  document.getElementById('token-alert-popup').addEventListener('click', function(e) {
    if (e.target === this) dismissTokenAlert();
  });

  function showBuyModal(pacoteId) {
    const pkg = PACOTES_CREDITOS[pacoteId];
    if (!pkg) return;
    buyPacoteAtual = pacoteId;
    const precoFmt = pkg.moeda === 'BRL'
      ? `R$ ${pkg.preco_brl}`
      : `$${pkg.preco_usd}`;
    document.getElementById('buy-modal-title').textContent = `‚ö° Adicionar ${pkg.nome}`;
    document.getElementById('buy-pkg-name').textContent = pkg.nome;
    document.getElementById('buy-pkg-price').textContent = precoFmt;
    document.getElementById('buy-pkg-leads').textContent = `üë• +${pkg.leads.toLocaleString('pt-BR')} atendimentos`;
    document.getElementById('buy-pkg-tokens').textContent = `üî¢ +${(pkg.tokens/1000000).toFixed(0)}M tokens`;
    document.getElementById('buy-modal-error').textContent = '';
    document.getElementById('btn-confirm-buy').disabled = false;
    document.getElementById('btn-confirm-buy').textContent = '‚úÖ Confirmar Pedido';
    document.getElementById('modal-buy-credits').classList.add('open');
  }

  function closeBuyModal() {
    document.getElementById('modal-buy-credits').classList.remove('open');
    buyPacoteAtual = null;
  }

  async function confirmBuy() {
    if (!buyPacoteAtual) return;
    const pkg = PACOTES_CREDITOS[buyPacoteAtual];
    const btn = document.getElementById('btn-confirm-buy');
    const errEl = document.getElementById('buy-modal-error');
    btn.disabled = true; btn.textContent = 'Enviando...';
    const { data: { user } } = await db.auth.getUser();
    const { error } = await db.from('pedidos_creditos').insert({
      user_id: user.id, pacote: buyPacoteAtual,
      tokens: pkg.tokens,
      preco_usd: pkg.preco_usd || null,
      preco_brl: pkg.preco_brl || null,
      status: 'pendente'
    });
    if (error) {
      errEl.textContent = 'Erro ao enviar pedido. Tente novamente.';
      btn.disabled = false; btn.textContent = '‚úÖ Confirmar Pedido'; return;
    }
    closeBuyModal();
    const precoFmt = pkg.preco_brl ? `R$ ${pkg.preco_brl}` : `$${pkg.preco_usd}`;
    alert(`‚úÖ Pedido enviado!\n\nPacote: ${pkg.nome}\nValor: ${precoFmt}\n\nEm breve o administrador entrar√° em contato com os dados para pagamento via PIX.\nAp√≥s confirma√ß√£o, os tokens ser√£o creditados em at√© 2h.`);
    loadCredits();
  }

  // Admin: abrir modal de adicionar cr√©ditos
  function openAddCreditsModal(userId, clientName) {
    addCreditsUserId = userId;
    document.getElementById('add-credits-client-name').textContent = clientName;
    document.getElementById('add-credits-tokens').value = '10000000';
    document.getElementById('add-credits-obs').value = '';
    document.getElementById('add-credits-error').textContent = '';
    document.getElementById('btn-confirm-add-credits').disabled = false;
    document.getElementById('btn-confirm-add-credits').textContent = '‚úÖ Adicionar Cr√©ditos';
    document.getElementById('modal-add-credits').classList.add('open');
  }

  function closeAddCreditsModal() {
    document.getElementById('modal-add-credits').classList.remove('open');
    addCreditsUserId = null;
  }

  async function confirmAddCredits() {
    if (!addCreditsUserId) return;
    const tokens = parseInt(document.getElementById('add-credits-tokens').value);
    const obs = document.getElementById('add-credits-obs').value;
    const btn = document.getElementById('btn-confirm-add-credits');
    const errEl = document.getElementById('add-credits-error');
    if (!tokens || tokens < 1000000) { errEl.textContent = 'M√≠nimo 1.000.000 tokens.'; return; }
    btn.disabled = true; btn.textContent = 'Adicionando...';
    // Upsert cr√©ditos: soma ao saldo atual
    const { data: atual } = await db.from('tokens_creditos').select('saldo_tokens').eq('user_id', addCreditsUserId).single();
    const novoSaldo = (atual?.saldo_tokens || 0) + tokens;
    const { error } = await db.from('tokens_creditos').upsert({
      user_id: addCreditsUserId, saldo_tokens: novoSaldo,
      atualizado_em: new Date().toISOString()
    }, { onConflict: 'user_id' });
    if (error) { errEl.textContent = 'Erro: ' + error.message; btn.disabled = false; btn.textContent = '‚úÖ Adicionar Cr√©ditos'; return; }
    // Registra no hist√≥rico e aprova pedido pendente
    if (obs) {
      await db.from('pedidos_creditos')
        .update({ status: 'aprovado', obs_admin: obs })
        .eq('user_id', addCreditsUserId).eq('status', 'pendente');
    }
    closeAddCreditsModal();
    alert(`‚úÖ ${(tokens/1000000).toFixed(1)}M tokens adicionados com sucesso!\nNovo saldo: ${novoSaldo.toLocaleString('pt-BR')} tokens`);
    loadAdminPedidos();
  }

  async function loadAdminPedidos() {
    const el = document.getElementById('admin-pedidos-table');
    if (!el) return;
    const { data } = await db.from('pedidos_creditos')
      .select('*, profiles(display_name, evo_instance)')
      .order('criado_em', { ascending: false }).limit(50);
    if (!data || !data.length) { el.innerHTML = '<p class="empty-state">Nenhum pedido ainda.</p>'; return; }
    el.innerHTML = `<table>
      <thead><tr><th>Data</th><th>Cliente</th><th>Pacote</th><th>Tokens</th><th>Valor</th><th>Status</th><th>A√ß√µes</th></tr></thead>
      <tbody>${data.map(p => `<tr>
        <td style="font-size:12px;color:#888">${new Date(p.criado_em).toLocaleDateString('pt-BR')}</td>
        <td style="font-weight:600">${escapeHtml(p.profiles?.display_name || '‚Äî')}</td>
        <td>${PACOTES_CREDITOS[p.pacote]?.nome || p.pacote}</td>
        <td>${(p.tokens/1000000).toFixed(1)}M tokens</td>
        <td style="font-weight:700;color:#4f46e5">${p.preco_brl ? 'R$ '+p.preco_brl : p.preco_usd ? '$'+p.preco_usd : '‚Äî'}</td>
        <td><span class="pedidos-badge ${p.status}">${p.status === 'pendente' ? '‚è≥ Pendente' : p.status === 'aprovado' ? '‚úÖ Aprovado' : '‚ùå Recusado'}</span></td>
        <td>
          ${p.status === 'pendente' ? `
            <button class="btn-success" style="font-size:12px;padding:5px 12px;" onclick="openAddCreditsModal('${p.user_id}','${escapeHtml(p.profiles?.display_name || '')}')">‚úÖ Aprovar</button>
            <button class="btn-danger" style="font-size:12px;padding:5px 12px;margin-left:4px;" onclick="recusarPedido('${p.id}')">‚ùå Recusar</button>
          ` : '‚Äî'}
        </td>
      </tr>`).join('')}</tbody>
    </table>`;
  }

  async function recusarPedido(pedidoId) {
    if (!confirm('Recusar este pedido?')) return;
    await db.from('pedidos_creditos').update({ status: 'recusado' }).eq('id', pedidoId);
    loadAdminPedidos();
  }

  // =====================
  // FATURAMENTO
  // =====================
  const MANAGE_BILLING_URL = `${SUPABASE_URL}/functions/v1/manage-billing`;

  async function billingFetch(method, body) {
    const { data: { session } } = await db.auth.getSession();
    const res = await fetch(MANAGE_BILLING_URL, {
      method,
      headers: {
        'Authorization': `Bearer ${session?.access_token}`,
        'apikey': SUPABASE_KEY,
        'Content-Type': 'application/json'
      },
      body: body ? JSON.stringify(body) : undefined
    });
    return res.json();
  }

  const STATUS_LABELS = { trial:'‚è≥ Per√≠odo de teste', ativa:'‚úÖ Ativa', inadimplente:'üî¥ Inadimplente', cancelada:'‚ö´ Cancelada' };
  const STATUS_CLASSES = { trial:'trial', ativa:'ativa', inadimplente:'inadimplente', cancelada:'cancelada' };

  async function loadBilling() {
    // Dados do pr√≥prio cliente (RLS retorna s√≥ o seu)
    const { data: assin } = await db.from('assinaturas').select('*').single();
    if (assin) {
      const badgeEl = document.getElementById('billing-status-badge');
      badgeEl.textContent = STATUS_LABELS[assin.status] || assin.status;
      badgeEl.className = `billing-status-badge ${STATUS_CLASSES[assin.status] || ''}`;
      document.getElementById('billing-status-text').textContent = STATUS_LABELS[assin.status] || assin.status;
      document.getElementById('billing-due-day').textContent = `Dia ${assin.dia_vencimento || 1}`;
      document.getElementById('billing-cycle-text').textContent = assin.ciclo === 'mensal' ? 'Cobran√ßa mensal' : assin.ciclo;
      document.getElementById('billing-next-date').textContent = assin.proxima_cobranca
        ? `Pr√≥xima cobran√ßa: ${new Date(assin.proxima_cobranca + 'T00:00:00').toLocaleDateString('pt-BR')}`
        : 'Pr√≥xima cobran√ßa: ‚Äî';
    }
    // Hist√≥rico de cobran√ßas
    const { data: hist } = await db.from('historico_cobrancas').select('*').order('criado_em', { ascending: false }).limit(24);
    const histEl = document.getElementById('billing-history-table');
    if (!hist || !hist.length) {
      histEl.innerHTML = '<p class="empty-state">Nenhum registro de cobran√ßa ainda.</p>'; return;
    }
    histEl.innerHTML = `<table>
      <thead><tr><th>M√™s Refer√™ncia</th><th>Valor</th><th>Status</th><th>Vencimento</th><th>Pago em</th><th>Observa√ß√£o</th></tr></thead>
      <tbody>${hist.map(h => `<tr>
        <td style="font-weight:600">${h.mes_referencia || '‚Äî'}</td>
        <td>R$ ${Number(h.valor).toFixed(2).replace('.',',')}</td>
        <td class="history-row-${h.status}">${h.status === 'pago' ? '‚úÖ Pago' : h.status === 'pendente' ? '‚è≥ Pendente' : h.status === 'atrasado' ? 'üî¥ Atrasado' : h.status}</td>
        <td>${h.vencimento ? new Date(h.vencimento+'T00:00:00').toLocaleDateString('pt-BR') : '‚Äî'}</td>
        <td>${h.pago_em ? new Date(h.pago_em).toLocaleDateString('pt-BR') : '‚Äî'}</td>
        <td style="color:#888;font-size:12px">${h.observacao || '‚Äî'}</td>
      </tr>`).join('')}</tbody>
    </table>`;
  }

  async function loadAdminBilling() {
    if (currentProfile?.role !== 'admin') return;
    const el = document.getElementById('admin-billing-table');
    el.innerHTML = '<p class="loading">Carregando...</p>';
    const data = await billingFetch('GET');
    if (!Array.isArray(data)) {
      el.innerHTML = '<p class="error-msg">Erro ao carregar.</p>'; return;
    }
    if (!data.length) {
      el.innerHTML = '<p class="empty-state">Nenhuma assinatura encontrada.</p>'; return;
    }
    const meAtual = new Date().toISOString().slice(0,7);
    el.innerHTML = `<table>
      <thead><tr><th>Cliente</th><th>Inst√¢ncia WA</th><th>Status</th><th>Pr√≥x. Cobran√ßa</th><th>Valor</th><th>A√ß√µes</th></tr></thead>
      <tbody>${data.map(a => `<tr>
        <td style="font-weight:600">${escapeHtml(a.profiles?.display_name || '‚Äî')}</td>
        <td><code style="background:#f0f2f5;padding:2px 7px;border-radius:4px;font-size:12px;">${escapeHtml(a.profiles?.evo_instance || '‚Äî')}</code></td>
        <td><span class="badge ${a.status === 'ativa' ? 'badge-green' : a.status === 'inadimplente' ? 'badge-red' : a.status === 'trial' ? 'badge-yellow' : 'badge-blue'}">${STATUS_LABELS[a.status] || a.status}</span></td>
        <td style="font-size:13px">${a.proxima_cobranca ? new Date(a.proxima_cobranca+'T00:00:00').toLocaleDateString('pt-BR') : '‚Äî'}</td>
        <td style="font-weight:700">R$ ${Number(a.valor || 497).toFixed(2).replace('.',',')}</td>
        <td>
          <div class="billing-actions">
            ${a.status !== 'ativa' ? `<button class="btn-success" onclick="setBillingStatus('${a.user_id}','ativa')">‚úÖ Ativar</button>` : ''}
            ${a.status !== 'inadimplente' ? `<button class="btn-danger" onclick="setBillingStatus('${a.user_id}','inadimplente')">üî¥ Inadimplente</button>` : ''}
            <button class="btn-secondary" onclick="registerPayment('${a.user_id}','${meAtual}')" style="font-size:12px">üí∞ Registrar Pgto</button>
          </div>
        </td>
      </tr>`).join('')}</tbody>
    </table>`;
  }

  async function setBillingStatus(userId, status) {
    await billingFetch('PATCH', { user_id: userId, status });
    loadAdminBilling();
  }

  async function registerPayment(userId, mes) {
    const m = prompt('M√™s de refer√™ncia (ex: 2025-02):', mes);
    if (!m) return;
    await billingFetch('POST', { user_id: userId, status: 'pago', mes_referencia: m });
    alert('Pagamento registrado!');
    loadAdminBilling();
  }

  // =====================
  // DESIGNER DE FLUXOS
  // =====================
  let editor = null;
  let currentFlowId = null;
  let dragNodeType = null;

  const NODE_TEMPLATES = {
    inicio:          { title:'üü¢ In√≠cio',          inputs:0, outputs:1, html:'<div class="box">Ponto de entrada do fluxo</div>', cls:'node-inicio' },
    mensagem:        { title:'üí¨ Mensagem Bot',     inputs:1, outputs:1, html:'<div class="box"><textarea style="width:100%;font-size:12px;border:1px solid #e5e7eb;border-radius:6px;padding:6px;resize:vertical;min-height:50px;" placeholder="Texto da mensagem..."></textarea></div>', cls:'' },
    pergunta:        { title:'‚ùì Pergunta',          inputs:1, outputs:1, html:'<div class="box"><textarea style="width:100%;font-size:12px;border:1px solid #e5e7eb;border-radius:6px;padding:6px;resize:vertical;min-height:50px;" placeholder="Pergunta para o lead..."></textarea></div>', cls:'node-pergunta' },
    condicao:        { title:'üîÄ Condi√ß√£o',          inputs:1, outputs:2, html:'<div class="box"><input style="width:100%;font-size:12px;border:1px solid #e5e7eb;border-radius:6px;padding:6px;" placeholder="Se cont√©m..." /><div style="display:flex;justify-content:space-between;font-size:10px;color:#888;margin-top:6px;"><span>Sa√≠da 1: Sim</span><span>Sa√≠da 2: N√£o</span></div></div>', cls:'node-condicao' },
    qualificado:     { title:'‚úÖ Lead Qualificado', inputs:1, outputs:0, html:'<div class="box" style="color:#16a34a">Registra lead como qualificado e notifica advogado</div>', cls:'node-qualificado' },
    desqualificado:  { title:'‚ùå Desqualificado',   inputs:1, outputs:0, html:'<div class="box" style="color:#dc2626">Registra lead como desqualificado</div>', cls:'node-desqualificado' },
    fim:             { title:'üî¥ Fim',              inputs:1, outputs:0, html:'<div class="box">Encerra a conversa</div>', cls:'node-fim' },
  };

  function initDrawflow() {
    if (editor) return;
    const container = document.getElementById('drawflow');
    editor = new Drawflow(container);
    editor.reroute = true;
    editor.editor_mode = 'edit';
    editor.start();
    // Registra os tipos de n√≥
    Object.entries(NODE_TEMPLATES).forEach(([type, cfg]) => {
      editor.registerNode(type, { html: `<div class="title-box">${cfg.title}</div>${cfg.html}`, inputs: cfg.inputs, outputs: cfg.outputs });
    });
  }

  function drag(event, type) {
    dragNodeType = type;
    event.dataTransfer.setData('text', type);
  }

  function allowDrop(event) { event.preventDefault(); }

  function drop(event) {
    event.preventDefault();
    const type = dragNodeType || event.dataTransfer.getData('text');
    if (!type || !NODE_TEMPLATES[type]) return;
    const cfg = NODE_TEMPLATES[type];
    const wrap = document.getElementById('flow-canvas-wrap');
    const rect = wrap.getBoundingClientRect();
    const x = event.clientX - rect.left;
    const y = event.clientY - rect.top;
    editor.addNode(
      type, cfg.inputs, cfg.outputs,
      x, y,
      cfg.cls,
      {},
      `<div class="title-box">${cfg.title}</div>${cfg.html}`
    );
    dragNodeType = null;
  }

  function newFlow() {
    if (!editor) initDrawflow();
    if (!confirm('Criar novo fluxo? As altera√ß√µes n√£o salvas ser√£o perdidas.')) return;
    editor.clearModuleSelected();
    editor.import({ drawflow: { Home: { data: {} } } });
    document.getElementById('flow-name-input').value = '';
    currentFlowId = null;
  }

  function clearCanvas() {
    if (!editor) return;
    if (!confirm('Limpar todos os n√≥s do canvas?')) return;
    editor.clearModuleSelected();
    editor.import({ drawflow: { Home: { data: {} } } });
  }

  async function saveFlow() {
    if (!editor) { alert('Nenhum fluxo para salvar.'); return; }
    const name = document.getElementById('flow-name-input').value.trim();
    if (!name) { alert('Digite um nome para o fluxo.'); return; }
    const { data: { user } } = await db.auth.getUser();
    const flowData = editor.export();
    if (currentFlowId) {
      await db.from('fluxos').update({ nome: name, dados: flowData, atualizado_em: new Date().toISOString() }).eq('id', currentFlowId);
    } else {
      const { data } = await db.from('fluxos').insert({ nome: name, dados: flowData, user_id: user.id }).select().single();
      if (data) currentFlowId = data.id;
    }
    alert('Fluxo salvo!');
    loadSavedFlows();
  }

  async function loadSavedFlows() {
    const { data } = await db.from('fluxos').select('id,nome,atualizado_em').order('atualizado_em', { ascending: false }).limit(20);
    const el = document.getElementById('saved-flows-list');
    if (!data || !data.length) {
      el.innerHTML = '<p style="font-size:12px;color:#aaa;text-align:center;padding:8px;">Nenhum fluxo salvo</p>'; return;
    }
    el.innerHTML = data.map(f => `
      <div class="flow-saved-item" onclick="loadFlow('${f.id}','${escapeHtml(f.nome)}')">
        <span>üìã ${escapeHtml(f.nome)}</span>
        <button onclick="event.stopPropagation();deleteFlow('${f.id}')" style="background:none;border:none;color:#dc2626;cursor:pointer;font-size:14px;">üóëÔ∏è</button>
      </div>`).join('');
  }

  async function loadFlow(id, name) {
    const { data } = await db.from('fluxos').select('*').eq('id', id).single();
    if (!data) return;
    if (!editor) initDrawflow();
    editor.import(data.dados);
    document.getElementById('flow-name-input').value = data.nome;
    currentFlowId = id;
  }

  async function deleteFlow(id) {
    if (!confirm('Excluir este fluxo?')) return;
    await db.from('fluxos').delete().eq('id', id);
    if (currentFlowId === id) { currentFlowId = null; document.getElementById('flow-name-input').value = ''; }
    loadSavedFlows();
  }

  function exportFlow() {
    if (!editor) return;
    const data = JSON.stringify(editor.export(), null, 2);
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url;
    a.download = (document.getElementById('flow-name-input').value || 'fluxo') + '.json';
    a.click(); URL.revokeObjectURL(url);
  }

  // =====================
  // USO DE TOKENS (admin)
  // =====================
  async function loadTokenUsageAdmin() {
    if (currentProfile?.role !== 'admin') return;
    const el = document.getElementById('token-usage-admin-table');
    if (!el) return;
    el.innerHTML = '<p class="loading">Carregando...</p>';

    // Usa RPC admin_get_all_tokens para ver saldo de TODOS os clientes
    const { data, error } = await db.rpc('admin_get_all_tokens');

    if (error) {
      el.innerHTML = '<p class="empty-state">Erro ao carregar: ' + error.message + '</p>'; return;
    }
    if (!data || !data.length) {
      el.innerHTML = '<p class="empty-state">Nenhum cliente com dados de tokens.</p>'; return;
    }

    const totalSaldo = data.reduce((s,r) => s + (r.saldo_tokens||0), 0);
    const totalUsado = data.reduce((s,r) => s + (r.tokens_usados_mes||0), 0);
    const totalComprado = data.reduce((s,r) => s + (r.total_comprado||0), 0);

    el.innerHTML = `
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px">
        <div class="billing-info-card"><div class="label">Saldo Total (todos)</div><div class="value">${totalSaldo.toLocaleString('pt-BR')}</div></div>
        <div class="billing-info-card"><div class="label">Usados no M√™s (todos)</div><div class="value">${totalUsado.toLocaleString('pt-BR')}</div></div>
        <div class="billing-info-card"><div class="label">Total Comprado (todos)</div><div class="value">${totalComprado.toLocaleString('pt-BR')}</div></div>
      </div>
      <table>
        <thead><tr><th>Cliente</th><th>Email</th><th>Saldo Tokens</th><th>Usado no M√™s</th><th>Total Comprado</th><th>M√™s Ref.</th></tr></thead>
        <tbody>${data.map(r => {
          const cor = r.saldo_tokens > 2000000 ? '#22c55e' : r.saldo_tokens > 500000 ? '#f59e0b' : '#ef4444';
          return '<tr>' +
            '<td style="font-weight:600">' + (r.display_name||'‚Äî') + '</td>' +
            '<td style="font-size:12px;color:#888">' + (r.email||'‚Äî') + '</td>' +
            '<td style="font-weight:700;color:' + cor + '">' + (r.saldo_tokens||0).toLocaleString('pt-BR') + '</td>' +
            '<td>' + (r.tokens_usados_mes||0).toLocaleString('pt-BR') + '</td>' +
            '<td>' + (r.total_comprado||0).toLocaleString('pt-BR') + '</td>' +
            '<td style="font-size:12px">' + (r.mes_referencia||'‚Äî') + '</td>' +
          '</tr>';
        }).join('')}</tbody>
      </table>`;
  }
</script>
<script src="https://unpkg.com/drawflow/dist/drawflow.min.js"></script>
</body>
</html>
