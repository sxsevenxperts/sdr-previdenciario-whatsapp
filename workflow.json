{
  "name": "SDR Previdenci√°rio ‚Äî WhatsApp IA",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "whatsapp-webhook",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "node-webhook",
      "name": "Webhook ‚Äî Recebe mensagem WhatsApp",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [0, 300],
      "notes": "Configure este endpoint na Evolution API como webhook de mensagens recebidas."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "cfg-numero-destino",
              "name": "NUMERO_DESTINO",
              "value": "5511999999999",
              "type": "string"
            },
            {
              "id": "cfg-prompt",
              "name": "PROMPT_SISTEMA",
              "value": "Voc√™ √© um assistente de triagem jur√≠dica especializado em Direito Previdenci√°rio. Seu papel √© conversar de forma humanizada e emp√°tica com pessoas que buscam ajuda, qualific√°-las e encaminhar os casos vi√°veis para o advogado.\n\nVoc√™ N√ÉO √© advogado e N√ÉO d√° consultoria jur√≠dica. Voc√™ apenas coleta informa√ß√µes para que o advogado avalie.\n\nSiga este roteiro:\n1. Cumprimente pelo nome e explique que vai fazer algumas perguntas r√°pidas\n2. Pergunte o nome completo\n3. Pergunte sobre a situa√ß√£o previdenci√°ria (contribuiu ao INSS? √â dependente?)\n4. Pergunte qual benef√≠cio busca ou qual problema tem (negado, cancelado, quer requerer)\n5. Pergunte se j√° tentou dar entrada e o que aconteceu\n6. Pergunte se tem documentos (carteira de trabalho, CNIS, carta de indeferimento)\n7. Pergunte o celular para contato\n\nFa√ßa UMA pergunta por vez. Seja emp√°tico, especialmente com idosos.\n\nCRIT√âRIOS DE QUALIFICA√á√ÉO (precisa atender ao menos 3):\n- Possui v√≠nculo com o INSS (contribuiu ou √© dependente)\n- Existe um benef√≠cio previdenci√°rio aplic√°vel ao caso\n- Benef√≠cio foi negado, cancelado ou ainda n√£o foi requerido\n- √â poss√≠vel identificar uma tese jur√≠dica para o caso\n- Possui ao menos algum documento ou sabe como obt√™-lo\n\nDESQUALIFICA√á√ÉO IMEDIATA SE:\n- Caso √© trabalhista puro sem v√≠nculo com INSS\n- J√° tem advogado cuidando do caso\n- N√£o quer fornecer informa√ß√µes b√°sicas\n\nQUANDO QUALIFICADO, responda normalmente E inclua no final da mensagem um bloco JSON assim:\n```json\n{\"qualificado\":true,\"nome\":\"Nome completo\",\"celular\":\"11999999999\",\"tese\":\"Descri√ß√£o da tese jur√≠dica\",\"resumo\":\"Resumo completo da conversa\"}\n```\n\nQUANDO N√ÉO QUALIFICADO, responda com a mensagem de encerramento E inclua:\n```json\n{\"qualificado\":false,\"motivo\":\"Motivo da desqualifica√ß√£o\"}\n```",
              "type": "string"
            },
            {
              "id": "cfg-msg-qualificado",
              "name": "MSG_QUALIFICADO",
              "value": "√ìtimo! Com base no que voc√™ me contou, acredito que o nosso advogado pode te ajudar. Vou encaminhar as informa√ß√µes do seu caso para ele agora. Em breve ele entrar√° em contato com voc√™.",
              "type": "string"
            },
            {
              "id": "cfg-msg-desqualificado",
              "name": "MSG_DESQUALIFICADO",
              "value": "Obrigado por entrar em contato! Infelizmente, com base nas informa√ß√µes que voc√™ compartilhou, n√£o identificamos uma situa√ß√£o que se encaixe nos casos que atendemos no momento. Caso sua situa√ß√£o mude ou surja algum documento novo, fique √† vontade para nos contatar novamente. Desejamos tudo de bom para voc√™!",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "node-config",
      "name": "‚öôÔ∏è CONFIG ‚Äî Edite aqui",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [220, 300],
      "notes": "EDITE AQUI:\n- NUMERO_DESTINO: n√∫mero que recebe o relat√≥rio (DDI+DDD+n√∫mero)\n- PROMPT_SISTEMA: instru√ß√µes completas do agente\n- MSG_QUALIFICADO: mensagem enviada ao lead quando qualificado\n- MSG_DESQUALIFICADO: mensagem enviada ao lead quando n√£o qualificado"
    },
    {
      "parameters": {
        "jsCode": "const body = $('Webhook ‚Äî Recebe mensagem WhatsApp').first().json;\n\nconst numero = body.data?.key?.remoteJid?.replace('@s.whatsapp.net', '') || '';\nconst mensagem = body.data?.message?.conversation \n  || body.data?.message?.extendedTextMessage?.text \n  || '';\nconst tipoMensagem = body.data?.messageType || 'conversation';\nconst nomeContato = body.data?.pushName || '';\nconst temArquivo = ['imageMessage','documentMessage','audioMessage'].includes(tipoMensagem);\n\nreturn [{\n  json: {\n    numero,\n    mensagem,\n    tipoMensagem,\n    nomeContato,\n    temArquivo,\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "node-normaliza",
      "name": "Normaliza mensagem recebida",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [440, 300]
    },
    {
      "parameters": {
        "operation": "get",
        "key": "=sessao_{{ $json.numero }}",
        "options": {}
      },
      "id": "node-redis-get",
      "name": "Redis ‚Äî Busca sess√£o",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [660, 300],
      "notes": "Recupera o hist√≥rico de mensagens da sess√£o pelo n√∫mero de telefone."
    },
    {
      "parameters": {
        "jsCode": "const dadosMensagem = $('Normaliza mensagem recebida').first().json;\nconst config = $('‚öôÔ∏è CONFIG ‚Äî Edite aqui').first().json;\nconst sessaoRedis = $input.first().json;\n\nlet historico = [];\ntry {\n  historico = JSON.parse(sessaoRedis || '[]');\n} catch(e) {\n  historico = [];\n}\n\n// Adiciona mensagem atual do usu√°rio\nhistorico.push({\n  role: 'user',\n  content: dadosMensagem.temArquivo ? '[Usu√°rio enviou um arquivo]' : dadosMensagem.mensagem\n});\n\nreturn [{\n  json: {\n    ...dadosMensagem,\n    config,\n    historico,\n    historicoJson: JSON.stringify(historico)\n  }\n}];"
      },
      "id": "node-monta-historico",
      "name": "Monta hist√≥rico da conversa",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [880, 300]
    },
    {
      "parameters": {
        "agent": "conversationalAgent",
        "promptType": "define",
        "text": "={{ $json.mensagem }}",
        "options": {
          "systemMessage": "={{ $json.config.PROMPT_SISTEMA }}\n\nHist√≥rico da conversa at√© agora:\n{{ $json.historicoJson }}"
        }
      },
      "id": "node-agente",
      "name": "Agente SDR ‚Äî IA",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [1100, 300],
      "notes": "Configure a credencial OpenAI ou Anthropic. Adicione a tool Tavily para busca na web."
    },
    {
      "parameters": {
        "jsCode": "const respostaAgente = $input.first().json.output || '';\nconst dadosMsg = $('Normaliza mensagem recebida').first().json;\nconst config = $('‚öôÔ∏è CONFIG ‚Äî Edite aqui').first().json;\n\nlet dadosQualificacao = null;\nlet qualificado = null;\n\n// Extrai JSON da resposta do agente\ntry {\n  const jsonMatch = respostaAgente.match(/```json([\\s\\S]*?)```/);\n  if (jsonMatch) {\n    dadosQualificacao = JSON.parse(jsonMatch[1].trim());\n    qualificado = dadosQualificacao.qualificado === true;\n  }\n} catch(e) {}\n\n// Remove o bloco JSON do texto enviado ao lead\nconst textoParaLead = respostaAgente.replace(/```json[\\s\\S]*?```/g, '').trim();\n\n// Monta relat√≥rio formatado para o advogado\nlet relatorio = null;\nif (qualificado && dadosQualificacao) {\n  const agora = new Date().toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' });\n  relatorio = `üü¢ *LEAD QUALIFICADO*\\n\\n`\n    + `üë§ *Nome:* ${dadosQualificacao.nome || 'N√£o informado'}\\n`\n    + `üì± *Celular:* ${dadosQualificacao.celular || dadosMsg.numero}\\n`\n    + `‚öñÔ∏è *Tese:* ${dadosQualificacao.tese || 'N√£o identificada'}\\n`\n    + `üìã *Resumo:* ${dadosQualificacao.resumo || 'Ver hist√≥rico'}\\n`\n    + `üïê *Atendimento:* ${agora}`;\n}\n\nreturn [{\n  json: {\n    numero: dadosMsg.numero,\n    textoParaLead,\n    qualificado,\n    dadosQualificacao,\n    relatorio,\n    numeroDestino: config.NUMERO_DESTINO\n  }\n}];"
      },
      "id": "node-processa-resposta",
      "name": "Processa resposta e extrai qualifica√ß√£o",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1320, 300]
    },
    {
      "parameters": {
        "url": "={{ $env.EVOLUTION_API_URL }}/message/sendText/{{ $env.EVOLUTION_INSTANCE }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [{ "name": "apikey", "value": "={{ $env.EVOLUTION_API_KEY }}" }]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"number\": \"{{ $json.numero }}\", \"text\": \"{{ $json.textoParaLead }}\"}",
        "options": {}
      },
      "id": "node-envia-lead",
      "name": "Envia resposta ao lead",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1540, 160]
    },
    {
      "parameters": {
        "conditions": {
          "conditions": [
            {
              "id": "cond-qualificado",
              "leftValue": "={{ $json.qualificado }}",
              "rightValue": true,
              "operator": { "type": "boolean", "operation": "equal" }
            }
          ]
        }
      },
      "id": "node-switch-qualificado",
      "name": "Lead qualificado?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1540, 380]
    },
    {
      "parameters": {
        "url": "={{ $env.EVOLUTION_API_URL }}/message/sendText/{{ $env.EVOLUTION_INSTANCE }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [{ "name": "apikey", "value": "={{ $env.EVOLUTION_API_KEY }}" }]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"number\": \"{{ $json.numeroDestino }}\", \"text\": \"{{ $json.relatorio }}\"}",
        "options": {}
      },
      "id": "node-envia-advogado",
      "name": "Envia relat√≥rio ao advogado",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1760, 300],
      "notes": "Envia para o NUMERO_DESTINO configurado no node CONFIG."
    },
    {
      "parameters": {
        "jsCode": "// Salva hist√≥rico atualizado no Redis (TTL 24h)\nconst historico = $('Monta hist√≥rico da conversa').first().json.historico;\nconst respostaAgente = $('Agente SDR ‚Äî IA').first().json.output || '';\nconst numero = $('Normaliza mensagem recebida').first().json.numero;\n\nhistorico.push({ role: 'assistant', content: respostaAgente });\nconst historicoTrimmed = historico.slice(-20);\n\nreturn [{\n  json: {\n    key: `sessao_${numero}`,\n    value: JSON.stringify(historicoTrimmed),\n    ttl: 86400\n  }\n}];"
      },
      "id": "node-prepara-redis",
      "name": "Prepara sess√£o para salvar",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1760, 520]
    },
    {
      "parameters": {
        "operation": "set",
        "key": "={{ $json.key }}",
        "value": "={{ $json.value }}",
        "expire": true,
        "ttl": "={{ $json.ttl }}",
        "options": {}
      },
      "id": "node-redis-set",
      "name": "Redis ‚Äî Salva sess√£o",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [1980, 520]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\"status\":\"ok\"}",
        "options": {}
      },
      "id": "node-webhook-response",
      "name": "Responde 200 OK",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1980, 300]
    }
  ],
  "connections": {
    "Webhook ‚Äî Recebe mensagem WhatsApp": {
      "main": [[{ "node": "‚öôÔ∏è CONFIG ‚Äî Edite aqui", "type": "main", "index": 0 }]]
    },
    "‚öôÔ∏è CONFIG ‚Äî Edite aqui": {
      "main": [[{ "node": "Normaliza mensagem recebida", "type": "main", "index": 0 }]]
    },
    "Normaliza mensagem recebida": {
      "main": [[{ "node": "Redis ‚Äî Busca sess√£o", "type": "main", "index": 0 }]]
    },
    "Redis ‚Äî Busca sess√£o": {
      "main": [[{ "node": "Monta hist√≥rico da conversa", "type": "main", "index": 0 }]]
    },
    "Monta hist√≥rico da conversa": {
      "main": [[{ "node": "Agente SDR ‚Äî IA", "type": "main", "index": 0 }]]
    },
    "Agente SDR ‚Äî IA": {
      "main": [[{ "node": "Processa resposta e extrai qualifica√ß√£o", "type": "main", "index": 0 }]]
    },
    "Processa resposta e extrai qualifica√ß√£o": {
      "main": [[
        { "node": "Envia resposta ao lead", "type": "main", "index": 0 },
        { "node": "Lead qualificado?", "type": "main", "index": 0 },
        { "node": "Prepara sess√£o para salvar", "type": "main", "index": 0 }
      ]]
    },
    "Lead qualificado?": {
      "main": [
        [{ "node": "Envia relat√≥rio ao advogado", "type": "main", "index": 0 }],
        []
      ]
    },
    "Envia relat√≥rio ao advogado": {
      "main": [[{ "node": "Responde 200 OK", "type": "main", "index": 0 }]]
    },
    "Envia resposta ao lead": {
      "main": [[{ "node": "Responde 200 OK", "type": "main", "index": 0 }]]
    },
    "Prepara sess√£o para salvar": {
      "main": [[{ "node": "Redis ‚Äî Salva sess√£o", "type": "main", "index": 0 }]]
    },
    "Redis ‚Äî Salva sess√£o": {
      "main": [[{ "node": "Responde 200 OK", "type": "main", "index": 0 }]]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true
  },
  "tags": ["whatsapp", "ia", "sdr", "previdenciario"],
  "meta": {
    "description": "SDR IA para qualifica√ß√£o de leads de Direito Previdenci√°rio via WhatsApp. Edite o node CONFIG para personalizar o prompt e o n√∫mero de destino.",
    "version": "2.0.0"
  }
}
