{
  "name": "SDR Previdenci√°rio ‚Äî WhatsApp IA",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "whatsapp-webhook",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-entrada",
      "name": "Webhook ‚Äî Recebe mensagem WhatsApp",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [240, 300],
      "notes": "Configure este endpoint na Evolution API como webhook de mensagens recebidas."
    },
    {
      "parameters": {
        "jsCode": "// Extrai dados da mensagem recebida da Evolution API\nconst body = $input.first().json;\n\nconst numero = body.data?.key?.remoteJid?.replace('@s.whatsapp.net', '') || '';\nconst mensagem = body.data?.message?.conversation \n  || body.data?.message?.extendedTextMessage?.text \n  || '';\nconst tipoMensagem = body.data?.messageType || 'conversation';\nconst nomeContato = body.data?.pushName || 'Lead';\n\n// Verifica se √© mensagem de arquivo\nconst temArquivo = ['imageMessage', 'documentMessage', 'audioMessage'].includes(tipoMensagem);\nconst urlArquivo = body.data?.message?.[tipoMensagem]?.url || null;\n\nreturn [{\n  json: {\n    numero,\n    mensagem,\n    tipoMensagem,\n    nomeContato,\n    temArquivo,\n    urlArquivo,\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "normaliza-mensagem",
      "name": "Normaliza dados da mensagem",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false
          },
          "conditions": [
            {
              "id": "cond-arquivo",
              "leftValue": "={{ $json.temArquivo }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equal"
              }
            }
          ]
        }
      },
      "id": "switch-tipo",
      "name": "√â arquivo ou texto?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [680, 300],
      "notes": "Rota true = arquivo enviado. Rota false = mensagem de texto."
    },
    {
      "parameters": {
        "url": "={{ $env.EVOLUTION_API_URL }}/message/downloadBase64/{{ $env.EVOLUTION_INSTANCE }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $env.EVOLUTION_API_KEY }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "message",
              "value": "={{ $json }}"
            }
          ]
        },
        "options": {}
      },
      "id": "download-arquivo",
      "name": "Baixa arquivo (base64)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [900, 180],
      "notes": "Baixa o arquivo enviado pelo lead como base64 para passar ao agente."
    },
    {
      "parameters": {
        "operation": "get",
        "key": "sessao_{{ $json.numero }}",
        "options": {}
      },
      "id": "redis-get-sessao",
      "name": "Redis ‚Äî Busca hist√≥rico da sess√£o",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [900, 420],
      "notes": "Recupera o hist√≥rico de mensagens da sess√£o do lead pelo n√∫mero de telefone."
    },
    {
      "parameters": {
        "jsCode": "// Monta hist√≥rico de mensagens para o agente\nconst dadosMensagem = $('Normaliza dados da mensagem').first().json;\nconst sessaoRedis = $input.first().json;\n\nlet historico = [];\ntry {\n  historico = JSON.parse(sessaoRedis || '[]');\n} catch(e) {\n  historico = [];\n}\n\n// Adiciona mensagem atual do usu√°rio ao hist√≥rico\nhistorico.push({\n  role: 'user',\n  content: dadosMensagem.mensagem || '[Arquivo enviado]'\n});\n\nreturn [{\n  json: {\n    ...dadosMensagem,\n    historico,\n    historicoJson: JSON.stringify(historico)\n  }\n}];"
      },
      "id": "monta-historico",
      "name": "Monta hist√≥rico da conversa",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1120, 300]
    },
    {
      "parameters": {
        "agent": "conversationalAgent",
        "promptType": "define",
        "text": "={{ $json.mensagem }}",
        "options": {
          "systemMessage": "={{ $('Monta hist√≥rico da conversa').first().json.historicoJson }}",
          "maxIterations": 5
        }
      },
      "id": "agente-ia",
      "name": "Agente SDR ‚Äî IA Previdenci√°ria",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [1340, 300],
      "notes": "Configure o system prompt com o conte√∫do de agent-prompt.md. Conecte as tools: Tavily (busca web) e Memory."
    },
    {
      "parameters": {
        "jsCode": "// Verifica se o agente retornou JSON de qualifica√ß√£o\nconst respostaAgente = $input.first().json.output || '';\nconst numero = $('Normaliza dados da mensagem').first().json.numero;\n\nlet dadosQualificacao = null;\nlet qualificado = false;\n\n// Tenta extrair JSON da resposta\ntry {\n  const jsonMatch = respostaAgente.match(/\\{[\\s\\S]*\\}/);\n  if (jsonMatch) {\n    dadosQualificacao = JSON.parse(jsonMatch[0]);\n    qualificado = dadosQualificacao.qualificado === true;\n  }\n} catch(e) {\n  // Resposta normal sem JSON de qualifica√ß√£o\n}\n\n// Extrai apenas o texto da resposta (sem o JSON)\nconst textoResposta = respostaAgente.replace(/```json[\\s\\S]*```/g, '').trim();\n\nreturn [{\n  json: {\n    numero,\n    textoResposta,\n    qualificado,\n    dadosQualificacao,\n    conversaEncerrada: qualificado !== null && dadosQualificacao !== null\n  }\n}];"
      },
      "id": "processa-resposta",
      "name": "Processa resposta do agente",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1560, 300]
    },
    {
      "parameters": {
        "url": "={{ $env.EVOLUTION_API_URL }}/message/sendText/{{ $env.EVOLUTION_INSTANCE }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $env.EVOLUTION_API_KEY }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"number\": \"{{ $json.numero }}\",\n  \"text\": \"{{ $json.textoResposta }}\"\n}",
        "options": {}
      },
      "id": "envia-resposta-lead",
      "name": "Envia resposta ao lead",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1780, 180]
    },
    {
      "parameters": {
        "conditions": {
          "conditions": [
            {
              "id": "cond-qualificado",
              "leftValue": "={{ $json.qualificado }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equal"
              }
            }
          ]
        }
      },
      "id": "switch-qualificado",
      "name": "Lead qualificado?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1780, 420],
      "notes": "Rota true = qualificado, envia relat√≥rio ao advogado. Rota false = apenas salva na sess√£o."
    },
    {
      "parameters": {
        "jsCode": "// Monta relat√≥rio formatado para o advogado\nconst dados = $('Processa resposta do agente').first().json.dadosQualificacao;\n\nconst emojiBeneficio = {\n  'aposentadoria': 'üë¥',\n  'pensao': 'üë•',\n  'auxilio_doenca': 'üè•',\n  'bpc': 'ü§ù',\n  'revisao': 'üîÑ',\n  'outro': 'üìã'\n};\n\nconst emoji = emojiBeneficio[dados.beneficio] || 'üìã';\n\nconst relatorio = `üü¢ *LEAD QUALIFICADO ‚Äî DIREITO PREVIDENCI√ÅRIO*\n\nüë§ *Nome:* ${dados.nome}\nüì± *Celular:* ${dados.celular}\n${emoji} *Benef√≠cio:* ${dados.beneficio?.replace('_', ' ')?.toUpperCase()}\n‚öñÔ∏è *Tese:* ${dados.tese}\nüìÑ *Documentos:* ${(dados.documentos || []).join(', ') || 'N√£o informado'}\nüóíÔ∏è *Hist√≥rico:* ${dados.historico || 'N√£o informado'}\nüïê *Atendimento:* ${new Date().toLocaleString('pt-BR', {timeZone: 'America/Sao_Paulo'})}`;\n\nreturn [{ json: { relatorio } }];"
      },
      "id": "monta-relatorio",
      "name": "Monta relat√≥rio do lead",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2000, 300]
    },
    {
      "parameters": {
        "url": "={{ $env.EVOLUTION_API_URL }}/message/sendText/{{ $env.EVOLUTION_INSTANCE }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $env.EVOLUTION_API_KEY }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"number\": \"{{ $env.NUMERO_ADVOGADO }}\",\n  \"text\": \"{{ $json.relatorio }}\"\n}",
        "options": {}
      },
      "id": "envia-relatorio-advogado",
      "name": "Envia relat√≥rio ao advogado",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2220, 300],
      "notes": "Envia o relat√≥rio completo para o n√∫mero do advogado configurado em NUMERO_ADVOGADO."
    },
    {
      "parameters": {
        "jsCode": "// Salva/atualiza o hist√≥rico da sess√£o no Redis\n// TTL de 24h (86400 segundos)\nconst numero = $('Normaliza dados da mensagem').first().json.numero;\nconst historicoAtual = $('Monta hist√≥rico da conversa').first().json.historico;\nconst respostaAgente = $('Agente SDR ‚Äî IA Previdenci√°ria').first().json.output || '';\n\n// Adiciona resposta do agente ao hist√≥rico\nhistoricoAtual.push({\n  role: 'assistant',\n  content: respostaAgente\n});\n\n// Mant√©m apenas as √∫ltimas 20 mensagens para n√£o crescer demais\nconst historicoTrimmed = historicoAtual.slice(-20);\n\nreturn [{\n  json: {\n    key: `sessao_${numero}`,\n    value: JSON.stringify(historicoTrimmed),\n    ttl: 86400\n  }\n}];"
      },
      "id": "prepara-sessao-redis",
      "name": "Prepara dados para salvar sess√£o",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2000, 500]
    },
    {
      "parameters": {
        "operation": "set",
        "key": "={{ $json.key }}",
        "value": "={{ $json.value }}",
        "expire": true,
        "ttl": "={{ $json.ttl }}",
        "options": {}
      },
      "id": "redis-set-sessao",
      "name": "Redis ‚Äî Salva hist√≥rico da sess√£o",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [2220, 500],
      "notes": "Salva o hist√≥rico com TTL de 24h. Ap√≥s esse per√≠odo a conversa √© zerada."
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {}
      },
      "id": "webhook-response",
      "name": "Responde webhook (200 OK)",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [2440, 300],
      "notes": "Retorna 200 para a Evolution API confirmar recebimento do webhook."
    }
  ],
  "connections": {
    "Webhook ‚Äî Recebe mensagem WhatsApp": {
      "main": [
        [{ "node": "Normaliza dados da mensagem", "type": "main", "index": 0 }]
      ]
    },
    "Normaliza dados da mensagem": {
      "main": [
        [{ "node": "√â arquivo ou texto?", "type": "main", "index": 0 }]
      ]
    },
    "√â arquivo ou texto?": {
      "main": [
        [{ "node": "Baixa arquivo (base64)", "type": "main", "index": 0 }],
        [{ "node": "Redis ‚Äî Busca hist√≥rico da sess√£o", "type": "main", "index": 0 }]
      ]
    },
    "Baixa arquivo (base64)": {
      "main": [
        [{ "node": "Redis ‚Äî Busca hist√≥rico da sess√£o", "type": "main", "index": 0 }]
      ]
    },
    "Redis ‚Äî Busca hist√≥rico da sess√£o": {
      "main": [
        [{ "node": "Monta hist√≥rico da conversa", "type": "main", "index": 0 }]
      ]
    },
    "Monta hist√≥rico da conversa": {
      "main": [
        [{ "node": "Agente SDR ‚Äî IA Previdenci√°ria", "type": "main", "index": 0 }]
      ]
    },
    "Agente SDR ‚Äî IA Previdenci√°ria": {
      "main": [
        [{ "node": "Processa resposta do agente", "type": "main", "index": 0 }]
      ]
    },
    "Processa resposta do agente": {
      "main": [
        [
          { "node": "Envia resposta ao lead", "type": "main", "index": 0 },
          { "node": "Lead qualificado?", "type": "main", "index": 0 },
          { "node": "Prepara dados para salvar sess√£o", "type": "main", "index": 0 }
        ]
      ]
    },
    "Lead qualificado?": {
      "main": [
        [{ "node": "Monta relat√≥rio do lead", "type": "main", "index": 0 }],
        []
      ]
    },
    "Monta relat√≥rio do lead": {
      "main": [
        [{ "node": "Envia relat√≥rio ao advogado", "type": "main", "index": 0 }]
      ]
    },
    "Envia relat√≥rio ao advogado": {
      "main": [
        [{ "node": "Responde webhook (200 OK)", "type": "main", "index": 0 }]
      ]
    },
    "Envia resposta ao lead": {
      "main": [
        [{ "node": "Responde webhook (200 OK)", "type": "main", "index": 0 }]
      ]
    },
    "Prepara dados para salvar sess√£o": {
      "main": [
        [{ "node": "Redis ‚Äî Salva hist√≥rico da sess√£o", "type": "main", "index": 0 }]
      ]
    },
    "Redis ‚Äî Salva hist√≥rico da sess√£o": {
      "main": [
        [{ "node": "Responde webhook (200 OK)", "type": "main", "index": 0 }]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": ""
  },
  "staticData": null,
  "meta": {
    "templateId": "sdr-previdenciario-whatsapp",
    "description": "Agente SDR para qualifica√ß√£o de leads de Direito Previdenci√°rio via WhatsApp",
    "version": "1.0.0"
  },
  "tags": ["whatsapp", "ia", "sdr", "previdenciario", "n8n"],
  "_envVarsRequired": [
    "EVOLUTION_API_URL",
    "EVOLUTION_API_KEY",
    "EVOLUTION_INSTANCE",
    "NUMERO_ADVOGADO",
    "OPENAI_API_KEY",
    "TAVILY_API_KEY"
  ],
  "_setupInstructions": {
    "1_evolution_api": "Configure a Evolution API e crie uma inst√¢ncia. Adicione o endpoint /webhook/whatsapp-webhook como webhook de mensagens.",
    "2_credenciais_n8n": "Configure as credenciais: Evolution API (httpHeaderAuth), OpenAI, Tavily e Redis.",
    "3_agente_ia": "No node 'Agente SDR', cole o conte√∫do de agent-prompt.md no System Message. Adicione as tools: Tavily Search e Buffer Memory (Redis).",
    "4_variaveis_env": "Configure as vari√°veis de ambiente listadas em _envVarsRequired no painel do n8n.",
    "5_numero_advogado": "Defina NUMERO_ADVOGADO com o n√∫mero que receber√° os leads qualificados (formato: 5511999999999)."
  }
}
